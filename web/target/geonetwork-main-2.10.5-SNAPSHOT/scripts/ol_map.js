Ext.namespace("GeoNetwork");var mapInit=false;var activeIndex=0;var printConfigUrl=mapfish.SERVER_BASE_URL+"pdf/info.json";GeoNetwork.app=function(){var r,B,x,F;var t,n,a;var y;var e;var I;var u;var s;var z=function(K,L){var J=K||{projection:"EPSG:4326",units:"degrees",maxExtent:new OpenLayers.Bounds(-180,-90,180,90),restrictedExtent:new OpenLayers.Bounds(-180,-90,180,90),controls:[]};I=new OpenLayers.Map("ol_map",J);u=L};var E=function(L,K,M,J){I.addLayer(new OpenLayers.Layer.WMS(L,K,M,J))};var g=function(J){var K=new OpenLayers.Layer.Image("Dummy","../../scripts/openlayers/img/blank.gif",J,I.getSize(),{isBaseLayer:true,displayInLayerSwitcher:false});I.addLayer(K)};var D=function(){I.addControl(new GeoNetwork.Control.ZoomWheel());I.addControl(new OpenLayers.Control.LoadingPanel())};var m=function(J){if(!J.hasListener("radiochange")){J.on("radiochange",function(K){e=K})}};var q=function(K){if(K.hasChildNodes()){for(var J=0;J<K.childNodes.length;J++){var L=K.childNodes[J];q(L)}}else{m(K)}};var h=function(K){if(K){var J;J=K.attributes.layer;if(J){if(!J.isBaseLayer){if((typeof(J.isLoading)=="undefined")||(J.isLoading==false)){I.removeLayer(J);if(e==K){e=null}j(e);Ext.getCmp("toctree").getSelectionModel().clearSelections()}}}}};var k=function(){var J=Ext.getCmp("toctree").getSelectionModel().getSelectedNode();h(J)};var G=function(K){if(K){var J;J=K.attributes.layer;if(J){GeoNetwork.WindowManager.showWindow("opacity");GeoNetwork.WindowManager.getWindow("opacity").setLayer(J)}}};var C=function(){var J=Ext.getCmp("toctree").getSelectionModel().getSelectedNode();G(J)};var c=function(K){if(K){var J;J=K.attributes.layer;if(J&&J.dimensions&&J.dimensions.time){GeoNetwork.WindowManager.showWindow("wmstime");GeoNetwork.WindowManager.getWindow("wmstime").setLayer(J)}}};var d=function(){var J=Ext.getCmp("toctree").getSelectionModel().getSelectedNode();c(J)};var b=function(K){if(K){var J;J=K.attributes.layer;if((J)&&(J.styles)&&(J.styles.length>1)){GeoNetwork.WindowManager.showWindow("layerstyles");GeoNetwork.WindowManager.getWindow("layerstyles").showLayerStyles(J)}}};var v=function(){var J=Ext.getCmp("toctree").getSelectionModel().getSelectedNode();b(J)};var A=function(K){if(K){var J;J=K.attributes.layer;if(J){GeoNetwork.WindowManager.showWindow("wmsinfo");GeoNetwork.WindowManager.getWindow("wmsinfo").showLayerInfo(J)}}};var l=function(){var J=Ext.getCmp("toctree").getSelectionModel().getSelectedNode();A(J)};var j=function(K){if((K)&&(K.attributes.layer)){if(K.parentNode.attributes.nodeType=="gx_baselayercontainer"){Ext.getCmp("tbRemoveButton").disable();Ext.getCmp("tbOpacityButton").disable()}else{Ext.getCmp("tbRemoveButton").enable();Ext.getCmp("tbOpacityButton").enable()}var J=K.attributes.layer;if(J&&J.dimensions&&J.dimensions.time){Ext.getCmp("tbWmsTimeButton").enable()}else{Ext.getCmp("tbWmsTimeButton").disable()}if((J)&&((!J.styles)||(J.styles.length<2))){Ext.getCmp("tbStylesButton").disable()}else{Ext.getCmp("tbStylesButton").enable()}Ext.getCmp("tbMetadataButton").enable();Ext.getCmp("btnZoomToExtent").enable()}else{Ext.getCmp("tbRemoveButton").disable();Ext.getCmp("tbWmsTimeButton").disable();Ext.getCmp("tbStylesButton").disable();Ext.getCmp("tbOpacityButton").disable();Ext.getCmp("tbMetadataButton").disable();Ext.getCmp("btnZoomToExtent").disable()}};var f=function(){B=[];var L=new GeoExt.Action({handler:function(){GeoNetwork.WindowManager.showWindow("addwms")},iconCls:"addLayer",tooltip:"Add layer"});B.push(L);L=new GeoExt.Action({id:"tbRemoveButton",handler:function(){h(e)},iconCls:"deleteLayer",tooltip:"Remove layer"});B.push(L);B.push("-");L=new GeoExt.Action({id:"tbOpacityButton",handler:function(){G(e)},iconCls:"layerOpacity",tooltip:"Layer opacity"});B.push(L);L=new GeoExt.Action({id:"tbStylesButton",handler:function(){b(e)},iconCls:"layerStyles",tooltip:"Layer styles"});B.push(L);B.push("-");L=new GeoExt.Action({id:"tbMetadataButton",handler:function(){A(e)},iconCls:"wmsInfo",tooltip:"WMS Information"});B.push(L);B.push("-");L=new GeoExt.Action({id:"tbWmsTimeButton",handler:function(){c(e)},iconCls:"wmsTime",tooltip:"WMS Time"});B.push(L);r=[];L=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtent(),map:I,iconCls:"zoomfull",tooltip:{title:OpenLayers.i18n("zoomToMaxExtentTooltipTitle"),text:OpenLayers.i18n("zoomToMaxExtentTooltipText")}});r.push(L);r.push("-");L=new GeoExt.Action({iconCls:"zoomlayer",id:"btnZoomToExtent",tooltip:{title:OpenLayers.i18n("zoomlayerTooltipTitle"),text:OpenLayers.i18n("zoomlayerTooltipText")},handler:function(){var T=e;var R;if(T){R=T.attributes.layer;if(R){if(R.llbbox){var U=I.getProjectionObject();var Q=new OpenLayers.Projection("WGS84");var O=new OpenLayers.LonLat(R.llbbox[0],R.llbbox[1]).transform(Q,U);var P=new OpenLayers.LonLat(R.llbbox[2],R.llbbox[3]).transform(Q,U);var S=new OpenLayers.Bounds();S.left=O.lon;S.right=P.lon;S.top=P.lat;S.bottom=O.lat;I.zoomToExtent(S)}else{I.zoomToMaxExtent()}}else{Ext.MessageBox.alert(OpenLayers.i18n("zoomlayer.selectLayerTitle"),OpenLayers.i18n("zoomlayer.selectLayerText"))}}else{Ext.MessageBox.alert(OpenLayers.i18n("zoomlayer.selectLayerTitle"),OpenLayers.i18n("zoomlayer.selectLayerText"))}}});r.push(L);r.push("-");L=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox(),map:I,toggleGroup:"move",allowDepress:false,iconCls:"zoomin",tooltip:{title:OpenLayers.i18n("zoominTooltipTitle"),text:OpenLayers.i18n("zoominTooltipText")}});r.push(L);L=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox({displayClass:"ZoomOut",out:true}),toggleGroup:"move",allowDepress:false,map:I,iconCls:"zoomout",tooltip:{title:OpenLayers.i18n("zoomoutTooltipTitle"),text:OpenLayers.i18n("zoomoutTooltipText")}});r.push(L);L=new GeoExt.Action({control:new OpenLayers.Control.DragPan({isDefault:true}),toggleGroup:"move",allowDepress:false,pressed:true,map:I,iconCls:"pan",tooltip:{title:OpenLayers.i18n("dragTooltipTitle"),text:OpenLayers.i18n("dragTooltipText")}});r.push(L);r.push("-");y=new OpenLayers.Control.WMSGetFeatureInfo({drillDown:true,infoFormat:"application/vnd.ogc.gml"});var J=function(S){var P=-1;for(var R=0,O=I.layers.length;R<O;R++){var Q=I.layers[R];if(Q!=S){P=Math.max(I.getLayerIndex(I.layers[R]),P)}}if(I.getLayerIndex(S)<P){I.setLayerIndex(S,P+1)}};s=new OpenLayers.Layer.Vector("Feature info",{displayInLayerSwitcher:false,styleMap:new OpenLayers.StyleMap({externalGraphic:OpenLayers.Util.getImagesLocation()+"marker.png",pointRadius:12})});y.events.on({getfeatureinfo:function(P){var Q=I.getLonLatFromViewPortPx(P.xy);var O=new OpenLayers.Geometry.Point(Q.lon,Q.lat);s.destroyFeatures();s.addFeatures(new OpenLayers.Feature.Vector(O));J(s);GeoNetwork.WindowManager.showWindow("featureinfo");GeoNetwork.WindowManager.getWindow("featureinfo").setMap(I);GeoNetwork.WindowManager.getWindow("featureinfo").setFeatures(P.features)},deactivate:function(){s.destroyFeatures()}});L=new GeoExt.Action({control:y,toggleGroup:"move",allowDepress:false,pressed:false,map:I,iconCls:"query",tooltip:{title:OpenLayers.i18n("featureInfoTooltipTitle"),text:OpenLayers.i18n("featureInfoTooltipText")}});r.push(L);r.push("-");ctrl=new OpenLayers.Control.NavigationHistory();I.addControl(ctrl);L=new GeoExt.Action({control:ctrl.previous,disabled:true,iconCls:"back",tooltip:{title:OpenLayers.i18n("previousTooltipTitle"),text:OpenLayers.i18n("previosTooltipText")}});r.push(L);L=new GeoExt.Action({control:ctrl.next,disabled:true,iconCls:"next",tooltip:{title:OpenLayers.i18n("nextTooltipTitle"),text:OpenLayers.i18n("nextTooltipText")}});r.push(L);r.push("-");L=new GeoExt.Action({iconCls:"savewmc",tooltip:{title:OpenLayers.i18n("savewmcTooltipTitle"),text:OpenLayers.i18n("savewmcTooltipText")},handler:function(){GeoNetwork.WMCManager.saveContext(I)}});r.push(L);L=new GeoExt.Action({iconCls:"loadwmc",tooltip:{title:OpenLayers.i18n("loadwmcTooltipTitle"),text:OpenLayers.i18n("loadwmcTooltipText")},handler:function(){GeoNetwork.WindowManager.showWindow("loadwmc")}});r.push(L);r.push("-");var N=new Geonetwork.print.PrintAction({map:I,text:"",tooltip:{title:OpenLayers.i18n("printTooltipTitle"),text:OpenLayers.i18n("printTooltipText")},iconCls:"print",configUrl:printConfigUrl,fillSpec:function(O){Geonetwork.print.PrintAction.prototype.fillSpec.call(this,O);O.spec.rotation=0}});r.push(N);r.push("-");var K=new Ext.SplitButton({iconCls:"icon-measure-length",tooltip:"Measure",enableToggle:true,toggleGroup:"move",allowDepress:false,handler:function(O,P){if(!O.pressed){O.toggle()}else{O.menu.items.itemAt(activeIndex).setChecked(true)}},listeners:{toggle:function(O,P){if(!P){O.menu.items.each(function(Q){Q.setChecked(false)})}},render:function(O){Ext.ButtonToggleMgr.register(O)}},menu:new Ext.menu.Menu({items:[new Ext.menu.CheckItem(new GeoExt.Action({text:"Length",iconCls:"icon-measure-length",toggleGroup:"measure",group:"move",allowDepress:false,map:I,control:i(OpenLayers.Handler.Path,"Length")})),new Ext.menu.CheckItem(new GeoExt.Action({text:"Area",iconCls:"icon-measure-area",toggleGroup:"measure",group:"move",allowDepress:false,map:I,control:i(OpenLayers.Handler.Polygon,"Area")}))]})});K.menu.items.each(function(P,O){P.on({checkchange:function(R,Q){K.toggle(Q);if(Q){activeIndex=O;K.setIconClass(R.iconCls)}}})});r.push(K);r.push("->");var M=new Ext.Panel({layout:"fit",border:false,cls:"projchooser",items:[{xtype:"gn_projectionselector",projections:GeoNetwork.ProjectionList,fieldLabel:OpenLayers.i18n("projectionTitle"),map:I}]});r.push(M)};var w=function(){var L=new Ext.Panel({cls:"olControlScaleLine overlay-element overlay-scaleline",border:false});L.on("render",function(){var T=new OpenLayers.Control.ScaleLine({div:L.body.dom});I.addControl(T);T.activate()},this);var J;if(u.length>0){var Q=[];var R=u;var O=I.baseLayer.units;for(var N=R.length-1;N>=0;N--){var K=R[N];Q.push({level:N,resolution:OpenLayers.Util.getResolutionFromScale(K,O),scale:K})}J=new GeoExt.data.ScaleStore({});J.loadData(Q)}else{J=new GeoExt.data.ScaleStore({map:I})}var S=new Ext.form.ComboBox({emptyText:"Zoom level",tpl:'<tpl for="."><div class="x-combo-list-item">1 : {[parseInt(values.scale)]}</div></tpl>',editable:false,triggerAction:"all",mode:"local",store:J,width:110});S.on("click",function(T){T.stopEvent()});S.on("mousedown",function(T){T.stopEvent()});S.on("select",function(V,T,U){I.zoomTo(T.data.level)},this);var M=new Ext.Panel({items:[S],cls:"overlay-element overlay-scalechooser",border:false});I.events.register("zoomend",this,function(){var T=J.queryBy(function(U){return I.getZoom()==U.data.level});if(T.length>0){T=T.items[0];S.setValue("1 : "+parseInt(T.data.scale,10))}else{if(!S.rendered){return}S.clearValue()}});var P=new Ext.Panel({cls:"map-overlay",items:[L,M]});P.on("afterlayout",function(){L.body.dom.style.position="relative";L.body.dom.style.display="inline";P.getEl().on("click",function(T){T.stopEvent()});P.getEl().on("mousedown",function(T){T.stopEvent()})},this);return P};var i=function(L,P){var N=new OpenLayers.StyleMap({"default":new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:{pointRadius:4,graphicName:"square",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",fillColor:"white",fillOpacity:0.3}}})]})});var K=function(){if(J){J.destroy()}};var M=function(S){var T=S.measure;var Q=S.units;O.displaySystem="english";var V=S.geometry.CLASS_NAME.indexOf("LineString")>-1?O.getBestLength(S.geometry):O.getBestArea(S.geometry);var R=V[0];var U=V[1];O.displaySystem="metric";var W=S.order==2?"<sup>2</sup>":"";return T.toFixed(2)+" "+Q+W+"<br>"+R.toFixed(2)+" "+U+W};var J;var O=new OpenLayers.Control.Measure(L,{persist:true,handlerOptions:{layerOptions:{styleMap:N}},eventListeners:{measurepartial:function(R){K();J=new Ext.ToolTip({html:M(R),title:P,autoHide:false,closable:true,draggable:false,mouseOffset:[0,0],showDelay:1,listeners:{hide:K}});if(R.measure>0){var Q=O.handler.lastUp;var S=Ext.getCmp("mappanel").getPosition();J.targetXY=[S[0]+Q.x,S[1]+Q.y];J.show()}},measure:function(Q){K();J=new Ext.ToolTip({target:Ext.getBody(),html:M(Q),title:P,autoHide:false,closable:true,draggable:false,mouseOffset:[0,0],showDelay:1,listeners:{hide:function(){O.cancel();K()}}})},deactivate:K,scope:this}});return O};var H=function(){var J=new OpenLayers.Format.JSON().write([{nodeType:"gx_baselayercontainer"},{nodeType:"gx_overlaylayercontainer",expanded:true,loader:{baseAttrs:{radioGroup:"foo"}}}],true);t=new Ext.tree.TreePanel({title:"Layer tree",id:"toctree",enableDD:true,loader:new Ext.tree.TreeLoader({applyLoader:false}),root:{nodeType:"async",children:Ext.decode(J)},listeners:{contextmenu:function(L,M){if((L.attributes.nodeType!="gx_overlaylayercontainer")&&(L.attributes.nodeType!="gx_baselayercontainer")){L.select();var N=L.getOwnerTree().contextMenu;if(L.parentNode.attributes.nodeType=="gx_baselayercontainer"){N.items.get("removeMenu").disable();N.items.get("opacityMenu").disable()}else{N.items.get("removeMenu").enable();N.items.get("opacityMenu").enable()}N.items.get("addMenu").hide();var K=L.attributes.layer;if(K&&K.dimensions&&K.dimensions.time){N.items.get("wmsTimeMenu").enable()}else{N.items.get("wmsTimeMenu").disable()}if((K)&&((!K.styles)||(K.styles.length<2))){N.items.get("stylesMenu").disable()}else{N.items.get("stylesMenu").enable()}N.contextNode=L;N.showAt(M.getXY())}else{if(L.attributes.nodeType=="gx_overlaylayercontainer"){L.select();var N=L.getOwnerTree().contextMenu;N.items.get("addMenu").show();N.items.get("removeMenu").hide();N.items.get("opacityMenu").hide();N.items.get("wmsTimeMenu").hide();N.items.get("stylesMenu").hide();N.items.get("metadataMenu").hide();N.contextNode=L;N.showAt(M.getXY())}}},scope:this},contextMenu:new Ext.menu.Menu({items:[{text:"Add layer",id:"addMenu",handler:function(){GeoNetwork.WindowManager.showWindow("addwms")}},{text:OpenLayers.i18n("removeButtonText"),id:"removeMenu",handler:k},{text:"WMS information",id:"metadataMenu",handler:l},{text:OpenLayers.i18n("opacityButtonText"),id:"opacityMenu",handler:C},{text:"Styles",id:"stylesMenu",handler:v},{text:OpenLayers.i18n("WMSTimeWindowTitle"),id:"wmsTimeMenu",disabled:true,handler:d}]}),tbar:B,rootVisible:false,lines:false,border:false,region:"center"})};var p=function(){n=new GeoExt.LegendPanel({defaults:{labelCls:"mylabel",style:"padding:5px"},title:"Legend",height:200,autoScroll:true,split:true,collapsible:true,collapsed:true,border:false,region:"south"})};var o=function(){f();H();p();var L=w();var J=new Ext.Panel({region:"center",border:false,layout:"accordion",deferredRender:false,items:[t,{xtype:"print-simple",title:OpenLayers.i18n("mf.print.print"),bodyStyle:"padding: 7px;",formConfig:{labelWidth:65,defaults:{width:100,listWidth:100}},border:false,map:I,configUrl:printConfigUrl}]});var M=new GeoExt.MapPanel({id:"mappanel",border:false,map:I,height:150,width:210,zoom:2,tbar:r,items:[L]});F=new Ext.Panel({layout:"border",border:false,renderTo:"map_container",items:[{region:"west",xtype:"panel",collapsible:true,collapseMode:"mini",split:true,border:false,width:200,minSize:200,maxSize:300,layout:"border",items:[J,n]},{region:"center",layout:"fit",frame:false,border:false,margins:"0 0 0 0",items:[M]}]});Ext.getCmp("toctree").on({insert:m,append:m,click:function(N){if(N.ui.radio){N.ui.radio.checked=true;N.ui.fireEvent("radiochange",N)}j(N)},scope:this});var K=Ext.getCmp("toctree").getRootNode();q(K);Ext.getCmp("toctree").on("nodedragover",function(N){if((N.dropNode.parentNode.attributes.nodeType=="gx_baselayercontainer")||(N.target.attributes.nodeType=="gx_baselayercontainer")||(N.target.parentNode.attributes.nodeType=="gx_baselayercontainer")||(N.target.parentNode==N.tree.root)){N.cancel=true}});j(e)};return{init:function(N,L,J){Ext.QuickTips.init();z(L,J);for(var M=0;M<N.length;M++){E(N[M][0],N[M][1],N[M][2],N[M][3])}o();D();GeoNetwork.WindowManager.registerWindow("loadwmc",GeoNetwork.LoadWmcWindow,{map:I,id:"loadwmc"});GeoNetwork.WindowManager.registerWindow("addwms",GeoNetwork.AddWmsLayerWindow,{map:I,id:"addwms"});GeoNetwork.WindowManager.registerWindow("featureinfo",GeoNetwork.FeatureInfoWindow,{map:I,id:"featureinfo",control:y});GeoNetwork.WindowManager.registerWindow("opacity",GeoNetwork.OpacityWindow,{map:I,id:"opacity",selMode:Ext.getCmp("toctree").getSelectionModel()});GeoNetwork.WindowManager.registerWindow("layerstyles",GeoNetwork.LayerStylesWindow,{map:I,id:"layerstyles"});GeoNetwork.WindowManager.registerWindow("wmstime",GeoNetwork.WMSTimeWindow,{map:I,id:"wmstime"});GeoNetwork.WindowManager.registerWindow("wmsinfo",GeoNetwork.WmsLayerMetadataWindow,{map:I,id:"wmsinfo"});Ext.getCmp("toctree").on({insert:m,append:m,click:function(O){if(O.ui.radio){O.ui.radio.checked=true;O.ui.fireEvent("radiochange",O)}j(O)},scope:this});var K=Ext.getCmp("toctree").getRootNode();q(K);j(e);Ext.getCmp("toctree").on("nodedragover",function(O){if((O.dropNode.parentNode.attributes.nodeType=="gx_baselayercontainer")||(O.target.attributes.nodeType=="gx_baselayercontainer")||(O.target.parentNode.attributes.nodeType=="gx_baselayercontainer")||(O.target.parentNode==O.tree.root)){O.cancel=true}});I.events.register("moveend",I,function(O){GeoNetwork.MapStateManager.stoteMapExtextState(I)});I.events.register("addlayer",I,function(O){GeoNetwork.MapStateManager.storeMapLayersState(I)});I.events.register("removelayer",I,function(O){GeoNetwork.MapStateManager.storeMapLayersState(I)});I.events.register("changelayer",I,function(O){GeoNetwork.MapStateManager.storeMapLayersState(I)});I.addLayer(s)},addWMSLayer:function(J){GeoNetwork.CatalogueInterface.addLayers(J)},addWMSServerLayers:function(K){GeoNetwork.WindowManager.showWindow("addwms");var J=GeoNetwork.WindowManager.getWindow("addwms");J.setUrl(K)},getViewport:function(){return F},refreshViewport:function(){Ext.get("west_panel").setWidth(westPanelWidth);F.doLayout()},getMap:function(){return I}}};GeoNetwork.defaultLocale="en";GeoNetwork.ProjectionList=[];GeoNetwork.WMSList=[];GeoNetwork.mapViewer=new GeoNetwork.app();Ext.onReady(function(){Ext.layout.BorderLayout.Region.prototype.getCollapsedEl=Ext.layout.BorderLayout.Region.prototype.getCollapsedEl.createSequence(function(){if((this.position=="north"||this.position=="south")&&!this.collapsedEl.titleEl){this.collapsedEl.titleEl=this.collapsedEl.createChild({cls:"x-collapsed-title",cn:this.panel.title})}})});