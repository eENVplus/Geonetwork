var CSWSearchTools={cswMethod:"POST",resultsMode:"results",doCSWQueryFromForm:function(g,b,f,e,c,h){var d=CSWSearchTools.buildCSWQueryFromForm(CSWSearchTools.cswMethod,Ext.getCmp(g),f,app.sortBy,h);if(CSWSearchTools.cswMethod=="POST"){var a=CSWSearchTools.buildCSWQueryFromForm("GET",Ext.getCmp(g),f,app.sortBy,h);OpenLayers.Request.POST({url:b,data:d,success:function(i){e(i,a)},failure:c})}else{OpenLayers.Request.GET({url:b,params:d,success:function(i){e(i,d)},failure:c})}},buildCSWQueryFromForm:function(h,e,b,g,f){var a=CSWSearchTools.getFormValues(e);var d=[];CSWSearchTools.addFiltersFromPropertyMap(a,d);f(a,d);if(d.length==0){d.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE,property:"anyText",value:".*"}))}var c=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:d});if(h=="POST"){return CSWSearchTools.buildCSWQueryPOST(c,b,g)}else{return CSWSearchTools.buildCSWQueryGET(c,b,g)}},addFiltersFromPropertyMap:function(b,e){var a=".8";var c=b.E_similarity;if(c!=null){a=b.E_similarity;CSWSearchTools.addFilter(e,"E_similarity",a,a)}for(var d in b){var f=b[d];if(f!=""&&d!="E_similarity"){CSWSearchTools.addFilter(e,d,f,a)}}},addFilter:function(e,d,f,a){var h=d.match("^(\\[?)([^_]+)_(.*)$");if(h){if(h[1]=="["){var g=[];var b=f.split(",");for(var c=0;c<b.length;++c){CSWSearchTools.addFilterImpl(b.length>1?g:e,h[2],h[3],b[c],a)}if(b.length>1){e.push(new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR,filters:g}))}}else{CSWSearchTools.addFilterImpl(e,h[2],h[3],f,a)}}},addFilterImpl:function(e,d,b,f,a){if(d=="S"){e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE,property:b,value:f+".*"}))}else{if(d=="C"){e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE,property:b,value:".*"+f+".*"}))}else{if(d.charAt(0)=="E"){if(d.length>1){e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"similarity",value:d.substring(1)}))}e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:b,value:f}));if(d.length>1){e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"similarity",value:a}))}}else{if(d==">="){e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,property:b,value:f}))}else{if(d=="<="){e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,property:b,value:f}))}else{if(d=="T"){var h=f.split(" ");for(var c=0;c<h.length;++c){e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:b,value:h[c]}))}}else{if(d=="B"){e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:b,value:f?1:0}))}else{if(d=="V"){var g=f.match("^([^/]+)/(.*)$");e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"similarity",value:"1.0"}));e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:g[1],value:g[2]}));e.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"similarity",value:a}))}else{alert("Cannot parse "+d)}}}}}}}}},sortByMappings:{relevance:{name:"relevance",order:"D"},rating:{name:"rating",order:"D"},popularity:{name:"popularity",order:"D"},date:{name:"date",order:"D"},title:{name:"title",order:"A"}},buildCSWQueryPOST:function(d,b,f){var a='<?xml version="1.0" encoding="UTF-8"?>\n<csw:GetRecords xmlns:csw="http://www.opengis.net/cat/csw/2.0.2" service="CSW" version="2.0.2" resultType="'+this.resultsMode+'" startPosition="'+b+'" maxRecords="'+app.nbResultPerPage+'">\n  <csw:Query typeNames="csw:Record">\n    <csw:ElementSetName>full</csw:ElementSetName>\n';if(f){var e=CSWSearchTools.sortByMappings[f];a+='    <ogc:SortBy xmlns:ogc="http://www.opengis.net/ogc">\n      <ogc:SortProperty>\n        <ogc:PropertyName>'+e.name+"</ogc:PropertyName>\n        <ogc:SortOrder>"+e.order+"</ogc:SortOrder>\n      </ogc:SortProperty>\n    </ogc:SortBy>\n"}if(d){var c=new OpenLayers.Format.XML().write(new OpenLayers.Format.Filter().write(d));c=c.replace(/^<\?xml[^?]*\?>/,"");a+='    <csw:Constraint version="1.0.0">\n';a+=c;a+="    </csw:Constraint>\n"}a+="  </csw:Query>\n</csw:GetRecords>";return a},buildCSWQueryGET:function(d,b,f){var a={request:"GetRecords",service:"CSW",version:"2.0.2",resultType:this.resultsMode,namespace:"csw:http://www.opengis.net/cat/csw/2.0.2",typeNames:"csw:Record",constraintLanguage:"FILTER",constraint_language_version:"1.1.0",elementSetName:"full",startPosition:b,maxRecords:app.nbResultPerPage};if(f){var e=CSWSearchTools.sortByMappings[f];a.sortBy=e.name+":"+e.order}if(d){var c=new OpenLayers.Format.XML().write(new OpenLayers.Format.Filter().write(d));c=c.replace(/^<\?xml[^?]*\?>/,"");a.constraint=c}return a},getFormValues:function(b){var a=b.getForm().getValues()||{};b.cascade(function(d){if(d.disabled!=true){if(d.isXType("boxselect")){if(d.getValue&&d.getValue()){a[d.getName()]=d.getValue()}}else{if(d.isXType("combo")){if(d.getValue&&d.getValue()){a[d.getName()]=d.getValue()}}else{if(d.isXType("fieldset")){if(d.checkbox){a[d.checkboxName]=!d.collapsed}}else{if(d.isXType("radiogroup")){var c=d.items.get(0);a[c.getName()]=c.getGroupValue()}else{if(d.isXType("checkbox")){a[d.getName()]=d.getValue()}else{if(d.isXType("datefield")){if(d.getValue()!=""){a[d.getName()]=d.getValue().format("Y-m-d")+(d.postfix?d.postfix:"")}}else{if(d.getName){if(d.getValue&&d.getValue()!=""){a[d.getName()]=d.getValue()}}}}}}}}}return true});return a}};