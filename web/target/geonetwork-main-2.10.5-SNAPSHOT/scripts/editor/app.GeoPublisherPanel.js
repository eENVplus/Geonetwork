Ext.namespace("GeoNetwork");GeoNetwork.GeoPublisherPanel=Ext.extend(Ext.FormPanel,{border:false,itemSelector:null,geoserverStore:undefined,loadingMask:null,metadataId:null,fileName:null,layerName:null,accessStatus:null,nodeId:null,geoPublicationMap:null,geoPublicationMapPanel:null,geoPublicationTb:null,layers:null,extent:null,stylerBt:null,publishBt:null,unpublishBt:null,checkBt:null,addOnLineSourceBt:null,enableStyler:false,statusBar:null,layerPreviewName:"DatasetPreview",initComponent:function(){var b=Ext.data.Record.create([{name:"id"},{name:"name"},{name:"adminUrl"},{name:"wmsUrl"},{name:"wfsUrl"},{name:"stylerUrl"},{name:"namespacePrefix"}]);this.geoserverStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"geoserver.publisher?action=LIST",method:"GET"}),baseParams:{action:"LIST"},reader:new Ext.data.XmlReader({record:"node",id:"id"},b),sortInfo:{field:"name"}});this.publishBt=new Ext.Button({text:translate("publish"),tooltip:translate("publishTooltip"),iconCls:"addVector",handler:function(){this.statusBar.setText("");this.loadingMask.show();Ext.Ajax.request({url:"geoserver.publisher",params:{metadataId:this.metadataId,nodeId:this.nodeId,file:this.fileName,access:this.accessStatus,action:"CREATE"},method:"GET",success:function(c,e){if(c.responseText.indexOf("OutOfMemoryError")!=-1){this.statusBar.setText(translate("publishError")+translate("publishErrorCode")+" OutOfMemoryError.");this.loadingMask.hide();return}var d=c.responseXML.getElementsByTagName("Exception").item(0);if(d!=null){this.statusBar.setText(translate("publishError")+translate("publishErrorCode")+d.getAttribute("status"));this.loadingMask.hide();return}this.statusBar.setText(translate("publishSuccess"));this.updatePrivileges(1);this.addLayer(this.layerPreviewName,this.layerName);this.statusBar.setText(this.statusBar.text+translate("publishLayerAdded"));this.loadingMask.hide()},failure:function(c,d){this.statusBar.setText(translate("publishError"));this.loadingMask.hide()},scope:this})},scope:this});this.unpublishBt=new Ext.Button({text:translate("unpublish"),tooltip:translate("unpublishTooltip"),iconCls:"delVector",handler:function(){this.statusBar.setText("");this.cleanLayerPreview();Ext.Ajax.request({url:"geoserver.publisher",params:{metadataId:this.metadataId,nodeId:this.nodeId,file:this.fileName,access:this.accessStatus,action:"DELETE"},method:"GET",success:function(c,d){this.statusBar.setText(translate("unpublishSuccess"));this.updatePrivileges(0)},failure:function(c,d){this.statusBar.setText(translate("unpublishError"))},scope:this})},scope:this});this.checkBt=new Ext.Button({text:translate("check"),iconCls:"connect",listeners:{click:function(){this.statusBar.setText("");Ext.Ajax.request({url:"geoserver.publisher",params:{metadataId:this.metadataId,nodeId:this.nodeId,file:this.fileName,access:this.accessStatus,action:"GET"},method:"GET",success:function(c,f){var e=c.responseXML.getElementsByTagName("Exception").item(0);if(e!=null){var d=e.getAttribute("status");this.statusBar.setText(translate("errorDatasetNotFound")+d);if(d.indexOf("No vector layer")!=-1||d.indexOf("404")!=-1){this.updatePrivileges(0)}else{this.updatePrivileges()}return}this.statusBar.setText(translate("datasetFound"));this.updatePrivileges(1);this.addLayer(this.layerPreviewName,this.layerName)},failure:function(c,d){this.statusBar.setText(translate("checkFailure"));this.updatePrivileges()},scope:this})},scope:this}});this.addOnLineSourceBt=new Ext.Button({text:translate("addOnlineSource"),iconCls:"processMetadata",tooltip:"",handler:function(){var c=this.geoserverStore.getById(this.nodeId);this.fireEvent("addOnLineSource",this,c.get("wmsUrl"),c.get("namespacePrefix")+":"+this.layerName,"")},scope:this});this.stylerBt=new Ext.Button({text:translate("Style"),iconCls:"styler",id:"stylerBt",tooltip:"",handler:function(){var d=this.geoserverStore.getById(this.nodeId);var c=d.get("stylerUrl")+"?namespace="+d.get("namespacePrefix")+"&layer="+d.get("namespacePrefix")+":"+this.layerName;window.open(c,"","toolbar=no,menubar=no,width=600,height=500")},scope:this});this.geoPublicationTb=new Ext.Toolbar({items:[this.getGeoserverCombo(),this.checkBt,this.publishBt,this.unpublishBt,this.addOnLineSourceBt,this.stylerBt]});this.statusBar=new Ext.form.Label({id:"statusBar",html:translate("statusInformation")});var a=new Ext.Toolbar({items:[this.statusBar]});this.geoserverStore.load({add:false});this.tbar=this.geoPublicationTb;this.bbar=a;this.items=this.getGeoPublicationMapPanel();this.addEvents("addOnLineSource");GeoNetwork.GeoPublisherPanel.superclass.initComponent.call(this);this.on("resize",function(e,c,d){e.geoPublicationMapPanel.setSize(c,d)});if(!this.loadingMask){this.loadingMask=new Ext.LoadMask(Ext.getBody(),{msg:translate("publishing")})}},getGeoPublicationMapPanel:function(){var d=new OpenLayers.Map();var c=[];for(var b=0;b<backgroundLayers.length;b++){var a=new OpenLayers.Layer.WMS(backgroundLayers[b][0],backgroundLayers[b][1],backgroundLayers[b][2],backgroundLayers[b][3]);d.addLayer(a)}return this.geoPublicationMapPanel=new GeoExt.MapPanel({id:"mapPanel",extent:this.extent,map:d,width:this.width,height:this.height})},addLayer:function(d,a){var c=Ext.getCmp("mapPanel").map;this.cleanLayerPreview();var b=new OpenLayers.Layer.WMS(d,this.geoserverStore.getById(this.nodeId).get("wmsUrl"),{transparent:"true",layers:a});c.addLayer(b)},cleanLayerPreview:function(){var b=Ext.getCmp("mapPanel").map;var a=b.getLayersByName(this.layerPreviewName);if(a.length>0){a[0].destroy()}},getGeoserverCombo:function(){return{xtype:"combo",tpl:'<tpl for="."><div ext:qtip="{name}. {adminUrl}" class="x-combo-list-item">{name}</div></tpl>',store:this.geoserverStore,displayField:"name",autoSelect:true,forceSelection:true,mode:"local",triggerAction:"all",emptyText:translate("selectANode"),id:"geoserverNode",listeners:{select:function(c,a,b){this.nodeId=a.get("id");this.cleanLayerPreview();this.enableStyler=(a.get("stylerUrl")==""?false:true);this.checkBt.fireEvent("click")},scope:this}}},setRef:function(c,b,a){this.metadataId=c;this.fileName=b;if(this.fileName.indexOf("jdbc")!=-1){this.layerName=this.fileName.substr(this.fileName.indexOf("#")+1,this.fileName.length)}else{this.layerName=this.fileName.substr(0,this.fileName.indexOf("."))}this.accessStatus=a;this.cleanLayerPreview();this.updatePrivileges();if(this.nodeId!=null){this.checkBt.fireEvent("click")}},updatePrivileges:function(a){if(this.nodeId==null){this.checkBt.disable()}else{this.checkBt.enable()}this.publishBt.disable();this.unpublishBt.disable();this.addOnLineSourceBt.disable();this.stylerBt.disable();switch(a){case 0:this.publishBt.enable();break;case 1:this.publishBt.enable();this.unpublishBt.enable();this.addOnLineSourceBt.enable();if(this.fileName.indexOf("tif")!=-1||!this.enableStyler){this.stylerBt.disable()}else{this.stylerBt.enable()}break}}});Ext.reg("gn_geopublihserpanel",GeoNetwork.GeoPublisherPanel);