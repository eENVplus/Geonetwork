Ext.namespace("app");app.keyword={};var Keyword=Ext.data.Record.create([{name:"value"},{name:"thesaurus",mapping:"thesaurus/key"},{name:"uri"}]);app.keyword.keywordStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"xml.search.keywords",method:"GET"}),baseParams:{pNewSearch:true,pTypeSearch:1,pThesauri:"",pMode:"searchBox"},reader:new Ext.data.XmlReader({record:"keyword",id:"uri"},Keyword),fields:["value","thesaurus","uri"],sortInfo:{field:"thesaurus"}});app.KeywordSelectionPanel=Ext.extend(Ext.FormPanel,{border:false,itemSelector:null,loadingMask:null,ThesaurusCount:null,ref:null,keywordsSelected:[],initComponent:function(){this.items=[{xtype:"panel",layout:"fit",bodyStyle:"padding: 5px;",border:false,tbar:[this.getThesaurusCombo()," ",this.getKeyword(),"->",translate("maxResults")+" "+translate("perThesaurus"),this.getLimitInput()],items:[this.getKeywordsItemSelector()]}];app.keyword.keywordStore.on({loadexception:function(){},beforeload:function(a,b){if(Ext.getCmp("maxResults")){a.baseParams.maxResults=Ext.getCmp("maxResults").getValue()}if(!this.loadingMask){this.loadingMask=new Ext.LoadMask(this.itemSelector.fromMultiselect.getEl(),{msg:translate("searching")})}this.loadingMask.show()},load:function(){this.loadingMask.hide()},scope:this});this.addEvents("keywordselected");this.bbar=["->",{id:"keywordSearchValidateButton",iconCls:"addIcon",disabled:true,text:translate("add"),handler:function(){this.buildKeywordXmlList()},scope:this}];app.KeywordSelectionPanel.superclass.initComponent.call(this)},getKeyword:function(){return new Ext.app.SearchField({id:"keywordSearchField",width:240,store:app.keyword.keywordStore,paramName:"pKeyword"})},setRef:function(a){this.ref=a},getLimitInput:function(){return{xtype:"textfield",name:"maxResults",id:"maxResults",value:50,width:40}},getThesaurusCombo:function(){var b=Ext.data.Record.create([{name:"title"},{name:"value",mapping:"key"}]);app.keyword.thesaurusStore=new Ext.data.Store({url:"xml.thesaurus.getList",reader:new Ext.data.XmlReader({record:"thesaurus"},b),fields:["title","id"]});var a=new b({filename:translate("anyThesaurus")});a.set("value","");app.keyword.thesaurusStore.add(a);app.keyword.thesaurusStore.load({add:true});return{xtype:"combo",width:150,id:"search-thesauri",value:0,store:app.keyword.thesaurusStore,triggerAction:"all",mode:"local",displayField:"title",valueField:"value",listWidth:250,listeners:{select:function(f,c,d){app.keyword.keywordStore.removeAll();app.keyword.keywordStore.baseParams.pThesauri=f.getValue();var e=Ext.getCmp("keywordSearchField").getValue();if(e.length<1){app.keyword.keywordStore.baseParams.pKeyword="*"}else{app.keyword.keywordStore.baseParams.pKeyword=e}app.keyword.keywordStore.reload()},clear:function(c){app.keyword.keywordStore.load()},scope:this}}},getKeywordsItemSelector:function(){var a='<tpl for="."><div class="ux-mselect-item';if(Ext.isIE||Ext.isIE7){a+='" unselectable=on'}else{a+=' x-unselectable"'}a+='>{id} {value} <span class="ux-mselect-item-thesaurus">({thesaurus})</span></div></tpl>';this.itemSelector=new Ext.ux.ItemSelector({name:"itemselector",fieldLabel:"ItemSelector",dataFields:["value","thesaurus"],toData:[],msWidth:320,msHeight:230,valueField:"value",fromTpl:a,toTpl:a,toLegend:translate("selectedKeywords"),fromLegend:translate("foundKeywords"),fromStore:app.keyword.keywordStore,fromAllowTrash:false,fromAllowDup:true,toAllowDup:false,drawUpIcon:false,drawDownIcon:false,drawTopIcon:false,drawBotIcon:false,imagePath:javascriptsLocation+"ext-ux/MultiselectItemSelector-3.0/icons",toTBar:[{text:translate("clear"),handler:function(){var b=this.getForm().findField("itemselector");b.reset.call(b)},scope:this}]});this.itemSelector.on({change:function(b){Ext.getCmp("keywordSearchValidateButton").setDisabled(b.toStore.getCount()<1)}});return this.itemSelector},buildKeywordXmlList:function(){this.keywordsSelected=[];var c=this;this.ThesaurusCount=0;var a=[];var b=this.itemSelector.toMultiselect.store;a=b.collect("thesaurus");Ext.each(a,function(h,g,i){b.filter("thesaurus",h);var f=b.collect("uri");Ext.each(f,function(l,k){f[k]=l.replace("#","%23")});var j="xml.keyword.get";var e=(f.length>1)?true:false;var d=j+"?thesaurus="+h+"&id="+f.join(",")+"&multiple="+e;++c.ThesaurusCount;c.retrieveKeywordData(d)});b.clearFilter()},retrieveKeywordData:function(a){Ext.getCmp("keywordSearchValidateButton").disable();Ext.Ajax.request({url:a,method:"GET",scope:this,success:function(c){var b=c.responseText;if(b.indexOf("<gmd:MD_Keywords")!==-1){this.keywordsSelected.push("<gmd:descriptiveKeywords xmlns:gmd='http://www.isotc211.org/2005/gmd'>"+c.responseText+"</gmd:descriptiveKeywords>")}Ext.getCmp("keywordSearchValidateButton").enable();this.ThesaurusCount-=1;if(this.ThesaurusCount==0){this.fireEvent("keywordselected",this,this.keywordsSelected);this.ownerCt.hide()}}})}});