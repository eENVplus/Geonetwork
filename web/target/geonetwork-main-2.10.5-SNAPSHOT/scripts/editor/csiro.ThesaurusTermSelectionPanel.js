Ext.namespace("csiro");csiro.keyword={};csiro.Thesaurus=Ext.data.Record.create([{name:"title"},{name:"value",mapping:"key"}]);var Keyword=Ext.data.Record.create([{name:"value"},{name:"thesaurus",mapping:"thesaurus/key"},{name:"uri"}]);csiro.keyword.keywordStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"xml.search.keywords",method:"GET"}),baseParams:{pNewSearch:true,pTypeSearch:1,pThesauri:"",pMode:"searchBox"},reader:new Ext.data.XmlReader({record:"keyword",id:"uri"},Keyword),fields:["value","thesaurus","uri"],sortInfo:{field:"thesaurus"}});csiro.ThesaurusTermSelectionPanel=Ext.extend(Ext.FormPanel,{border:false,itemSelector:null,loadingMask:null,ThesaurusCount:null,minSelected:0,maxSelected:Number.MAX_VALUE,filterThesaurus:null,keywordsSelected:[],initComponent:function(){this.items=[{xtype:"panel",layout:"fit",bodyStyle:"padding: 5px;",border:false,tbar:[this.getThesaurusCombo()," ",this.getKeyword(),"->",translate("maxResults")+" "+translate("perThesaurus"),this.getLimitInput()],items:[this.getKeywordsItemSelector()]}];csiro.keyword.keywordStore.on({loadexception:function(){},beforeload:function(a,b){if(Ext.getCmp("maxResults")){a.baseParams.maxResults=Ext.getCmp("maxResults").getValue()}if(!this.loadingMask){this.loadingMask=new Ext.LoadMask(this.itemSelector.getEl(),{msg:translate("searching")})}this.loadingMask.show()},load:function(){if(!this.loadingMask){this.loadingMask=new Ext.LoadMask(this.itemSelector.getEl(),{msg:translate("searching")})}this.loadingMask.hide()},scope:this});this.addEvents("keywordselected");this.bbar=["->",{id:"keywordSearchValidateButton",iconCls:"addIcon",disabled:true,text:translate("add"),handler:function(){this.buildTermLists()},scope:this}];csiro.ThesaurusTermSelectionPanel.superclass.initComponent.call(this)},getKeyword:function(){return new Ext.app.SearchField({id:"keywordSearchField",width:240,store:csiro.keyword.keywordStore,paramName:"pKeyword"})},getLimitInput:function(){return{xtype:"textfield",name:"maxResults",id:"maxResults",value:50,width:40}},getThesaurusCombo:function(){csiro.keyword.thesaurusStore=new Ext.data.Store({url:"xml.thesaurus.getList",reader:new Ext.data.XmlReader({record:"thesaurus"},csiro.Thesaurus),fields:["title","id"],autoLoad:false});var a=new csiro.Thesaurus({filename:translate("anyThesaurus")});a.set("value","");csiro.keyword.thesaurusStore.add(a);var b=new Ext.form.ComboBox({width:150,id:"search-thesauri",value:0,store:csiro.keyword.thesaurusStore,triggerAction:"all",mode:"local",displayField:"title",valueField:"value",listWidth:250,listeners:{select:function(f,c,d){csiro.keyword.keywordStore.removeAll();csiro.keyword.keywordStore.baseParams.pThesauri=f.getValue();var e="";if(Ext.getCmp("keywordSearchField")){e=Ext.getCmp("keywordSearchField").getValue()}if(e==null||e.length<1){csiro.keyword.keywordStore.baseParams.pKeyword="*"}else{csiro.keyword.keywordStore.baseParams.pKeyword=e}csiro.keyword.keywordStore.reload()},clear:function(c){csiro.keyword.keywordStore.load()},scope:this}});csiro.keyword.thesaurusStore.on({load:function(){if(this.filterThesaurus!=null){var c=csiro.keyword.thesaurusStore.find("value",this.filterThesaurus,0,false,true);if(c!=-1){b.setValue(this.filterThesaurus);b.fireEvent("select",b,csiro.keyword.thesaurusStore.getAt(c),c)}}},scope:this});csiro.keyword.thesaurusStore.load({add:true});return b},getKeywordsItemSelector:function(){var a='<tpl for="."><div class="ux-mselect-item';if(Ext.isIE||Ext.isIE7){a+='" unselectable=on'}else{a+=' x-unselectable"'}a+='>{id} {value} <span class="ux-mselect-item-thesaurus">({thesaurus})</span></div></tpl>';this.itemSelector=new Ext.ux.Multiselect({store:csiro.keyword.keywordStore,dataFields:["value","thesaurus"],data:[],width:640,height:230,allowBlank:false,minLength:this.minSelected,maxLength:this.maxSelected,minLengthText:"Minimum {0} term(s) required",maxLengthText:"Maximum {0} term(s) allowed",displayField:"thesaurus",valueField:"value",name:"itemselector",fieldLabel:"ItemSelector",tpl:a,legend:translate("foundKeywords"),});this.itemSelector.on({change:function(b){var c=b.view.getSelectedIndexes().length;Ext.getCmp("keywordSearchValidateButton").setDisabled(c<this.minSelected&&c>this.maxSelected)},scope:this});return this.itemSelector},buildTermLists:function(){this.keywordsSelected={};var d=csiro.keyword.thesaurusStore.collect("value");Ext.each(d,function(h,g,i){this.keywordsSelected[h]={uris:[],terms:[]}},this);var a=this.itemSelector.store;var e=this.itemSelector.view.getSelectedIndexes();for(var b=0;b<e.length;b++){var f=a.getAt(e[b]);var c=f.get("thesaurus");this.keywordsSelected[c].uris.push(f.get("uri").replace("#","%23"));this.keywordsSelected[c].terms.push(f.get("value"))}this.fireEvent("keywordselected",this,this.keywordsSelected);this.ownerCt.hide()}});