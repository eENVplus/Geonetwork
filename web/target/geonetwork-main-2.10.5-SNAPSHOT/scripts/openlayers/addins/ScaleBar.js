OpenLayers.Control.ScaleBar=OpenLayers.Class(OpenLayers.Control,{element:null,scale:1,displaySystem:"metric",minWidth:100,maxWidth:200,divisions:2,subdivisions:2,showMinorMeasures:false,abbreviateLabel:false,singleLine:false,align:"left",div:null,scaleText:"scale 1:",thousandsSeparator:"",measurementProperties:{english:{units:["miles","feet","inches"],abbr:["mi","ft","in"],inches:[63360,12,1]},metric:{units:["kilometers","meters","centimeters"],abbr:["km","m","cm"],inches:[39370.07874,39.370079,0.393701]}},limitedStyle:false,customStyles:null,defaultStyles:{Bar:{height:11,top:12,borderLeftWidth:0,borderRightWidth:0},BarAlt:{height:11,top:12,borderLeftWidth:0,borderRightWidth:0},MarkerMajor:{height:13,width:13,top:12,borderLeftWidth:0,borderRightWidth:0},MarkerMinor:{height:13,width:13,top:12,borderLeftWidth:0,borderRightWidth:0},NumbersBox:{height:13,width:40,top:24},LabelBox:{height:15,top:-2},LabelBoxSingleLine:{height:15,width:35,top:5,left:10}},appliedStyles:null,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a]);if(!document.styleSheets){this.limitedStyle=true}if(this.limitedStyle){this.appliedStyles=OpenLayers.Util.extend({},this.defaultStyles);OpenLayers.Util.extend(this.appliedStyles,this.customStyles)}this.element=document.createElement("div");this.element.style.position="relative";this.element.className=this.displayClass+"Wrapper";this.labelContainer=document.createElement("div");this.labelContainer.className=this.displayClass+"Units";this.labelContainer.style.position="absolute";this.graphicsContainer=document.createElement("div");this.graphicsContainer.style.position="absolute";this.graphicsContainer.className=this.displayClass+"Graphics";this.numbersContainer=document.createElement("div");this.numbersContainer.style.position="absolute";this.numbersContainer.className=this.displayClass+"Numbers";this.element.appendChild(this.graphicsContainer);this.element.appendChild(this.labelContainer);this.element.appendChild(this.numbersContainer)},destroy:function(){this.map.events.unregister("moveend",this,this.onMoveend);this.div.innerHTML="";OpenLayers.Control.prototype.destroy.apply(this)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.dxMarkerMajor=(this.styleValue("MarkerMajor","borderLeftWidth")+this.styleValue("MarkerMajor","width")+this.styleValue("MarkerMajor","borderRightWidth"))/2;this.dxMarkerMinor=(this.styleValue("MarkerMinor","borderLeftWidth")+this.styleValue("MarkerMinor","width")+this.styleValue("MarkerMinor","borderRightWidth"))/2;this.dxBar=(this.styleValue("Bar","borderLeftWidth")+this.styleValue("Bar","borderRightWidth"))/2;this.dxBarAlt=(this.styleValue("BarAlt","borderLeftWidth")+this.styleValue("BarAlt","borderRightWidth"))/2;this.dxNumbersBox=this.styleValue("NumbersBox","width")/2;var d=["Bar","BarAlt","MarkerMajor","MarkerMinor"];if(this.singleLine){d.push("LabelBoxSingleLine")}else{d.push("NumbersBox","LabelBox")}var a=0;for(var c=0;c<d.length;++c){var b=d[c];a=Math.max(a,this.styleValue(b,"top")+this.styleValue(b,"height"))}this.element.style.height=a+"px";this.xOffsetSingleLine=this.styleValue("LabelBoxSingleLine","width")+this.styleValue("LabelBoxSingleLine","left");this.div.appendChild(this.element);this.map.events.register("moveend",this,this.onMoveend);this.update();return this.div},onMoveend:function(){this.update()},update:function(e){if(this.map.baseLayer==null||!this.map.getScale()){return}this.scale=(e!=undefined)?e:this.map.getScale();this.element.title=this.scaleText+OpenLayers.Number.format(this.scale);this.element.style.width=this.maxWidth+"px";var i=this.getComp();this.setSubProps(i);this.labelContainer.innerHTML="";this.graphicsContainer.innerHTML="";this.numbersContainer.innerHTML="";var d=this.divisions*this.subdivisions;var j={left:0+(this.singleLine?0:this.dxNumbersBox),center:(this.maxWidth/2)-(d*this.subProps.pixels/2)-(this.singleLine?this.xOffsetSingleLine/2:0),right:this.maxWidth-(d*this.subProps.pixels)-(this.singleLine?this.xOffsetSingleLine:this.dxNumbersBox)};var h,a,f,m,c;for(var k=0;k<this.divisions;++k){h=k*this.subdivisions*this.subProps.pixels+j[this.align];this.graphicsContainer.appendChild(this.createElement("MarkerMajor"," ",h-this.dxMarkerMajor));if(!this.singleLine){a=(k==0)?0:OpenLayers.Number.format((k*this.subdivisions)*this.subProps.length,this.subProps.dec,this.thousandsSeparator);this.numbersContainer.appendChild(this.createElement("NumbersBox",a,h-this.dxNumbersBox))}for(var g=0;g<this.subdivisions;++g){if((g%2)==0){m="Bar";c=h-this.dxBar}else{m="BarAlt";c=h-this.dxBarAlt}this.graphicsContainer.appendChild(this.createElement(m," ",c,this.subProps.pixels));if(g<this.subdivisions-1){f=(k*this.subdivisions)+g+1;h=f*this.subProps.pixels+j[this.align];this.graphicsContainer.appendChild(this.createElement("MarkerMinor"," ",h-this.dxMarkerMinor));if(this.showMinorMeasures&&!this.singleLine){a=f*this.subProps.length;this.numbersContainer.appendChild(this.createElement("NumbersBox",a,h-this.dxNumbersBox))}}}}h=d*this.subProps.pixels;h+=j[this.align];this.graphicsContainer.appendChild(this.createElement("MarkerMajor"," ",h-this.dxMarkerMajor));a=OpenLayers.Number.format(d*this.subProps.length,this.subProps.dec,this.thousandsSeparator);if(!this.singleLine){this.numbersContainer.appendChild(this.createElement("NumbersBox",a,h-this.dxNumbersBox))}var l=document.createElement("div");l.style.position="absolute";var b;if(this.singleLine){b=a;l.className=this.displayClass+"LabelBoxSingleLine";l.style.left=Math.round(h+this.styleValue("LabelBoxSingleLine","left"))+"px"}else{b="";l.className=this.displayClass+"LabelBox";l.style.textAlign="center";l.style.width=Math.round(d*this.subProps.pixels)+"px";l.style.left=Math.round(j[this.align])+"px";l.style.overflow="hidden"}if(this.abbreviateLabel){b+=" "+this.subProps.abbr}else{b+=" "+this.subProps.units}l.appendChild(document.createTextNode(b));this.labelContainer.appendChild(l)},createElement:function(a,e,d,c){var b=document.createElement("div");b.className=this.displayClass+a;OpenLayers.Util.extend(b.style,{position:"absolute",textAlign:"center",overflow:"hidden",left:Math.round(d)+"px"});b.appendChild(document.createTextNode(e));if(c){b.style.width=Math.round(c)+"px"}return b},getComp:function(){var d=this.measurementProperties[this.displaySystem];var j=d.units.length;var n=new Array(j);var m=this.divisions*this.subdivisions;for(var l=0;l<j;++l){n[l]={};var e=OpenLayers.DOTS_PER_INCH*d.inches[l]/this.scale;var o=((this.minWidth-this.dxNumbersBox)/e)/m;var a=((this.maxWidth-this.dxNumbersBox)/e)/m;for(var p=0;p<m;++p){var f=o*(p+1);var c=a*(p+1);var h=this.getHandsomeNumber(f,c);var g={value:(h.value/(p+1)),score:0,tie:0,dec:0,displayed:0};for(var q=0;q<m;++q){var r=h.value*(q+1)/(p+1);var b=this.getHandsomeNumber(r,r);var k=((q+1)%this.subdivisions==0);var i=((q+1)==m);if((this.singleLine&&i)||(!this.singleLine&&(k||this.showMinorMeasures))){g.score+=b.score;g.tie+=b.tie;g.dec=Math.max(g.dec,b.dec);g.displayed+=1}else{g.score+=b.score/this.subdivisions;g.tie+=b.tie/this.subdivisions}}g.score*=(l+1)*g.tie/g.displayed;n[l][p]=g}}return n},setSubProps:function(b){var e=this.measurementProperties[this.displaySystem];var h=Number.POSITIVE_INFINITY;var f=Number.POSITIVE_INFINITY;for(var d=0;d<b.length;++d){var a=OpenLayers.DOTS_PER_INCH*e.inches[d]/this.scale;for(var g in b[d]){var c=b[d][g];if((c.score<h)||((c.score==h)&&(c.tie<f))){this.subProps={length:c.value,pixels:a*c.value,units:e.units[d],abbr:e.abbr[d],dec:c.dec};h=c.score;f=c.tie}}}},styleValue:function(a,h){var g=0;if(this.limitedStyle){g=this.appliedStyles[a][h]}else{a="."+this.displayClass+a;rules:for(var d=document.styleSheets.length-1;d>=0;--d){var e=document.styleSheets[d];if(!e.disabled){var j;try{if(typeof(e.cssRules)=="undefined"){if(typeof(e.rules)=="undefined"){continue}else{j=e.rules}}else{j=e.cssRules}}catch(b){continue}for(var c=0;c<j.length;++c){var f=j[c];if(f.selectorText&&(f.selectorText.toLowerCase()==a.toLowerCase())){if(f.style[h]!=""){g=parseInt(f.style[h]);break rules}}}}}}return g?g:0},getHandsomeNumber:function(i,g,d){d=(d==null)?10:d;var j={value:i,score:Number.POSITIVE_INFINITY,tie:Number.POSITIVE_INFINITY,dec:3};var l,k,f,h,m,c,e;for(var b=0;b<3;++b){l=Math.pow(2,(-1*b));k=Math.floor(Math.log(g/l)/Math.LN10);for(var a=k;a>(k-d+1);--a){f=Math.max(b-a,0);h=l*Math.pow(10,a);if((h*Math.floor(g/h))>=i){if(i%h==0){m=i/h}else{m=Math.floor(i/h)+1}c=m+(2*b);e=(a<0)?(Math.abs(a)+1):a;if((c<j.score)||((c==j.score)&&(e<j.tie))){j.value=parseFloat((h*m).toFixed(f));j.score=c;j.tie=e;j.dec=f}}}}return j},CLASS_NAME:"OpenLayers.Control.ScaleBar"});