OpenLayers.Format.Context=OpenLayers.Class({version:null,layerOptions:null,layerParams:null,parser:null,initialize:function(a){OpenLayers.Util.extend(this,a);this.options=a},read:function(f,d){if(typeof f=="string"){f=OpenLayers.Format.XML.prototype.read.apply(this,[f])}var b=f.documentElement;var a=this.version;if(!a){a=b.getAttribute("version")}var h=this.getParser(a);var e=h.read(f,d);var g;if(d&&d.map){this.context=e;if(d.map instanceof OpenLayers.Map){g=this.mergeContextToMap(e,d.map)}else{var c=d.map;if(OpenLayers.Util.isElement(c)||typeof c=="string"){c={div:c}}g=this.contextToMap(e,c)}}else{g=e}return g},getLayerFromContext:function(g){var c,f;var j={queryable:g.queryable,visibility:g.visibility,maxExtent:g.maxExtent,metadata:OpenLayers.Util.applyDefaults(g.metadata,{styles:g.styles}),numZoomLevels:g.numZoomLevels,units:g.units,isBaseLayer:g.isBaseLayer,opacity:g.opacity,displayInLayerSwitcher:g.displayInLayerSwitcher,singleTile:g.singleTile,tileSize:(g.tileSize)?new OpenLayers.Size(g.tileSize.width,g.tileSize.height):undefined,minScale:g.minScale||g.maxScaleDenominator,maxScale:g.maxScale||g.minScaleDenominator};if(this.layerOptions){OpenLayers.Util.applyDefaults(j,this.layerOptions)}var b={layers:g.name,transparent:g.transparent,version:g.version};if(g.formats&&g.formats.length>0){b.format=g.formats[0].value;for(c=0,f=g.formats.length;c<f;c++){var h=g.formats[c];if(h.current==true){b.format=h.value;break}}}if(g.styles&&g.styles.length>0){for(c=0,f=g.styles.length;c<f;c++){var a=g.styles[c];if(a.current==true){if(a.href){b.sld=a.href}else{if(a.body){b.sld_body=a.body}else{b.styles=a.name}}break}}}if(this.layerParams){OpenLayers.Util.applyDefaults(b,this.layerParams)}var d=null;var e=g.service;if(e==OpenLayers.Format.Context.serviceTypes.WFS){j.strategies=[new OpenLayers.Strategy.BBOX()];j.protocol=new OpenLayers.Protocol.WFS({url:g.url,featurePrefix:g.name.split(":")[0],featureType:g.name.split(":").pop()});d=new OpenLayers.Layer.Vector(g.title||g.name,j)}else{if(e==OpenLayers.Format.Context.serviceTypes.KML){j.strategies=[new OpenLayers.Strategy.Fixed()];j.protocol=new OpenLayers.Protocol.HTTP({url:g.url,format:new OpenLayers.Format.KML()});d=new OpenLayers.Layer.Vector(g.title||g.name,j)}else{if(e==OpenLayers.Format.Context.serviceTypes.GML){j.strategies=[new OpenLayers.Strategy.Fixed()];j.protocol=new OpenLayers.Protocol.HTTP({url:g.url,format:new OpenLayers.Format.GML()});d=new OpenLayers.Layer.Vector(g.title||g.name,j)}else{if(g.features){d=new OpenLayers.Layer.Vector(g.title||g.name,j);d.addFeatures(g.features)}else{if(g.categoryLayer!==true){d=new OpenLayers.Layer.WMS(g.title||g.name,g.url,b,j)}}}}}return d},getLayersFromContext:function(d){var e=[];for(var c=0,a=d.length;c<a;c++){var b=this.getLayerFromContext(d[c]);if(b!==null){e.push(b)}}return e},contextToMap:function(b,a){a=OpenLayers.Util.applyDefaults({maxExtent:b.maxExtent,projection:b.projection},a);var c=new OpenLayers.Map(a);c.addLayers(this.getLayersFromContext(b.layersContext));c.setCenter(b.bounds.getCenterLonLat(),c.getZoomForExtent(b.bounds,true));return c},mergeContextToMap:function(a,b){b.addLayers(this.getLayersFromContext(a.layersContext));return b},write:function(d,b){d=this.toContext(d);var a=b&&b.version;var e=this.getParser(a);var c=e.write(d,b);return c},CLASS_NAME:"OpenLayers.Format.Context"});OpenLayers.Format.Context.serviceTypes={WMS:"urn:ogc:serviceType:WMS",WFS:"urn:ogc:serviceType:WFS",WCS:"urn:ogc:serviceType:WCS",GML:"urn:ogc:serviceType:GML",SLD:"urn:ogc:serviceType:SLD",FES:"urn:ogc:serviceType:FES",KML:"urn:ogc:serviceType:KML"};