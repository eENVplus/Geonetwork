OpenLayers.Protocol.HTTP=OpenLayers.Class(OpenLayers.Protocol,{url:null,headers:null,params:null,callback:null,scope:null,readWithPOST:false,wildcarded:false,initialize:function(a){a=a||{};this.params={};this.headers={};OpenLayers.Protocol.prototype.initialize.apply(this,arguments)},destroy:function(){this.params=null;this.headers=null;OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(a){OpenLayers.Protocol.prototype.read.apply(this,arguments);a=OpenLayers.Util.applyDefaults(a,this.options);a.params=OpenLayers.Util.applyDefaults(a.params,this.options.params);if(a.filter){a.params=this.filterToParams(a.filter,a.params)}var b=(a.readWithPOST!==undefined)?a.readWithPOST:this.readWithPOST;var c=new OpenLayers.Protocol.Response({requestType:"read"});if(b){c.priv=OpenLayers.Request.POST({url:a.url,callback:this.createCallback(this.handleRead,c,a),data:OpenLayers.Util.getParameterString(a.params),headers:{"Content-Type":"application/x-www-form-urlencoded"}})}else{c.priv=OpenLayers.Request.GET({url:a.url,callback:this.createCallback(this.handleRead,c,a),params:a.params,headers:a.headers})}return c},handleRead:function(b,a){this.handleResponse(b,a)},filterToParams:function(d,g){g=g||{};var c=d.CLASS_NAME;var e=c.substring(c.lastIndexOf(".")+1);switch(e){case"Spatial":switch(d.type){case OpenLayers.Filter.Spatial.BBOX:g.bbox=d.value.toArray();break;case OpenLayers.Filter.Spatial.DWITHIN:g.tolerance=d.distance;case OpenLayers.Filter.Spatial.WITHIN:g.lon=d.value.x;g.lat=d.value.y;break;default:OpenLayers.Console.warn("Unknown spatial filter type "+d.type)}break;case"Comparison":var h=OpenLayers.Protocol.HTTP.COMP_TYPE_TO_OP_STR[d.type];if(h!==undefined){var f=d.value;if(d.type==OpenLayers.Filter.Comparison.LIKE){f=this.regex2value(f);if(this.wildcarded){f="%"+f+"%"}}g[d.property+"__"+h]=f;g.queryable=g.queryable||[];g.queryable.push(d.property)}else{OpenLayers.Console.warn("Unknown comparison filter type "+d.type)}break;case"Logical":if(d.type===OpenLayers.Filter.Logical.AND){for(var b=0,a=d.filters.length;b<a;b++){g=this.filterToParams(d.filters[b],g)}}else{OpenLayers.Console.warn("Unsupported logical filter type "+d.type)}break;default:OpenLayers.Console.warn("Unknown filter type "+e)}return g},regex2value:function(a){a=a.replace(/%/g,"\\%");a=a.replace(/\\\\\.(\*)?/g,function(c,b){return b?c:"\\\\_"});a=a.replace(/\\\\\.\*/g,"\\\\%");a=a.replace(/(\\)?\.(\*)?/g,function(c,b,d){return b||d?c:"_"});a=a.replace(/(\\)?\.\*/g,function(c,b){return b?c:"%"});a=a.replace(/\\\./g,".");a=a.replace(/(\\)?\\\*/g,function(c,b){return b?c:"*"});return a},create:function(b,a){a=OpenLayers.Util.applyDefaults(a,this.options);var c=new OpenLayers.Protocol.Response({reqFeatures:b,requestType:"create"});c.priv=OpenLayers.Request.POST({url:a.url,callback:this.createCallback(this.handleCreate,c,a),headers:a.headers,data:this.format.write(b)});return c},handleCreate:function(b,a){this.handleResponse(b,a)},update:function(c,b){b=b||{};var a=b.url||c.url||this.options.url+"/"+c.fid;b=OpenLayers.Util.applyDefaults(b,this.options);var d=new OpenLayers.Protocol.Response({reqFeatures:c,requestType:"update"});d.priv=OpenLayers.Request.PUT({url:a,callback:this.createCallback(this.handleUpdate,d,b),headers:b.headers,data:this.format.write(c)});return d},handleUpdate:function(b,a){this.handleResponse(b,a)},"delete":function(c,b){b=b||{};var a=b.url||c.url||this.options.url+"/"+c.fid;b=OpenLayers.Util.applyDefaults(b,this.options);var d=new OpenLayers.Protocol.Response({reqFeatures:c,requestType:"delete"});d.priv=OpenLayers.Request.DELETE({url:a,callback:this.createCallback(this.handleDelete,d,b),headers:b.headers});return d},handleDelete:function(b,a){this.handleResponse(b,a)},handleResponse:function(c,a){var b=c.priv;if(a.callback){if(b.status>=200&&b.status<300){if(c.requestType!="delete"){c.features=this.parseFeatures(b)}c.code=OpenLayers.Protocol.Response.SUCCESS}else{c.code=OpenLayers.Protocol.Response.FAILURE}a.callback.call(a.scope,c)}},parseFeatures:function(a){var b=a.responseXML;if(!b||!b.documentElement){b=a.responseText}if(!b||b.length<=0){return null}return this.format.read(b)},commit:function(b,q){q=OpenLayers.Util.applyDefaults(q,this.options);var d=[],m=0;var k={};k[OpenLayers.State.INSERT]=[];k[OpenLayers.State.UPDATE]=[];k[OpenLayers.State.DELETE]=[];var p,l,c=[];for(var e=0,j=b.length;e<j;++e){p=b[e];l=k[p.state];if(l){l.push(p);c.push(p)}}var g=(k[OpenLayers.State.INSERT].length>0?1:0)+k[OpenLayers.State.UPDATE].length+k[OpenLayers.State.DELETE].length;var o=true;var a=new OpenLayers.Protocol.Response({reqFeatures:c});function h(s){var r=s.features?s.features.length:0;var u=new Array(r);for(var t=0;t<r;++t){u[t]=s.features[t].fid}a.insertIds=u;n.apply(this,[s])}function n(i){this.callUserCallback(i,q);o=o&&i.success();m++;if(m>=g){if(q.callback){a.code=o?OpenLayers.Protocol.Response.SUCCESS:OpenLayers.Protocol.Response.FAILURE;q.callback.apply(q.scope,[a])}}}var f=k[OpenLayers.State.INSERT];if(f.length>0){d.push(this.create(f,OpenLayers.Util.applyDefaults({callback:h,scope:this},q.create)))}f=k[OpenLayers.State.UPDATE];for(var e=f.length-1;e>=0;--e){d.push(this.update(f[e],OpenLayers.Util.applyDefaults({callback:n,scope:this},q.update)))}f=k[OpenLayers.State.DELETE];for(var e=f.length-1;e>=0;--e){d.push(this["delete"](f[e],OpenLayers.Util.applyDefaults({callback:n,scope:this},q["delete"])))}return d},abort:function(a){if(a){a.priv.abort()}},callUserCallback:function(c,a){var b=a[c.requestType];if(b&&b.callback){b.callback.call(b.scope,c)}},CLASS_NAME:"OpenLayers.Protocol.HTTP"});(function(){var a=OpenLayers.Protocol.HTTP.COMP_TYPE_TO_OP_STR={};a[OpenLayers.Filter.Comparison.EQUAL_TO]="eq";a[OpenLayers.Filter.Comparison.NOT_EQUAL_TO]="ne";a[OpenLayers.Filter.Comparison.LESS_THAN]="lt";a[OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO]="lte";a[OpenLayers.Filter.Comparison.GREATER_THAN]="gt";a[OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO]="gte";a[OpenLayers.Filter.Comparison.LIKE]="ilike"})();