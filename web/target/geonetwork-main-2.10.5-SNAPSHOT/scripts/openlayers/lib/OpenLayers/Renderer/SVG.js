OpenLayers.Renderer.SVG=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",MAX_PIXEL:15000,translationParameters:null,symbolMetrics:null,isGecko:null,supportUse:null,initialize:function(a){if(!this.supported()){return}OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments);this.translationParameters={x:0,y:0};this.supportUse=(navigator.userAgent.toLowerCase().indexOf("applewebkit/5")==-1);this.isGecko=(navigator.userAgent.toLowerCase().indexOf("gecko/")!=-1);this.symbolMetrics={}},destroy:function(){OpenLayers.Renderer.Elements.prototype.destroy.apply(this,arguments)},supported:function(){var a="http://www.w3.org/TR/SVG11/feature#";return(document.implementation&&(document.implementation.hasFeature("org.w3c.svg","1.0")||document.implementation.hasFeature(a+"SVG","1.1")||document.implementation.hasFeature(a+"BasicStructure","1.1")))},inValidRange:function(a,e,b){var d=a+(b?0:this.translationParameters.x);var c=e+(b?0:this.translationParameters.y);return(d>=-this.MAX_PIXEL&&d<=this.MAX_PIXEL&&c>=-this.MAX_PIXEL&&c<=this.MAX_PIXEL)},setExtent:function(b,d){OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments);var a=this.getResolution();var f=-b.left/a;var e=b.top/a;if(d){this.left=f;this.top=e;var c="0 0 "+this.size.w+" "+this.size.h;this.rendererRoot.setAttributeNS(null,"viewBox",c);this.translate(0,0);return true}else{var g=this.translate(f-this.left,e-this.top);if(!g){this.setExtent(b,true)}return g}},translate:function(a,c){if(!this.inValidRange(a,c,true)){return false}else{var b="";if(a||c){b="translate("+a+","+c+")"}this.root.setAttributeNS(null,"transform",b);this.translationParameters={x:a,y:c};return true}},setSize:function(a){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);this.rendererRoot.setAttributeNS(null,"width",this.size.w);this.rendererRoot.setAttributeNS(null,"height",this.size.h)},getNodeType:function(c,b){var a=null;switch(c.CLASS_NAME){case"OpenLayers.Geometry.Point":if(b.externalGraphic){a="image"}else{if(this.isComplexSymbol(b.graphicName)){a=this.supportUse===false?"svg":"use"}else{a="circle"}}break;case"OpenLayers.Geometry.Rectangle":a="rect";break;case"OpenLayers.Geometry.LineString":a="polyline";break;case"OpenLayers.Geometry.LinearRing":a="polygon";break;case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":case"OpenLayers.Geometry.Surface":a="path";break;default:break}return a},setStyle:function(o,s,b){s=s||o._style;b=b||o._options;var j=parseFloat(o.getAttributeNS(null,"r"));var i=1;var d;if(o._geometryClass=="OpenLayers.Geometry.Point"&&j){o.style.visibility="";if(s.graphic===false){o.style.visibility="hidden"}else{if(s.externalGraphic){d=this.getPosition(o);if(s.graphicTitle){o.setAttributeNS(null,"title",s.graphicTitle)}if(s.graphicWidth&&s.graphicHeight){o.setAttributeNS(null,"preserveAspectRatio","none")}var n=s.graphicWidth||s.graphicHeight;var l=s.graphicHeight||s.graphicWidth;n=n?n:s.pointRadius*2;l=l?l:s.pointRadius*2;var t=(s.graphicXOffset!=undefined)?s.graphicXOffset:-(0.5*n);var f=(s.graphicYOffset!=undefined)?s.graphicYOffset:-(0.5*l);var a=s.graphicOpacity||s.fillOpacity;o.setAttributeNS(null,"x",(d.x+t).toFixed());o.setAttributeNS(null,"y",(d.y+f).toFixed());o.setAttributeNS(null,"width",n);o.setAttributeNS(null,"height",l);o.setAttributeNS(this.xlinkns,"href",s.externalGraphic);o.setAttributeNS(null,"style","opacity: "+a)}else{if(this.isComplexSymbol(s.graphicName)){var c=s.pointRadius*3;var k=c*2;var m=this.importSymbol(s.graphicName);d=this.getPosition(o);i=this.symbolMetrics[m][0]*3/k;var g=o.parentNode;var h=o.nextSibling;if(g){g.removeChild(o)}if(this.supportUse===false){var e=document.getElementById(m);o.firstChild&&o.removeChild(o.firstChild);o.appendChild(e.firstChild.cloneNode(true));o.setAttributeNS(null,"viewBox",e.getAttributeNS(null,"viewBox"))}else{o.setAttributeNS(this.xlinkns,"href","#"+m)}o.setAttributeNS(null,"width",k);o.setAttributeNS(null,"height",k);o.setAttributeNS(null,"x",d.x-c);o.setAttributeNS(null,"y",d.y-c);if(h){g.insertBefore(o,h)}else{if(g){g.appendChild(o)}}}else{o.setAttributeNS(null,"r",s.pointRadius)}}}var q=s.rotation;if((q!==undefined||o._rotation!==undefined)&&d){o._rotation=q;q|=0;if(o.nodeName!=="svg"){o.setAttributeNS(null,"transform","rotate("+q+" "+d.x+" "+d.y+")")}else{var p=this.symbolMetrics[m];o.firstChild.setAttributeNS(null,"transform","rotate("+s.rotation+" "+p[1]+" "+p[2]+")")}}}if(b.isFilled){o.setAttributeNS(null,"fill",s.fillColor);o.setAttributeNS(null,"fill-opacity",s.fillOpacity)}else{o.setAttributeNS(null,"fill","none")}if(b.isStroked){o.setAttributeNS(null,"stroke",s.strokeColor);o.setAttributeNS(null,"stroke-opacity",s.strokeOpacity);o.setAttributeNS(null,"stroke-width",s.strokeWidth*i);o.setAttributeNS(null,"stroke-linecap",s.strokeLinecap||"round");o.setAttributeNS(null,"stroke-linejoin","round");s.strokeDashstyle&&o.setAttributeNS(null,"stroke-dasharray",this.dashStyle(s,i))}else{o.setAttributeNS(null,"stroke","none")}if(s.pointerEvents){o.setAttributeNS(null,"pointer-events",s.pointerEvents)}if(s.cursor!=null){o.setAttributeNS(null,"cursor",s.cursor)}return o},dashStyle:function(c,b){var a=c.strokeWidth*b;var d=c.strokeDashstyle;switch(d){case"solid":return"none";case"dot":return[1,4*a].join();case"dash":return[4*a,4*a].join();case"dashdot":return[4*a,4*a,1,4*a].join();case"longdash":return[8*a,4*a].join();case"longdashdot":return[8*a,4*a,1,4*a].join();default:return OpenLayers.String.trim(d).replace(/\s+/g,",")}},createNode:function(a,c){var b=document.createElementNS(this.xmlns,a);if(c){b.setAttributeNS(null,"id",c)}return b},nodeTypeCompare:function(b,a){return(a==b.nodeName)},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_svgRoot","svg")},createRoot:function(a){return this.nodeFactory(this.container.id+a,"g")},createDefs:function(){var a=this.nodeFactory(this.container.id+"_defs","defs");this.rendererRoot.appendChild(a);return a},drawPoint:function(a,b){return this.drawCircle(a,b,1)},drawCircle:function(d,e,b){var c=this.getResolution();var a=(e.x/c+this.left);var f=(this.top-e.y/c);if(this.inValidRange(a,f)){d.setAttributeNS(null,"cx",a);d.setAttributeNS(null,"cy",f);d.setAttributeNS(null,"r",b);return d}else{return false}},drawLineString:function(b,c){var a=this.getComponentsString(c.components);if(a.path){b.setAttributeNS(null,"points",a.path);return(a.complete?b:null)}else{return false}},drawLinearRing:function(b,c){var a=this.getComponentsString(c.components);if(a.path){b.setAttributeNS(null,"points",a.path);return(a.complete?b:null)}else{return false}},drawPolygon:function(b,h){var g="";var i=true;var a=true;var c,k;for(var e=0,f=h.components.length;e<f;e++){g+=" M";c=this.getComponentsString(h.components[e].components," ");k=c.path;if(k){g+=" "+k;a=c.complete&&a}else{i=false}}g+=" z";if(i){b.setAttributeNS(null,"d",g);b.setAttributeNS(null,"fill-rule","evenodd");return a?b:null}else{return false}},drawRectangle:function(c,d){var b=this.getResolution();var a=(d.x/b+this.left);var e=(this.top-d.y/b);if(this.inValidRange(a,e)){c.setAttributeNS(null,"x",a);c.setAttributeNS(null,"y",e);c.setAttributeNS(null,"width",d.width/b);c.setAttributeNS(null,"height",d.height/b);return c}else{return false}},drawSurface:function(f,h){var g=null;var b=true;for(var e=0,a=h.components.length;e<a;e++){if((e%3)==0&&(e/3)==0){var c=this.getShortString(h.components[e]);if(!c){b=false}g="M "+c}else{if((e%3)==1){var c=this.getShortString(h.components[e]);if(!c){b=false}g+=" C "+c}else{var c=this.getShortString(h.components[e]);if(!c){b=false}g+=" "+c}}}g+=" Z";if(b){f.setAttributeNS(null,"d",g);return f}else{return false}},drawText:function(c,a,i){var b=this.getResolution();var h=(i.x/b+this.left);var e=(i.y/b-this.top);var g=this.nodeFactory(c+this.LABEL_ID_SUFFIX,"text");var f=this.nodeFactory(c+this.LABEL_ID_SUFFIX+"_tspan","tspan");g.setAttributeNS(null,"x",h);g.setAttributeNS(null,"y",-e);if(a.fontColor){g.setAttributeNS(null,"fill",a.fontColor)}if(a.fontOpacity){g.setAttributeNS(null,"opacity",a.fontOpacity)}if(a.fontFamily){g.setAttributeNS(null,"font-family",a.fontFamily)}if(a.fontSize){g.setAttributeNS(null,"font-size",a.fontSize)}if(a.fontWeight){g.setAttributeNS(null,"font-weight",a.fontWeight)}if(a.labelSelect===true){g.setAttributeNS(null,"pointer-events","visible");g._featureId=c;f._featureId=c;f._geometry=i;f._geometryClass=i.CLASS_NAME}else{g.setAttributeNS(null,"pointer-events","none")}var d=a.labelAlign||"cm";g.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG.LABEL_ALIGN[d[0]]||"middle");if(this.isGecko){g.setAttributeNS(null,"dominant-baseline",OpenLayers.Renderer.SVG.LABEL_ALIGN[d[1]]||"central")}else{f.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG.LABEL_VSHIFT[d[1]]||"-35%")}f.textContent=a.label;if(!g.parentNode){g.appendChild(f);this.textRoot.appendChild(g)}},getComponentsString:function(d,c){var f=[];var a=true;var e=d.length;var j=[];var g,h;for(var b=0;b<e;b++){h=d[b];f.push(h);g=this.getShortString(h);if(g){j.push(g)}else{if(b>0){if(this.getShortString(d[b-1])){j.push(this.clipLine(d[b],d[b-1]))}}if(b<e-1){if(this.getShortString(d[b+1])){j.push(this.clipLine(d[b],d[b+1]))}}a=false}}return{path:j.join(c||","),complete:a}},clipLine:function(e,h){if(h.equals(e)){return""}var f=this.getResolution();var b=this.MAX_PIXEL-this.translationParameters.x;var a=this.MAX_PIXEL-this.translationParameters.y;var d=h.x/f+this.left;var j=this.top-h.y/f;var c=e.x/f+this.left;var i=this.top-e.y/f;var g;if(c<-b||c>b){g=(i-j)/(c-d);c=c<0?-b:b;i=j+(c-d)*g}if(i<-a||i>a){g=(c-d)/(i-j);i=i<0?-a:a;c=d+(i-j)*g}return c+","+i},getShortString:function(b){var c=this.getResolution();var a=(b.x/c+this.left);var d=(this.top-b.y/c);if(this.inValidRange(a,d)){return a+","+d}else{return false}},getPosition:function(a){return({x:parseFloat(a.getAttributeNS(null,"cx")),y:parseFloat(a.getAttributeNS(null,"cy"))})},importSymbol:function(e){if(!this.defs){this.defs=this.createDefs()}var b=this.container.id+"-"+e;if(document.getElementById(b)!=null){return b}var d=OpenLayers.Renderer.symbol[e];if(!d){throw new Error(e+" is not a valid symbol name")}var g=this.nodeFactory(b,"symbol");var c=this.nodeFactory(null,"polygon");g.appendChild(c);var m=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0);var k=[];var j,h;for(var f=0;f<d.length;f=f+2){j=d[f];h=d[f+1];m.left=Math.min(m.left,j);m.bottom=Math.min(m.bottom,h);m.right=Math.max(m.right,j);m.top=Math.max(m.top,h);k.push(j,",",h)}c.setAttributeNS(null,"points",k.join(" "));var a=m.getWidth();var l=m.getHeight();var n=[m.left-a,m.bottom-l,a*3,l*3];g.setAttributeNS(null,"viewBox",n.join(" "));this.symbolMetrics[b]=[Math.max(a,l),m.getCenterLonLat().lon,m.getCenterLonLat().lat];this.defs.appendChild(g);return g.id},getFeatureIdFromEvent:function(a){var c=OpenLayers.Renderer.Elements.prototype.getFeatureIdFromEvent.apply(this,arguments);if(this.supportUse===false&&!c){var b=a.target;c=b.parentNode&&b!=this.rendererRoot&&b.parentNode._featureId}return c},CLASS_NAME:"OpenLayers.Renderer.SVG"});OpenLayers.Renderer.SVG.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"};OpenLayers.Renderer.SVG.LABEL_VSHIFT={t:"-70%",b:"0"};