OpenLayers.Control.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:false,drillDown:false,maxFeatures:10,clickCallback:"click",layers:null,queryVisible:false,url:null,layerUrls:null,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handlerOptions:null,handler:null,hoverRequest:null,EVENT_TYPES:["beforegetfeatureinfo","nogetfeatureinfo","getfeatureinfo"],initialize:function(a){this.EVENT_TYPES=OpenLayers.Control.WMSGetFeatureInfo.prototype.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES);a=a||{};a.handlerOptions=a.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[a]);if(!this.format){this.format=new OpenLayers.Format.WMSGetFeatureInfo(a.formatOptions)}if(this.drillDown===true){this.hover=false}if(this.hover){this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}))}else{var b={};b[this.clickCallback]=this.getInfoForClick;this.handler=new OpenLayers.Handler.Click(this,b,this.handlerOptions.click||{})}},activate:function(){if(!this.active){this.handler.activate()}return OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},getInfoForClick:function(a){this.events.triggerEvent("beforegetfeatureinfo",{xy:a.xy});OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait");this.request(a.xy,{})},getInfoForHover:function(a){this.events.triggerEvent("beforegetfeatureinfo",{xy:a.xy});this.request(a.xy,{hover:true})},cancelHover:function(){if(this.hoverRequest){this.hoverRequest.abort();this.hoverRequest=null}},findLayers:function(){var e=this.layers||this.map.layers;var f=[];var d,b;for(var c=0,a=e.length;c<a;++c){d=e[c];if(d instanceof OpenLayers.Layer.WMS&&(!this.queryVisible||d.getVisibility())){b=d.url instanceof Array?d.url[0]:d.url;if(this.drillDown===false&&!this.url){this.url=b}if(this.drillDown===true||this.urlMatches(b)){f.push(d)}}}return f},urlMatches:function(b){var d=OpenLayers.Util.isEquivalentUrl(this.url,b);if(!d&&this.layerUrls){for(var c=0,a=this.layerUrls.length;c<a;++c){if(OpenLayers.Util.isEquivalentUrl(this.layerUrls[c],b)){d=true;break}}}return d},buildWMSOptions:function(a,d,b,h){var g=[],j=[];for(var e=0,f=d.length;e<f;e++){g=g.concat(d[e].params.LAYERS);j=j.concat(this.getStyleNames(d[e]))}var c=OpenLayers.Util.extend({service:"WMS",version:d[0].params.VERSION,request:"GetFeatureInfo",layers:g,query_layers:g,styles:j,bbox:this.map.getExtent().toBBOX(null,d[0].reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:h,info_format:this.infoFormat},(parseFloat(d[0].params.VERSION)>=1.3)?{crs:this.map.getProjection(),i:b.x,j:b.y}:{srs:this.map.getProjection(),x:b.x,y:b.y});OpenLayers.Util.applyDefaults(c,this.vendorParams);return{url:a,params:OpenLayers.Util.upperCaseObject(c),callback:function(i){this.handleResponse(b,i)},scope:this}},getStyleNames:function(b){var a;if(b.params.STYLES){a=b.params.STYLES}else{if(b.params.LAYERS instanceof Array){a=new Array(b.params.LAYERS.length)}else{a=b.params.LAYERS.replace(/[^,]/g,"")}}return a},request:function(b,m){var d=this.findLayers();if(d.length==0){this.events.triggerEvent("nogetfeatureinfo");OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait");return}m=m||{};if(this.drillDown===false){var k=this.buildWMSOptions(this.url,d,b,d[0].params.FORMAT);var c=OpenLayers.Request.GET(k);if(m.hover===true){this.hoverRequest=c}}else{this._requestCount=0;this._numRequests=0;this.features=[];var j={},a;for(var e=0,h=d.length;e<h;e++){var f=d[e];var g,l=false;a=f.url instanceof Array?f.url[0]:f.url;if(a in j){j[a].push(f)}else{this._numRequests++;j[a]=[f]}}var d;for(var a in j){d=j[a];var k=this.buildWMSOptions(a,d,b,d[0].params.FORMAT);OpenLayers.Request.GET(k)}}},triggerGetFeatureInfo:function(b,c,a){this.events.triggerEvent("getfeatureinfo",{text:b.responseText,features:a,request:b,xy:c});OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},handleResponse:function(d,b){var c=b.responseXML;if(!c||!c.documentElement){c=b.responseText}var a=this.format.read(c);if(this.drillDown===false){this.triggerGetFeatureInfo(b,d,a)}else{this._requestCount++;this._features=(this._features||[]).concat(a);if(this._requestCount===this._numRequests){this.triggerGetFeatureInfo(b,d,this._features.concat());delete this._features;delete this._requestCount;delete this._numRequests}}},CLASS_NAME:"OpenLayers.Control.WMSGetFeatureInfo"});