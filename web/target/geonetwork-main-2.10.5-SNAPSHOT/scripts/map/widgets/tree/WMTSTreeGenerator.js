Ext.namespace("GeoNetwork","GeoNetwork.tree");GeoNetwork.tree.WMTSTreeGenerator=function(a){Ext.apply(this,a)};GeoNetwork.tree.WMTSTreeGenerator.prototype={layerParams:{format:"image/png",transparent:"TRUE"},layerOptions:{ratio:1,singleTile:true,isBaseLayer:false},click:null,callback:null,scope:null,loadWMS:function(i){var g=(i.indexOf("version=")>-1);var j=i.toLowerCase();var g=(j.indexOf("version=")>-1);var f=(j.indexOf("service=wmts")>-1);var d=(j.indexOf("request=getcapabilities")>-1);var e=(j.indexOf("language=")>-1);var b={};if(!g){b.version=GeoNetwork.OGCUtil.getProtocolVersion()}if(!f){b.service="WMTS"}if(!d){b.request="GetCapabilities"}if(!e){b.language=GeoNetwork.OGCUtil.getLanguage()}var a=OpenLayers.Util.getParameterString(b);var c=(i.indexOf("?")>-1)?"&":"?";i+=c+a;var h=Ext.Ajax.request({url:i,method:"GET",failure:this.processFailure,success:this.processSuccess,disableCaching:false,scope:this})},processSuccess:function(c){if(!this.parser){this.parser=new OpenLayers.Format.WMTSCapabilities()}var g=this.parser.read(c.responseXML||c.responseText);if(!g.service){g.service={}}if(!g.service.accessConstraints){g.service.accessContraints=""}this.layerParams.VERSION=g.version;var b=new Ext.tree.TreeNode({text:g.serviceIdentification.title});if(g.contents){for(var e=0,a=g.contents.layers.length;e<a;++e){var d=g.contents.layers[e];var f=this.addLayer(d,g.serviceMetadataUrl,b,g);this.processLayer(d,g.serviceMetadataUrl,f,g)}}Ext.callback(this.callback,this.scope,[b,g])},processFailure:function(a){Ext.callback(this.callback,this.scope,null)},createWMSLayer:function(e,d,b){var f=app.mapApp.getMap().projection;var a=app.mapApp.getMap().projection;var c=b.contents.tileMatrixSets;for(key in c){if(key.toUpperCase().indexOf(a)>=0||c[key].supportedCRS.toUpperCase().indexOf(a)>=0||c[key].identifier.toUpperCase().indexOf(a)>=0){f=key}}return this.parser.createLayer(b,{name:e.title,layer:e.identifier,matrixSet:f,isBaseLayer:false,format:e.formats[0]})},addLayer:function(c,b,a,f){var g=null;if(c.identifier){g=this.createWMSLayer(c,f,f);if(c.styles&&c.styles.length>0){var d=c.styles[0];if(d.legend&&d.legend.href){g.legendURL=d.legend.href}}}var e=new Ext.tree.TreeNode({wmsLayer:g,text:c.title});e.addListener("click",this.click,this.scope);if(a){a.appendChild(e)}return e},processLayer:function(b,a,d,c){Ext.each(b.layers,function(f){var e=this.addLayer(f,a,d,c);if(f.nestedLayers){this.processLayer(f,a,e,c)}},this)}};