Ext.namespace("GeoNetwork","GeoNetwork.tree");GeoNetwork.tree.WMSTreeGenerator=function(a){Ext.apply(this,a)};GeoNetwork.tree.WMSTreeGenerator.prototype={layerParams:{format:"image/png",transparent:"TRUE"},layerOptions:{ratio:1,singleTile:true,isBaseLayer:false},click:null,callback:null,scope:null,loadWMS:function(i){var g=(i.indexOf("version=")>-1);var j=i.toLowerCase();var g=(j.indexOf("version=")>-1);var f=(j.indexOf("service=wms")>-1);var d=(j.indexOf("request=getcapabilities")>-1);var e=(j.indexOf("language=")>-1);var b={};if(!g){b.version=GeoNetwork.OGCUtil.getProtocolVersion()}if(!f){b.service="WMS"}if(!d){b.request="GetCapabilities"}if(!e){b.language=GeoNetwork.OGCUtil.getLanguage()}var a=OpenLayers.Util.getParameterString(b);var c=(i.indexOf("?")>-1)?"&":"?";i+=c+a;var h=Ext.Ajax.request({url:OpenLayers.Util.removeTail(OpenLayers.ProxyHost),method:"GET",params:{url:i},failure:this.processFailure,success:this.processSuccess,disableCaching:false,scope:this})},processSuccess:function(b){if(!this.parser){this.parser=new OpenLayers.Format.WMSCapabilities()}var f=this.parser.read(b.responseXML||b.responseText);this.layerParams.VERSION=f.version;var e;if(f.capability){for(var d=0,a=f.capability.nestedLayers.length;d<a;++d){var c=f.capability.nestedLayers[d];e=this.addLayer(c,f.capability.request.getmap.href,null);this.processLayer(c,f.capability.request.getmap.href,e)}}Ext.callback(this.callback,this.scope,[e,f])},processFailure:function(a){Ext.callback(this.callback,this.scope,null)},createWMSLayer:function(b,a){return new OpenLayers.Layer.WMS(b.title,a,OpenLayers.Util.extend({layers:b.name,language:GeoNetwork.OGCUtil.getLanguage()},this.layerParams),OpenLayers.Util.extend({minScale:b.minScale,queryable:b.queryable,maxScale:b.maxScale,metadataURL:b.metadataURL,dimensions:b.dimensions,styles:b.styles,llbbox:b.llbbox},this.layerOptions))},addLayer:function(c,b,a){var f=null;if(c.name){f=this.createWMSLayer(c,b);if(c.styles&&c.styles.length>0){var d=c.styles[0];if(d.legend&&d.legend.href){f.legendURL=d.legend.href}}}var e=new Ext.tree.TreeNode({wmsLayer:f,text:c.title});e.addListener("click",this.click,this.scope);if(a){a.appendChild(e)}return e},processLayer:function(b,a,c){Ext.each(b.nestedLayers,function(e){var d=this.addLayer(e,a,c);if(e.nestedLayers){this.processLayer(e,a,d)}},this)}};