Ext.namespace("GeoExt.data");GeoExt.data.FeatureStoreMixin={layer:null,reader:null,addFeatureFilter:null,addRecordFilter:null,constructor:function(b){b=b||{};b.reader=b.reader||new GeoExt.data.FeatureReader({},b.fields);var c=b.layer;delete b.layer;if(b.features){b.data=b.features}delete b.features;var a={initDir:b.initDir};delete b.initDir;arguments.callee.superclass.constructor.call(this,b);if(c){this.bind(c,a)}},bind:function(d,b){if(this.layer){return}this.layer=d;b=b||{};var f=b.initDir;if(b.initDir==undefined){f=GeoExt.data.FeatureStore.LAYER_TO_STORE|GeoExt.data.FeatureStore.STORE_TO_LAYER}var e=d.features.slice(0);if(f&GeoExt.data.FeatureStore.STORE_TO_LAYER){var a=this.getRange();for(var c=a.length-1;c>=0;c--){this.layer.addFeatures([a[c].get("feature")])}}if(f&GeoExt.data.FeatureStore.LAYER_TO_STORE){this.loadData(e,true)}d.events.on({featuresadded:this.onFeaturesAdded,featuresremoved:this.onFeaturesRemoved,featuremodified:this.onFeatureModified,scope:this});this.on({load:this.onLoad,clear:this.onClear,add:this.onAdd,remove:this.onRemove,update:this.onUpdate,scope:this})},unbind:function(){if(this.layer){this.layer.events.un({featuresadded:this.onFeaturesAdded,featuresremoved:this.onFeaturesRemoved,featuremodified:this.onFeatureModified,scope:this});this.un("load",this.onLoad,this);this.un("clear",this.onClear,this);this.un("add",this.onAdd,this);this.un("remove",this.onRemove,this);this.un("update",this.onUpdate,this);this.layer=null}},getRecordFromFeature:function(c){var a=null;if(c.state!==OpenLayers.State.INSERT){a=this.getById(c.id)}else{var b=this.findBy(function(d){return d.get("feature")===c});if(b>-1){a=this.getAt(b)}}return a},onFeaturesAdded:function(b){if(!this._adding){var f=b.features,e=f;if(typeof this.addFeatureFilter=="function"){e=[];var d,a,c;for(var d=0,a=f.length;d<a;d++){c=f[d];if(this.addFeatureFilter(c)!==false){e.push(c)}}}this._adding=true;this.loadData(e,true);delete this._adding}},onFeaturesRemoved:function(b){if(!this._removing){var e=b.features,d,a,c;for(c=e.length-1;c>=0;c--){d=e[c];a=this.getRecordFromFeature(d);if(a!==undefined){this._removing=true;this.remove(a);delete this._removing}}}},onFeatureModified:function(d){if(!this._updating){var g=d.feature;var c=this.getRecordFromFeature(g);if(c!==undefined){c.beginEdit();attributes=g.attributes;if(attributes){var b=this.recordType.prototype.fields;for(var f=0,a=b.length;f<a;f++){var h=b.items[f];var e=h.mapping||h.name;if(e in attributes){c.set(h.name,h.convert(attributes[e]))}}}c.set("state",g.state);c.set("fid",g.fid);c.data.feature=g;this._updating=true;c.endEdit();delete this._updating}}},addFeaturesToLayer:function(c){var d,a,e,b;if(typeof this.addRecordFilter=="function"){e=[];for(d=0,a=c.length;d<a;d++){b=c[d];if(this.addRecordFilter(b)!==false){e.push(b.get("feature"))}}}else{e=new Array((a=c.length));for(d=0;d<a;d++){e[d]=c[d].get("feature")}}if(e.length>0){this._adding=true;this.layer.addFeatures(e);delete this._adding}},onLoad:function(b,a,c){if(!c||c.add!==true){this._removing=true;this.layer.removeFeatures(this.layer.features);delete this._removing;this.addFeaturesToLayer(a)}},onClear:function(a){this._removing=true;this.layer.removeFeatures(this.layer.features);delete this._removing},onAdd:function(b,a,c){if(!this._adding){this.addFeaturesToLayer(a)}},onRemove:function(b,a,c){if(!this._removing){var d=a.get("feature");if(this.layer.getFeatureById(d.id)!=null){this._removing=true;this.layer.removeFeatures([a.get("feature")]);delete this._removing}}},onUpdate:function(e,b,d){if(!this._updating){var g=new GeoExt.data.FeatureRecord().fields;var f=b.get("feature");if(b.fields){var a=this.layer.events.triggerEvent("beforefeaturemodified",{feature:f});if(a!==false){var c=f.attributes;b.fields.each(function(i){var h=i.mapping||i.name;if(!g.containsKey(h)){c[h]=b.get(i.name)}});this._updating=true;this.layer.events.triggerEvent("featuremodified",{feature:f});delete this._updating;if(this.layer.getFeatureById(f.id)!=null){this.layer.drawFeature(f)}}}}}};GeoExt.data.FeatureStore=Ext.extend(Ext.data.Store,GeoExt.data.FeatureStoreMixin);GeoExt.data.FeatureStore.LAYER_TO_STORE=1;GeoExt.data.FeatureStore.STORE_TO_LAYER=2;