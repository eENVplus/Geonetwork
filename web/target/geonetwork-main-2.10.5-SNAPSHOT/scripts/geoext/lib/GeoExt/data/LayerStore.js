Ext.namespace("GeoExt.data");GeoExt.data.LayerStoreMixin={map:null,reader:null,constructor:function(b){b=b||{};b.reader=b.reader||new GeoExt.data.LayerReader({},b.fields);delete b.fields;var c=b.map instanceof GeoExt.MapPanel?b.map.map:b.map;delete b.map;if(b.layers){b.data=b.layers}delete b.layers;var a={initDir:b.initDir};delete b.initDir;arguments.callee.superclass.constructor.call(this,b);if(c){this.bind(c,a)}},bind:function(d,a){if(this.map){return}this.map=d;a=a||{};var b=a.initDir;if(a.initDir==undefined){b=GeoExt.data.LayerStore.MAP_TO_STORE|GeoExt.data.LayerStore.STORE_TO_MAP}var c=d.layers.slice(0);if(b&GeoExt.data.LayerStore.STORE_TO_MAP){this.each(function(e){this.map.addLayer(e.get("layer"))},this)}if(b&GeoExt.data.LayerStore.MAP_TO_STORE){this.loadData(c,true)}d.events.on({changelayer:this.onChangeLayer,addlayer:this.onAddLayer,removelayer:this.onRemoveLayer,scope:this});this.on({load:this.onLoad,clear:this.onClear,add:this.onAdd,remove:this.onRemove,update:this.onUpdate,scope:this});this.data.on({replace:this.onReplace,scope:this})},unbind:function(){if(this.map){this.map.events.un({changelayer:this.onChangeLayer,addlayer:this.onAddLayer,removelayer:this.onRemoveLayer,scope:this});this.un("load",this.onLoad,this);this.un("clear",this.onClear,this);this.un("add",this.onAdd,this);this.un("remove",this.onRemove,this);this.data.un("replace",this.onReplace,this);this.map=null}},onChangeLayer:function(b){var e=b.layer;var c=this.findBy(function(f,g){return f.get("layer")===e});if(c>-1){var a=this.getAt(c);if(b.property==="order"){if(!this._adding&&!this._removing){var d=this.map.getLayerIndex(e);if(d!==c){this._removing=true;this.remove(a);delete this._removing;this._adding=true;this.insert(d,[a]);delete this._adding}}}else{if(b.property==="name"){a.set("title",e.name)}else{this.fireEvent("update",this,a,Ext.data.Record.EDIT)}}}},onAddLayer:function(a){if(!this._adding){var b=a.layer;this._adding=true;this.loadData([b],true);delete this._adding}},onRemoveLayer:function(a){if(this.map.unloadDestroy){if(!this._removing){var b=a.layer;this._removing=true;this.remove(this.getById(b.id));delete this._removing}}else{this.unbind()}},onLoad:function(c,b,e){if(!Ext.isArray(b)){b=[b]}if(e&&!e.add){this._removing=true;for(var f=this.map.layers.length-1;f>=0;f--){this.map.removeLayer(this.map.layers[f])}delete this._removing;var a=b.length;if(a>0){var g=new Array(a);for(var d=0;d<a;d++){g[d]=b[d].get("layer")}this._adding=true;this.map.addLayers(g);delete this._adding}}},onClear:function(a){this._removing=true;for(var b=this.map.layers.length-1;b>=0;b--){this.map.removeLayer(this.map.layers[b])}delete this._removing},onAdd:function(b,a,c){if(!this._adding){this._adding=true;var e;for(var d=a.length-1;d>=0;--d){e=a[d].get("layer");this.map.addLayer(e);if(c!==this.map.layers.length-1){this.map.setLayerIndex(e,c)}}delete this._adding}},onRemove:function(b,a,c){if(!this._removing){var d=a.get("layer");if(this.map.getLayer(d.id)!=null){this._removing=true;this.removeMapLayer(a);delete this._removing}}},onUpdate:function(c,a,b){if(b===Ext.data.Record.EDIT){var d=a.get("layer");var e=a.get("title");if(e!==d.name){d.setName(e)}}},removeMapLayer:function(a){this.map.removeLayer(a.get("layer"))},onReplace:function(c,a,b){this.removeMapLayer(a)},destroy:function(){this.unbind();GeoExt.data.LayerStore.superclass.destroy.call(this)}};GeoExt.data.LayerStore=Ext.extend(Ext.data.Store,GeoExt.data.LayerStoreMixin);GeoExt.data.LayerStore.MAP_TO_STORE=1;GeoExt.data.LayerStore.STORE_TO_MAP=2;