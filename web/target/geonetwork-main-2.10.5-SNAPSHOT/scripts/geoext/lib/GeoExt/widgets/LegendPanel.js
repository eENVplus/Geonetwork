Ext.namespace("GeoExt");GeoExt.LegendPanel=Ext.extend(Ext.Panel,{dynamic:true,showTitle:true,labelCls:null,bodyStyle:"",layerStore:null,filter:function(a){return true},initComponent:function(){GeoExt.LegendPanel.superclass.initComponent.call(this)},onRender:function(){GeoExt.LegendPanel.superclass.onRender.apply(this,arguments);if(!this.layerStore){this.layerStore=GeoExt.MapPanel.guess().layers}this.layerStore.each(function(a){this.addLegend(a)},this);if(this.dynamic){this.layerStore.on({add:this.onStoreAdd,remove:this.onStoreRemove,update:this.onStoreUpdate,scope:this})}this.doLayout()},recordIndexToPanelIndex:function(b){var a=this.layerStore;var f=a.getCount();var g=-1;var h=this.items?this.items.length:0;for(var d=f-1;d>=0;--d){var c=a.getAt(d).get("layer");var e=GeoExt["Legend"+c.CLASS_NAME.split(".").pop()];if(c.displayInLayerSwitcher&&e&&(a.getAt(d).get("hideInLegend")!==true)){++g;if(b===d||g>h-1){break}}}return g},onStoreUpdate:function(c,a,b){var e=a.get("layer");var f=this.items?this.getComponent(e.id):null;if((this.showTitle&&!a.get("hideTitle"))&&(f&&f.items.get(0).text!==a.get("title"))){f.items.get(0).setText(a.get("title"))}if(f){f.setVisible(e.getVisibility()&&e.displayInLayerSwitcher&&!a.get("hideInLegend"));var d=a.get("legendURL")!=null?a.get("legendURL"):undefined;f.items.get(1).updateLegend(d)}},onStoreAdd:function(c,b,d){var f=this.recordIndexToPanelIndex(d+b.length-1);for(var e=0,a=b.length;e<a;e++){this.addLegend(b[e],f)}this.doLayout()},onStoreRemove:function(b,a,c){this.removeLegend(a)},removeLegend:function(a){var b=this.getComponent(a.get("layer").id);if(b){this.remove(b,true);this.doLayout()}},createLegendSubpanel:function(a){var b=a.get("layer");var e=this.createMainPanel(a);if(e!==null){var d;if(a.get("legendURL")){d=new GeoExt.LegendImage({url:a.get("legendURL")});e.add(d)}else{var c=GeoExt["Legend"+b.CLASS_NAME.split(".").pop()];if(c){d=new c(Ext.applyIf({layer:b,record:a},this.legendOptions));e.add(d)}}}return e},addLegend:function(a,b){if(this.filter(a)===true){b=b||0;var c=a.get("layer");var d=this.createLegendSubpanel(a);if(d!==null){d.setVisible(c.getVisibility());this.insert(b,d)}}},createMainPanel:function(b){var c=b.get("layer");var a=null;var d=GeoExt["Legend"+c.CLASS_NAME.split(".").pop()];if(c.displayInLayerSwitcher&&!b.get("hideInLegend")&&d){var e={id:c.id,border:false,bodyBorder:false,bodyStyle:this.bodyStyle,items:[new Ext.form.Label({text:(this.showTitle&&!b.get("hideTitle"))?c.name:"",cls:"x-form-item x-form-item-label"+(this.labelCls?" "+this.labelCls:"")})]};a=new Ext.Panel(e)}return a},onDestroy:function(){if(this.layerStore){this.layerStore.un("add",this.onStoreAdd,this);this.layerStore.un("remove",this.onStoreRemove,this);this.layerStore.un("update",this.onStoreUpdate,this)}GeoExt.LegendPanel.superclass.onDestroy.apply(this,arguments)}});Ext.reg("gx_legendpanel",GeoExt.LegendPanel);