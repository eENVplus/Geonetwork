Ext.namespace("GeoExt.tree");GeoExt.tree.LayerNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{radio:null,constructor:function(a){GeoExt.tree.LayerNodeUI.superclass.constructor.apply(this,arguments)},render:function(d){var c=this.node.attributes;if(c.checked===undefined){c.checked=this.node.layer.getVisibility()}GeoExt.tree.LayerNodeUI.superclass.render.apply(this,arguments);var b=this.checkbox;if(c.radioGroup&&this.radio===null){this.radio=Ext.DomHelper.insertAfter(b,['<input type="radio" class="gx-tree-layer-radio" name="',c.radioGroup,'_radio"></input>'].join(""))}if(c.checkedGroup){var e=Ext.DomHelper.insertAfter(b,['<input type="radio" name="',c.checkedGroup,'_checkbox" class="',b.className,b.checked?'" checked="checked"':"",'"></input>'].join(""));e.defaultChecked=b.defaultChecked;Ext.get(b).remove();this.checkbox=e}this.enforceOneVisible()},onClick:function(a){if(a.getTarget(".gx-tree-layer-radio",1)){this.radio.defaultChecked=this.radio.checked;this.fireEvent("radiochange",this.node)}else{if(a.getTarget(".x-tree-node-cb",1)){this.onCheckChange()}else{GeoExt.tree.LayerNodeUI.superclass.onClick.apply(this,arguments)}}},toggleCheck:function(a){if(!this._visibilityChanging){this._visibilityChanging=true;a=(a===undefined?!this.isChecked():a)||(this.isChecked()&&!!this.node.attributes.checkedGroup);GeoExt.tree.LayerNodeUI.superclass.toggleCheck.call(this,a);this.enforceOneVisible();delete this._visibilityChanging}},enforceOneVisible:function(){var b=this.node.attributes;var f=b.checkedGroup;if(f){var d=this.node.layer;var a=this.node.getOwnerTree().getChecked();var c=0;Ext.each(a,function(i){var h=i.getUI();var g=i.layer;if(!i.hidden&&i.attributes.checkedGroup===f){c++;if(g!=d&&b.checked){h.checkbox.defaultChecked=false;h.checkbox.checked=false;g.setVisibility(false)}}});if(c===0&&b.checked==false){var e=this.node.getUI();e.checkbox.defaultChecked=true;e.checkbox.checked=true;d.setVisibility(true)}}},appendDDGhost:function(c){var b=this.elNode.cloneNode(true);var a=Ext.DomQuery.select("input[type='radio']",b);Ext.each(a,function(d){d.name=d.name+"_clone"});c.appendChild(b)},destroy:function(){delete this.radio;GeoExt.tree.LayerNodeUI.superclass.destroy.apply(this,arguments)}});GeoExt.tree.LayerNode=Ext.extend(Ext.tree.AsyncTreeNode,{layer:null,layerStore:null,constructor:function(a){a.leaf=a.leaf||!(a.children||a.loader);if(!a.iconCls&&!a.children){a.iconCls="gx-tree-layer-icon"}if(a.loader&&!(a.loader instanceof Ext.tree.TreeLoader)){a.loader=new GeoExt.tree.LayerParamLoader(a.loader)}this.defaultUI=this.defaultUI||GeoExt.tree.LayerNodeUI;this.addEvents("radiochange");Ext.apply(this,{layer:a.layer,layerStore:a.layerStore});if(a.text){this.fixedText=true}GeoExt.tree.LayerNode.superclass.constructor.apply(this,arguments)},render:function(a){var c=this.layer instanceof OpenLayers.Layer&&this.layer;if(!c){if(!this.layerStore||this.layerStore=="auto"){this.layerStore=GeoExt.MapPanel.guess().layers}var b=this.layerStore.findBy(function(e){return e.get("title")==this.layer},this);if(b!=-1){c=this.layerStore.getAt(b).get("layer")}}if(!this.rendered||!c){var d=this.getUI();if(c){this.layer=c;if(c.isBaseLayer){this.draggable=false;Ext.applyIf(this.attributes,{checkedGroup:"gx_baselayer"})}if(!this.text){this.text=c.name}d.show();this.addVisibilityEventHandlers()}else{d.hide()}if(this.layerStore instanceof GeoExt.data.LayerStore){this.addStoreEventHandlers(c)}}GeoExt.tree.LayerNode.superclass.render.apply(this,arguments)},addVisibilityEventHandlers:function(){this.layer.events.on({visibilitychanged:this.onLayerVisibilityChanged,scope:this});this.on({checkchange:this.onCheckChange,scope:this})},onLayerVisibilityChanged:function(){this.getUI().toggleCheck(this.layer.getVisibility())},onCheckChange:function(c,b){if(b!=this.layer.getVisibility()){var a=this.layer;if(b&&a.isBaseLayer&&a.map){a.map.setBaseLayer(a)}else{a.setVisibility(b)}}},addStoreEventHandlers:function(){this.layerStore.on({add:this.onStoreAdd,remove:this.onStoreRemove,update:this.onStoreUpdate,scope:this})},onStoreAdd:function(c,b,d){var a;for(var e=0;e<b.length;++e){a=b[e].get("layer");if(this.layer==a){this.getUI().show();break}else{if(this.layer==a.name){this.render();break}}}},onStoreRemove:function(b,a,c){if(this.layer==a.get("layer")){this.getUI().hide()}},onStoreUpdate:function(c,a,b){var d=a.get("layer");if(!this.fixedText&&(this.layer==d&&this.text!==d.name)){this.setText(d.name)}},destroy:function(){var b=this.layer;if(b instanceof OpenLayers.Layer){b.events.un({visibilitychanged:this.onLayerVisibilityChanged,scope:this})}delete this.layer;var a=this.layerStore;if(a){a.un("add",this.onStoreAdd,this);a.un("remove",this.onStoreRemove,this);a.un("update",this.onStoreUpdate,this)}delete this.layerStore;this.un("checkchange",this.onCheckChange,this);GeoExt.tree.LayerNode.superclass.destroy.apply(this,arguments)}});Ext.tree.TreePanel.nodeTypes.gx_layer=GeoExt.tree.LayerNode;