Ext.namespace("GeoExt");GeoExt.Popup=Ext.extend(Ext.Window,{anchored:true,map:null,panIn:true,unpinnable:true,feature:null,lonlat:null,animCollapse:false,draggable:false,shadow:false,popupCls:"gx-popup",ancCls:null,initComponent:function(){if(this.map instanceof GeoExt.MapPanel){this.map=this.map.map}if(!this.map&&this.feature&&this.feature.layer){this.map=this.feature.layer.map}if(!this.feature&&this.lonlat){this.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(this.lonlat.lon,this.lonlat.lat))}if(this.anchored){this.addAnchorEvents()}this.baseCls=this.popupCls+" "+this.baseCls;this.elements+=",anc";GeoExt.Popup.superclass.initComponent.call(this)},onRender:function(b,a){GeoExt.Popup.superclass.onRender.call(this,b,a);this.ancCls=this.popupCls+"-anc";this.createElement("anc",this.el.dom)},initTools:function(){if(this.unpinnable){this.addTool({id:"unpin",handler:this.unanchorPopup.createDelegate(this,[])})}GeoExt.Popup.superclass.initTools.call(this)},show:function(){GeoExt.Popup.superclass.show.apply(this,arguments);if(this.anchored){this.position();if(this.panIn&&!this._mapMove){this.panIntoView()}}},setSize:function(a,c){if(this.anc){var b=this.anc.getSize();if(typeof a=="object"){c=a.height-b.height;a=a.width}else{if(!isNaN(c)){c=c-b.height}}}GeoExt.Popup.superclass.setSize.call(this,a,c)},position:function(){var c=this.feature.geometry.getBounds().getCenterLonLat();if(this._mapMove===true){var g=this.map.getExtent().containsLonLat(c);if(g!==this.isVisible()){this.setVisible(g)}}if(this.isVisible()){var d=this.map.getViewPortPxFromLonLat(c);var f=Ext.fly(this.map.div).getBox();var e=this.anc;var b=e.getLeft(true)+e.getWidth()/2;var a=this.el.getHeight();this.setPosition(d.x+f.x-b,d.y+f.y-a)}},unanchorPopup:function(){this.removeAnchorEvents();this.draggable=true;this.header.addClass("x-window-draggable");this.dd=new Ext.Window.DD(this);this.anc.remove();this.anc=null;this.tools.unpin.hide()},panIntoView:function(){var g=this.feature.geometry.getBounds().getCenterLonLat();var a=this.map.getViewPortPxFromLonLat(g);var b=Ext.fly(this.map.div).getBox();var h=this.getPosition(true);h[0]-=b.x;h[1]-=b.y;var d=[b.width,b.height];var e=this.getSize();var c=[h[0],h[1]];var f=this.map.paddingForPopups;if(h[0]<f.left){c[0]=f.left}else{if(h[0]+e.width>d[0]-f.right){c[0]=d[0]-f.right-e.width}}if(h[1]<f.top){c[1]=f.top}else{if(h[1]+e.height>d[1]-f.bottom){c[1]=d[1]-f.bottom-e.height}}var j=h[0]-c[0];var i=h[1]-c[1];this.map.pan(j,i)},onMapMove:function(){this._mapMove=true;this.position();delete this._mapMove},addAnchorEvents:function(){this.map.events.on({move:this.onMapMove,scope:this});this.on({resize:this.position,collapse:this.position,expand:this.position,scope:this})},removeAnchorEvents:function(){this.map.events.un({move:this.onMapMove,scope:this});this.un("resize",this.position,this);this.un("collapse",this.position,this);this.un("expand",this.position,this)},beforeDestroy:function(){if(this.anchored){this.removeAnchorEvents()}GeoExt.Popup.superclass.beforeDestroy.call(this)}});Ext.reg("gx_popup",GeoExt.Popup);