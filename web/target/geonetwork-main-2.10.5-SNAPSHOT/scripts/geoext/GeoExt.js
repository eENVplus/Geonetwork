Ext.namespace("GeoExt.tree");GeoExt.tree.LayerContainer=Ext.extend(Ext.tree.AsyncTreeNode,{constructor:function(a){a=Ext.applyIf(a||{},{text:"Layers"});this.loader=a.loader instanceof GeoExt.tree.LayerLoader?a.loader:new GeoExt.tree.LayerLoader(Ext.applyIf(a.loader||{},{store:a.layerStore}));GeoExt.tree.LayerContainer.superclass.constructor.call(this,a)},recordIndexToNodeIndex:function(c){var b=this.loader.store;var e=b.getCount();var a=this.childNodes.length;var f=-1;for(var d=e-1;d>=0;--d){if(this.loader.filter(b.getAt(d))===true){++f;if(c===d||f>a-1){break}}}return f},destroy:function(){delete this.layerStore;GeoExt.tree.LayerContainer.superclass.destroy.apply(this,arguments)}});Ext.tree.TreePanel.nodeTypes.gx_layercontainer=GeoExt.tree.LayerContainer;Ext.namespace("GeoExt.tree");GeoExt.tree.BaseLayerContainer=Ext.extend(GeoExt.tree.LayerContainer,{constructor:function(a){a=Ext.applyIf(a||{},{text:"Base Layer",loader:{}});a.loader=Ext.applyIf(a.loader,{baseAttrs:Ext.applyIf(a.loader.baseAttrs||{},{iconCls:"gx-tree-baselayer-icon",checkedGroup:"baselayer"}),filter:function(b){var c=b.get("layer");return c.displayInLayerSwitcher===true&&c.isBaseLayer===true}});GeoExt.tree.BaseLayerContainer.superclass.constructor.call(this,a)}});Ext.tree.TreePanel.nodeTypes.gx_baselayercontainer=GeoExt.tree.BaseLayerContainer;Ext.namespace("GeoExt.tree");GeoExt.tree.LayerParamLoader=function(a){Ext.apply(this,a);this.addEvents("beforeload","load");GeoExt.tree.LayerLoader.superclass.constructor.call(this)};Ext.extend(GeoExt.tree.LayerParamLoader,Ext.util.Observable,{param:null,delimiter:",",load:function(b,d){if(this.fireEvent("beforeload",this,b)){while(b.firstChild){b.removeChild(b.firstChild)}var c=(b.layer instanceof OpenLayers.Layer.HTTPRequest)&&b.layer.params[this.param];if(c){var a=(c instanceof Array)?c:c.split(this.delimiter);Ext.each(a,function(e){this.addParamNode(e,b)},this)}if(typeof d=="function"){d()}this.fireEvent("load",this,b)}},addParamNode:function(a,c){var d=this.createNode({layer:c.layer,param:this.param,item:a,delimiter:this.delimiter});var b=c.item(0);if(b){c.insertBefore(d,b)}else{c.appendChild(d)}},createNode:function(attr){if(this.baseAttrs){Ext.apply(attr,this.baseAttrs)}if(typeof attr.uiProvider=="string"){attr.uiProvider=this.uiProviders[attr.uiProvider]||eval(attr.uiProvider)}attr.nodeType=attr.nodeType||"gx_layerparam";return new Ext.tree.TreePanel.nodeTypes[attr.nodeType](attr)}});Ext.namespace("GeoExt");GeoExt.SliderTip=Ext.extend(Ext.Tip,{hover:true,minWidth:10,minWidth:10,offsets:[0,-10],dragging:false,init:function(a){a.on({dragstart:this.onSlide,drag:this.onSlide,dragend:this.hide,destroy:this.destroy,scope:this});if(this.hover){a.on("render",this.registerThumbListeners,this)}this.slider=a},registerThumbListeners:function(){this.slider.thumb.on({mouseover:function(){this.onSlide(this.slider);this.dragging=false},mouseout:function(){if(!this.dragging){this.hide.apply(this,arguments)}},scope:this})},onSlide:function(a){this.dragging=true;this.show();this.body.update(this.getText(a));this.doAutoWidth();this.el.alignTo(a.thumb,"b-t?",this.offsets)},getText:function(a){return a.getValue()}});Ext.namespace("GeoExt");GeoExt.ZoomSlider=Ext.extend(Ext.Slider,{map:null,baseCls:"gx-zoomslider",aggressive:false,updating:false,initComponent:function(){GeoExt.ZoomSlider.superclass.initComponent.call(this);if(this.map){if(this.map instanceof GeoExt.MapPanel){this.map=this.map.map}this.bind(this.map)}if(this.aggressive===true){this.on("change",this.changeHandler,this)}else{this.on("changecomplete",this.changeHandler,this)}this.on("beforedestroy",this.unbind,this)},onRender:function(){GeoExt.ZoomSlider.superclass.onRender.apply(this,arguments);this.el.addClass(this.baseCls)},afterRender:function(){Ext.Slider.superclass.afterRender.apply(this,arguments);this.update()},addToMapPanel:function(a){if(!this.events.afterrender){this.on({render:function(){window.setTimeout(this.bind.createDelegate(this,[a.map]),0)},scope:this})}this.on({render:function(){var b=this.getEl();b.setStyle({position:"absolute",zIndex:a.map.Z_INDEX_BASE.Control});b.on({mousedown:this.stopMouseEvents,click:this.stopMouseEvents})},afterrender:function(){this.bind(a.map)},scope:this})},stopMouseEvents:function(a){a.stopEvent()},removeFromMapPanel:function(a){var b=this.getEl();b.un("mousedown",this.stopMouseEvents,this);b.un("click",this.stopMouseEvents,this);this.unbind()},bind:function(a){this.map=a;this.map.events.on({zoomend:this.update,changebaselayer:this.initZoomValues,scope:this});if(this.map.baseLayer){this.initZoomValues();this.update()}},unbind:function(){if(this.map){this.map.events.un({zoomend:this.update,changebaselayer:this.initZoomValues,scope:this})}},initZoomValues:function(){var a=this.map.baseLayer;if(this.initialConfig.minValue===undefined){this.minValue=a.minZoomLevel||0}if(this.initialConfig.maxValue===undefined){this.maxValue=a.maxZoomLevel||a.numZoomLevels-1}},getZoom:function(){return this.getValue()},getScale:function(){return OpenLayers.Util.getScaleFromResolution(this.map.getResolutionForZoom(this.getValue()),this.map.getUnits())},getResolution:function(){return this.map.getResolutionForZoom(this.getValue())},changeHandler:function(){if(this.map&&!this.updating){this.map.zoomTo(this.getValue())}},update:function(){if(this.rendered&&this.map){this.updating=true;this.setValue(this.map.getZoom());this.updating=false}}});Ext.reg("gx_zoomslider",GeoExt.ZoomSlider);Ext.namespace("GeoExt.data");GeoExt.data.WMSCapabilitiesReader=function(a,b){a=a||{};if(!a.format){a.format=new OpenLayers.Format.WMSCapabilities()}if(typeof b!=="function"){b=GeoExt.data.LayerRecord.create(b||a.fields||[{name:"name",type:"string"},{name:"title",type:"string"},{name:"abstract",type:"string"},{name:"queryable",type:"boolean"},{name:"opaque",type:"boolean"},{name:"noSubsets",type:"boolean"},{name:"cascaded",type:"int"},{name:"fixedWidth",type:"int"},{name:"fixedHeight",type:"int"},{name:"minScale",type:"float"},{name:"maxScale",type:"float"},{name:"prefix",type:"string"},{name:"formats"},{name:"styles"},{name:"srs"},{name:"dimensions"},{name:"bbox"},{name:"llbbox"},{name:"attribution"},{name:"keywords"},{name:"identifiers"},{name:"authorityURLs"},{name:"metadataURLs"}])}GeoExt.data.WMSCapabilitiesReader.superclass.constructor.call(this,a,b)};Ext.extend(GeoExt.data.WMSCapabilitiesReader,Ext.data.DataReader,{attributionCls:"gx-attribution",read:function(a){var b=a.responseXML;if(!b||!b.documentElement){b=a.responseText}return this.readRecords(b)},serviceExceptionFormat:function(a){if(OpenLayers.Util.indexOf(a,"application/vnd.ogc.se_inimage")>-1){return"application/vnd.ogc.se_inimage"}if(OpenLayers.Util.indexOf(a,"application/vnd.ogc.se_xml")>-1){return"application/vnd.ogc.se_xml"}return a[0]},imageFormat:function(b){var a=b.formats;if(b.opaque&&OpenLayers.Util.indexOf(a,"image/jpeg")>-1){return"image/jpeg"}if(OpenLayers.Util.indexOf(a,"image/png")>-1){return"image/png"}if(OpenLayers.Util.indexOf(a,"image/png; mode=24bit")>-1){return"image/png; mode=24bit"}if(OpenLayers.Util.indexOf(a,"image/gif")>-1){return"image/gif"}return a[0]},imageTransparent:function(a){return a.opaque==undefined||!a.opaque},readRecords:function(t){if(typeof t==="string"||t.nodeType){t=this.meta.format.read(t)}var e=t.version;var c=t.capability||{};var f=c.request&&c.request.getmap&&c.request.getmap.href;var h=c.layers;var g=c.exception?c.exception.formats:[];var p=this.serviceExceptionFormat(g);var o=[];if(f&&h){var l=this.recordType.prototype.fields;var s,b,d,a,k;for(var n=0,r=h.length;n<r;n++){s=h[n];if(s.name){b={};for(var m=0,q=l.length;m<q;m++){a=l.items[m];k=s[a.mapping||a.name]||a.defaultValue;k=a.convert(k);b[a.name]=k}d={attribution:s.attribution?this.attributionMarkup(s.attribution):undefined,minScale:s.minScale,maxScale:s.maxScale};if(this.meta.layerOptions){Ext.apply(d,this.meta.layerOptions)}b.layer=new OpenLayers.Layer.WMS(s.title||s.name,f,{layers:s.name,exceptions:p,format:this.imageFormat(s),transparent:this.imageTransparent(s),version:e},d);o.push(new this.recordType(b,b.layer.id))}}}return{totalRecords:o.length,success:true,records:o}},attributionMarkup:function(a){var b=[];if(a.logo){b.push("<img class='"+this.attributionCls+"-image' src='"+a.logo.href+"' />")}if(a.title){b.push("<span class='"+this.attributionCls+"-title'>"+a.title+"</span>")}if(a.href){for(var c=0;c<b.length;c++){b[c]="<a class='"+this.attributionCls+"-link' href="+a.href+">"+b[c]+"</a>"}}return b.join(" ")}});Ext.namespace("GeoExt.data");GeoExt.data.LayerStoreMixin={map:null,reader:null,constructor:function(b){b=b||{};b.reader=b.reader||new GeoExt.data.LayerReader({},b.fields);delete b.fields;var c=b.map instanceof GeoExt.MapPanel?b.map.map:b.map;delete b.map;if(b.layers){b.data=b.layers}delete b.layers;var a={initDir:b.initDir};delete b.initDir;arguments.callee.superclass.constructor.call(this,b);if(c){this.bind(c,a)}},bind:function(d,a){if(this.map){return}this.map=d;a=a||{};var b=a.initDir;if(a.initDir==undefined){b=GeoExt.data.LayerStore.MAP_TO_STORE|GeoExt.data.LayerStore.STORE_TO_MAP}var c=d.layers.slice(0);if(b&GeoExt.data.LayerStore.STORE_TO_MAP){this.each(function(e){this.map.addLayer(e.get("layer"))},this)}if(b&GeoExt.data.LayerStore.MAP_TO_STORE){this.loadData(c,true)}d.events.on({changelayer:this.onChangeLayer,addlayer:this.onAddLayer,removelayer:this.onRemoveLayer,scope:this});this.on({load:this.onLoad,clear:this.onClear,add:this.onAdd,remove:this.onRemove,update:this.onUpdate,scope:this});this.data.on({replace:this.onReplace,scope:this})},unbind:function(){if(this.map){this.map.events.un({changelayer:this.onChangeLayer,addlayer:this.onAddLayer,removelayer:this.onRemoveLayer,scope:this});this.un("load",this.onLoad,this);this.un("clear",this.onClear,this);this.un("add",this.onAdd,this);this.un("remove",this.onRemove,this);this.data.un("replace",this.onReplace,this);this.map=null}},onChangeLayer:function(b){var e=b.layer;var c=this.findBy(function(f,g){return f.get("layer")===e});if(c>-1){var a=this.getAt(c);if(b.property==="order"){if(!this._adding&&!this._removing){var d=this.map.getLayerIndex(e);if(d!==c){this._removing=true;this.remove(a);delete this._removing;this._adding=true;this.insert(d,[a]);delete this._adding}}}else{if(b.property==="name"){a.set("title",e.name)}else{this.fireEvent("update",this,a,Ext.data.Record.EDIT)}}}},onAddLayer:function(a){if(!this._adding){var b=a.layer;this._adding=true;this.loadData([b],true);delete this._adding}},onRemoveLayer:function(a){if(this.map.unloadDestroy){if(!this._removing){var b=a.layer;this._removing=true;this.remove(this.getById(b.id));delete this._removing}}else{this.unbind()}},onLoad:function(c,b,e){if(!Ext.isArray(b)){b=[b]}if(e&&!e.add){this._removing=true;for(var f=this.map.layers.length-1;f>=0;f--){this.map.removeLayer(this.map.layers[f])}delete this._removing;var a=b.length;if(a>0){var g=new Array(a);for(var d=0;d<a;d++){g[d]=b[d].get("layer")}this._adding=true;this.map.addLayers(g);delete this._adding}}},onClear:function(a){this._removing=true;for(var b=this.map.layers.length-1;b>=0;b--){this.map.removeLayer(this.map.layers[b])}delete this._removing},onAdd:function(b,a,c){if(!this._adding){this._adding=true;var e;for(var d=a.length-1;d>=0;--d){e=a[d].get("layer");this.map.addLayer(e);if(c!==this.map.layers.length-1){this.map.setLayerIndex(e,c)}}delete this._adding}},onRemove:function(b,a,c){if(!this._removing){var d=a.get("layer");if(this.map.getLayer(d.id)!=null){this._removing=true;this.removeMapLayer(a);delete this._removing}}},onUpdate:function(c,a,b){if(b===Ext.data.Record.EDIT){var d=a.get("layer");var e=a.get("title");if(e!==d.name){d.setName(e)}}},removeMapLayer:function(a){this.map.removeLayer(a.get("layer"))},onReplace:function(c,a,b){this.removeMapLayer(a)},destroy:function(){this.unbind();GeoExt.data.LayerStore.superclass.destroy.call(this)}};GeoExt.data.LayerStore=Ext.extend(Ext.data.Store,GeoExt.data.LayerStoreMixin);GeoExt.data.LayerStore.MAP_TO_STORE=1;GeoExt.data.LayerStore.STORE_TO_MAP=2;Ext.namespace("GeoExt.tree");GeoExt.tree.LayerLoader=function(a){Ext.apply(this,a);this.addEvents("beforeload","load");GeoExt.tree.LayerLoader.superclass.constructor.call(this)};Ext.extend(GeoExt.tree.LayerLoader,Ext.util.Observable,{store:null,filter:function(a){return a.get("layer").displayInLayerSwitcher==true},uiProviders:null,load:function(a,b){if(this.fireEvent("beforeload",this,a)){this.removeStoreHandlers();while(a.firstChild){a.removeChild(a.firstChild)}if(!this.uiProviders){this.uiProviders=a.getOwnerTree().getLoader().uiProviders}if(!this.store){this.store=GeoExt.MapPanel.guess().layers}this.store.each(function(c){this.addLayerNode(a,c)},this);this.addStoreHandlers(a);if(typeof b=="function"){b()}this.fireEvent("load",this,a)}},onStoreAdd:function(b,a,c,e){if(!this._reordering){var f=e.recordIndexToNodeIndex(c+a.length-1);for(var d=0;d<a.length;++d){this.addLayerNode(e,a[d],f)}}},onStoreRemove:function(b,a,c,d){if(!this._reordering){this.removeLayerNode(d,a)}},addLayerNode:function(d,a,b){b=b||0;if(this.filter(a)===true){var e=this.createNode({nodeType:"gx_layer",layer:a.get("layer"),layerStore:this.store});var c=d.item(b);if(c){d.insertBefore(e,c)}else{d.appendChild(e)}e.on("move",this.onChildMove,this)}},removeLayerNode:function(b,a){if(this.filter(a)===true){var c=b.findChildBy(function(d){return d.layer==a.get("layer")});if(c){c.un("move",this.onChildMove,this);c.remove();b.reload()}}},onChildMove:function(k,c,i,j,g){this._reordering=true;var b=this.store.findBy(function(l){return l.get("layer")===c.layer});var f=this.store.getAt(b);if(j instanceof GeoExt.tree.LayerContainer&&this.store===j.loader.store){j.loader._reordering=true;this.store.remove(f);var a;if(j.childNodes.length>1){var h=(g===0)?g+1:g-1;a=this.store.findBy(function(l){return j.childNodes[h].layer===l.get("layer")});g===0&&a++}else{if(i.parentNode===j.parentNode){var d=j;do{d=d.previousSibling}while(d&&!(d instanceof GeoExt.tree.LayerContainer&&d.lastChild));if(d){a=this.store.findBy(function(l){return d.lastChild.layer===l.get("layer")})}else{var e=j;do{e=e.nextSibling}while(e&&!(e instanceof GeoExt.tree.LayerContainer&&e.firstChild));if(e){a=this.store.findBy(function(l){return e.firstChild.layer===l.get("layer")})}a++}}}if(a!==undefined){this.store.insert(a,[f]);window.setTimeout(function(){j.reload();i.reload()})}else{this.store.insert(b,[f])}delete j.loader._reordering}delete this._reordering},addStoreHandlers:function(b){if(!this._storeHandlers){this._storeHandlers={add:this.onStoreAdd.createDelegate(this,[b],true),remove:this.onStoreRemove.createDelegate(this,[b],true)};for(var a in this._storeHandlers){this.store.on(a,this._storeHandlers[a],this)}}},removeStoreHandlers:function(){if(this._storeHandlers){for(var a in this._storeHandlers){this.store.un(a,this._storeHandlers[a],this)}delete this._storeHandlers}},createNode:function(attr){if(this.baseAttrs){Ext.apply(attr,this.baseAttrs)}if(typeof attr.uiProvider=="string"){attr.uiProvider=this.uiProviders[attr.uiProvider]||eval(attr.uiProvider)}attr.nodeType=attr.nodeType||"gx_layer";return new Ext.tree.TreePanel.nodeTypes[attr.nodeType](attr)},destroy:function(){this.removeStoreHandlers()}});Ext.namespace("GeoExt.grid");GeoExt.grid.FeatureSelectionModelMixin={autoActivateControl:true,layerFromStore:true,selectControl:null,bound:false,superclass:null,constructor:function(a){a=a||{};if(a.selectControl instanceof OpenLayers.Control.SelectFeature){if(!a.singleSelect){var b=a.selectControl;a.singleSelect=!(b.multiple||!!b.multipleKey)}}else{if(a.layer instanceof OpenLayers.Layer.Vector){this.selectControl=this.createSelectControl(a.layer,a.selectControl);delete a.layer;delete a.selectControl}}this.superclass=arguments.callee.superclass;this.superclass.constructor.call(this,a)},initEvents:function(){this.superclass.initEvents.call(this);if(this.layerFromStore){var a=this.grid.getStore()&&this.grid.getStore().layer;if(a&&!(this.selectControl instanceof OpenLayers.Control.SelectFeature)){this.selectControl=this.createSelectControl(a,this.selectControl)}}if(this.selectControl){this.bind(this.selectControl)}},createSelectControl:function(b,a){a=a||{};var d=a.singleSelect!==undefined?a.singleSelect:this.singleSelect;a=OpenLayers.Util.extend({toggle:true,multipleKey:d?null:(Ext.isMac?"metaKey":"ctrlKey")},a);var c=new OpenLayers.Control.SelectFeature(b,a);b.map.addControl(c);return c},bind:function(e,b){if(!this.bound){b=b||{};this.selectControl=e;if(e instanceof OpenLayers.Layer.Vector){this.selectControl=this.createSelectControl(e,b.controlConfig)}if(this.autoActivateControl){this.selectControl.activate()}var d=this.getLayers();for(var c=0,a=d.length;c<a;c++){d[c].events.on({featureselected:this.featureSelected,featureunselected:this.featureUnselected,scope:this})}this.on("rowselect",this.rowSelected,this);this.on("rowdeselect",this.rowDeselected,this);this.bound=true}return this.selectControl},unbind:function(){var c=this.selectControl;if(this.bound){var d=this.getLayers();for(var b=0,a=d.length;b<a;b++){d[b].events.un({featureselected:this.featureSelected,featureunselected:this.featureUnselected,scope:this})}this.un("rowselect",this.rowSelected,this);this.un("rowdeselect",this.rowDeselected,this);if(this.autoActivateControl){c.deactivate()}this.selectControl=null;this.bound=false}return c},featureSelected:function(a){if(!this._selecting){var b=this.grid.store;var c=b.findBy(function(d,e){return d.data.feature==a.feature});if(c!=-1&&!this.isSelected(c)){this._selecting=true;this.selectRow(c,!this.singleSelect);this._selecting=false;this.grid.getView().focusRow(c)}}},featureUnselected:function(a){if(!this._selecting){var b=this.grid.store;var c=b.findBy(function(d,e){return d.data.feature==a.feature});if(c!=-1&&this.isSelected(c)){this._selecting=true;this.deselectRow(c);this._selecting=false;this.grid.getView().focusRow(c)}}},rowSelected:function(c,g,b){var e=b.data.feature;if(!this._selecting&&e){var f=this.getLayers();for(var d=0,a=f.length;d<a;d++){if(f[d].selectedFeatures.indexOf(e)==-1){this._selecting=true;this.selectControl.select(e);this._selecting=false;break}}}},rowDeselected:function(c,g,b){var e=b.data.feature;if(!this._selecting&&e){var f=this.getLayers();for(var d=0,a=f.length;d<a;d++){if(f[d].selectedFeatures.indexOf(e)!=-1){this._selecting=true;this.selectControl.unselect(e);this._selecting=false;break}}}},getLayers:function(){return this.selectControl.layers||[this.selectControl.layer]}};GeoExt.grid.FeatureSelectionModel=Ext.extend(Ext.grid.RowSelectionModel,GeoExt.grid.FeatureSelectionModelMixin);Ext.namespace("GeoExt","GeoExt.data");GeoExt.data.LayerReader=function(a,b){a=a||{};if(!(b instanceof Function)){b=GeoExt.data.LayerRecord.create(b||a.fields||{})}GeoExt.data.LayerReader.superclass.constructor.call(this,a,b)};Ext.extend(GeoExt.data.LayerReader,Ext.data.DataReader,{totalRecords:null,readRecords:function(f){var a=[];if(f){var c=this.recordType,k=c.prototype.fields;var g,d,e,b,h,n,l,m;for(g=0,d=f.length;g<d;g++){h=f[g];n={};for(e=0,b=k.length;e<b;e++){l=k.items[e];m=h[l.mapping||l.name]||l.defaultValue;m=l.convert(m);n[l.name]=m}n.layer=h;a[a.length]=new c(n,h.id)}}return{records:a,totalRecords:this.totalRecords!=null?this.totalRecords:a.length}}});Ext.namespace("GeoExt.data");GeoExt.data.LayerRecord=Ext.data.Record.create([{name:"layer"},{name:"title",type:"string",mapping:"name"}]);GeoExt.data.LayerRecord.prototype.clone=function(b){var a=this.get("layer")&&this.get("layer").clone();return new this.constructor(Ext.applyIf({layer:a},this.data),b||a.id)};GeoExt.data.LayerRecord.create=function(e){var c=Ext.extend(GeoExt.data.LayerRecord,{});var d=c.prototype;d.fields=new Ext.util.MixedCollection(false,function(f){return f.name});GeoExt.data.LayerRecord.prototype.fields.each(function(g){d.fields.add(g)});if(e){for(var b=0,a=e.length;b<a;b++){d.fields.add(new Ext.data.Field(e[b]))}}c.getField=function(f){return d.fields.get(f)};return c};Ext.namespace("GeoExt.form");GeoExt.form.BasicForm=Ext.extend(Ext.form.BasicForm,{protocol:null,prevResponse:null,autoAbort:true,doAction:function(b,a){if(b=="search"){a=Ext.applyIf(a||{},{protocol:this.protocol,abortPrevious:this.autoAbort});b=new GeoExt.form.SearchAction(this,a)}return GeoExt.form.BasicForm.superclass.doAction.call(this,b,a)},search:function(a){return this.doAction("search",a)}});Ext.namespace("GeoExt","GeoExt.data");GeoExt.data.FeatureReader=function(a,b){a=a||{};if(!(b instanceof Function)){b=GeoExt.data.FeatureRecord.create(b||a.fields||{})}GeoExt.data.FeatureReader.superclass.constructor.call(this,a,b)};Ext.extend(GeoExt.data.FeatureReader,Ext.data.DataReader,{totalRecords:null,read:function(a){return this.readRecords(a.features)},readRecords:function(b){var c=[];if(b){var f=this.recordType,l=f.prototype.fields;var k,g,h,d,q,p,n,o;for(k=0,g=b.length;k<g;k++){q=b[k];p={};if(q.attributes){for(h=0,d=l.length;h<d;h++){n=l.items[h];if(/[\[\.]/.test(n.mapping)){try{o=new Function("obj","return obj."+n.mapping)(q.attributes)}catch(m){o=n.defaultValue}}else{o=q.attributes[n.mapping||n.name]||n.defaultValue}if(n.convert){o=n.convert(o)}p[n.name]=o}}p.feature=q;p.state=q.state;p.fid=q.fid;var a=(q.state===OpenLayers.State.INSERT)?undefined:q.id;c[c.length]=new f(p,a)}}return{records:c,totalRecords:this.totalRecords!=null?this.totalRecords:c.length}}});Ext.namespace("GeoExt.data");GeoExt.data.WMSDescribeLayerReader=function(a,b){a=a||{};if(!a.format){a.format=new OpenLayers.Format.WMSDescribeLayer()}if(!(typeof b==="function")){b=Ext.data.Record.create(b||a.fields||[{name:"owsType",type:"string"},{name:"owsURL",type:"string"},{name:"typeName",type:"string"}])}GeoExt.data.WMSDescribeLayerReader.superclass.constructor.call(this,a,b)};Ext.extend(GeoExt.data.WMSDescribeLayerReader,Ext.data.DataReader,{read:function(a){var b=a.responseXML;if(!b||!b.documentElement){b=a.responseText}return this.readRecords(b)},readRecords:function(e){if(typeof e==="string"||e.nodeType){e=this.meta.format.read(e)}var b=[],d;for(var c=0,a=e.length;c<a;c++){d=e[c];if(d){b.push(new this.recordType(d))}}return{totalRecords:b.length,success:true,records:b}}});Ext.namespace("GeoExt.form");GeoExt.form.SearchAction=Ext.extend(Ext.form.Action,{type:"search",response:null,constructor:function(b,a){GeoExt.form.SearchAction.superclass.constructor.call(this,b,a)},run:function(){var b=this.options;var a=GeoExt.form.toFilter(this.form);if(b.clientValidation===false||this.form.isValid()){if(b.abortPrevious&&this.form.prevResponse){b.protocol.abort(this.form.prevResponse)}this.form.prevResponse=b.protocol.read(Ext.applyIf({filter:a,callback:this.handleResponse,scope:this},b))}else{if(b.clientValidation!==false){this.failureType=Ext.form.Action.CLIENT_INVALID;this.form.afterAction(this,false)}}},handleResponse:function(a){this.form.prevResponse=null;this.response=a;if(a.success()){this.form.afterAction(this,true)}else{this.form.afterAction(this,false)}var b=this.options;if(b.callback){b.callback.call(b.scope,a)}}});Ext.namespace("GeoExt.data");GeoExt.data.FeatureRecord=Ext.data.Record.create([{name:"feature"},{name:"state"},{name:"fid"}]);GeoExt.data.FeatureRecord.create=function(e){var c=Ext.extend(GeoExt.data.FeatureRecord,{});var d=c.prototype;d.fields=new Ext.util.MixedCollection(false,function(f){return f.name});GeoExt.data.FeatureRecord.prototype.fields.each(function(g){d.fields.add(g)});if(e){for(var b=0,a=e.length;b<a;b++){d.fields.add(new Ext.data.Field(e[b]))}}c.getField=function(f){return d.fields.get(f)};return c};Ext.namespace("GeoExt");GeoExt.LegendWMS=Ext.extend(Ext.Panel,{imageFormat:"image/gif",defaultStyleIsFirst:true,layer:null,record:null,bodyBorder:false,initComponent:function(){GeoExt.LegendWMS.superclass.initComponent.call(this);if(!this.layer){this.layer=this.record.get("layer")}this.updateLegend()},getLegendUrl:function(d,g){var c;var f=this.record&&this.record.get("styles");g=g||(this.layer.params.LAYERS instanceof Array)?this.layer.params.LAYERS:this.layer.params.LAYERS.split(",");var b=this.layer.params.STYLES&&this.layer.params.STYLES.split(",");var a=g.indexOf(d);var e=b&&b[a];if(f&&f.length>0){if(e){Ext.each(f,function(h){c=(h.name==e&&h.legend)&&h.legend.href;return !c})}else{if(this.defaultStyleIsFirst===true&&!b&&!this.layer.params.SLD&&!this.layer.params.SLD_BODY){c=f[0].legend&&f[0].legend.href}}}return c||this.layer.getFullRequestString({REQUEST:"GetLegendGraphic",WIDTH:null,HEIGHT:null,EXCEPTIONS:"application/vnd.ogc.se_xml",LAYER:d,LAYERS:null,STYLE:(e!=="")?e:null,STYLES:null,SRS:null,FORMAT:this.imageFormat})},updateLegend:function(c){var h,b,d,a;h=(this.layer.params.LAYERS instanceof Array)?this.layer.params.LAYERS:this.layer.params.LAYERS.split(",");if(this.items){var e=[];this.items.each(function(i){d=h.indexOf(i.itemId);if(d<0){e.push(i)}else{b=h[d];var j=c||this.getLegendUrl(b,h);if(!OpenLayers.Util.isEquivalentUrl(j,i.url)){i.updateLegend(j)}}},this);for(d=0,a=e.length;d<a;d++){var g=e[d];this.remove(g);g.destroy()}}var f=false;for(d=0,a=h.length;d<a;d++){b=h[d];if(!this.items||!this.getComponent(b)){this.add({xtype:"gx_legendimage",url:c||this.getLegendUrl(b,h),itemId:b});f=true}}if(f){this.doLayout()}}});Ext.namespace("GeoExt.data");GeoExt.data.WMSDescribeLayerStore=function(a){a=a||{};GeoExt.data.WMSDescribeLayerStore.superclass.constructor.call(this,Ext.apply(a,{proxy:a.proxy||(!a.data?new Ext.data.HttpProxy({url:a.url,disableCaching:false,method:"GET"}):undefined),reader:new GeoExt.data.WMSDescribeLayerReader(a,a.fields)}))};Ext.extend(GeoExt.data.WMSDescribeLayerStore,Ext.data.Store);Ext.namespace("GeoExt");GeoExt.Popup=Ext.extend(Ext.Window,{anchored:true,map:null,panIn:true,unpinnable:true,feature:null,lonlat:null,animCollapse:false,draggable:false,shadow:false,popupCls:"gx-popup",ancCls:null,initComponent:function(){if(this.map instanceof GeoExt.MapPanel){this.map=this.map.map}if(!this.map&&this.feature&&this.feature.layer){this.map=this.feature.layer.map}if(!this.feature&&this.lonlat){this.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(this.lonlat.lon,this.lonlat.lat))}if(this.anchored){this.addAnchorEvents()}this.baseCls=this.popupCls+" "+this.baseCls;this.elements+=",anc";GeoExt.Popup.superclass.initComponent.call(this)},onRender:function(b,a){GeoExt.Popup.superclass.onRender.call(this,b,a);this.ancCls=this.popupCls+"-anc";this.createElement("anc",this.el.dom)},initTools:function(){if(this.unpinnable){this.addTool({id:"unpin",handler:this.unanchorPopup.createDelegate(this,[])})}GeoExt.Popup.superclass.initTools.call(this)},show:function(){GeoExt.Popup.superclass.show.apply(this,arguments);if(this.anchored){this.position();if(this.panIn&&!this._mapMove){this.panIntoView()}}},setSize:function(a,c){if(this.anc){var b=this.anc.getSize();if(typeof a=="object"){c=a.height-b.height;a=a.width}else{if(!isNaN(c)){c=c-b.height}}}GeoExt.Popup.superclass.setSize.call(this,a,c)},position:function(){var c=this.feature.geometry.getBounds().getCenterLonLat();if(this._mapMove===true){var g=this.map.getExtent().containsLonLat(c);if(g!==this.isVisible()){this.setVisible(g)}}if(this.isVisible()){var d=this.map.getViewPortPxFromLonLat(c);var f=Ext.fly(this.map.div).getBox();var e=this.anc;var b=e.getLeft(true)+e.getWidth()/2;var a=this.el.getHeight();this.setPosition(d.x+f.x-b,d.y+f.y-a)}},unanchorPopup:function(){this.removeAnchorEvents();this.draggable=true;this.header.addClass("x-window-draggable");this.dd=new Ext.Window.DD(this);this.anc.remove();this.anc=null;this.tools.unpin.hide()},panIntoView:function(){var g=this.feature.geometry.getBounds().getCenterLonLat();var a=this.map.getViewPortPxFromLonLat(g);var b=Ext.fly(this.map.div).getBox();var h=this.getPosition(true);h[0]-=b.x;h[1]-=b.y;var d=[b.width,b.height];var e=this.getSize();var c=[h[0],h[1]];var f=this.map.paddingForPopups;if(h[0]<f.left){c[0]=f.left}else{if(h[0]+e.width>d[0]-f.right){c[0]=d[0]-f.right-e.width}}if(h[1]<f.top){c[1]=f.top}else{if(h[1]+e.height>d[1]-f.bottom){c[1]=d[1]-f.bottom-e.height}}var j=h[0]-c[0];var i=h[1]-c[1];this.map.pan(j,i)},onMapMove:function(){this._mapMove=true;this.position();delete this._mapMove},addAnchorEvents:function(){this.map.events.on({move:this.onMapMove,scope:this});this.on({resize:this.position,collapse:this.position,expand:this.position,scope:this})},removeAnchorEvents:function(){this.map.events.un({move:this.onMapMove,scope:this});this.un("resize",this.position,this);this.un("collapse",this.position,this);this.un("expand",this.position,this)},beforeDestroy:function(){if(this.anchored){this.removeAnchorEvents()}GeoExt.Popup.superclass.beforeDestroy.call(this)}});Ext.reg("gx_popup",GeoExt.Popup);Ext.namespace("GeoExt.data");GeoExt.data.AttributeStore=function(a){a=a||{};GeoExt.data.AttributeStore.superclass.constructor.call(this,Ext.apply(a,{proxy:a.proxy||(!a.data?new Ext.data.HttpProxy({url:a.url,disableCaching:false,method:"GET"}):undefined),reader:new GeoExt.data.AttributeReader(a,a.fields||["name","type"])}))};Ext.extend(GeoExt.data.AttributeStore,Ext.data.Store);Ext.namespace("GeoExt.form");GeoExt.form.FormPanel=Ext.extend(Ext.form.FormPanel,{protocol:null,createForm:function(){delete this.initialConfig.listeners;return new GeoExt.form.BasicForm(null,this.initialConfig)},search:function(a){this.getForm().search(a)}});Ext.reg("gx_formpanel",GeoExt.form.FormPanel);Ext.namespace("GeoExt.data");GeoExt.data.WMCReader=function(a,b){a=a||{};if(!a.format){a.format=new OpenLayers.Format.WMC()}if(!(typeof b==="function")){b=GeoExt.data.LayerRecord.create(b||a.fields||[{name:"abstract",type:"string"},{name:"metadataURL",type:"string"},{name:"queryable",type:"boolean"},{name:"formats"},{name:"styles"}])}GeoExt.data.WMCReader.superclass.constructor.call(this,a,b)};Ext.extend(GeoExt.data.WMCReader,Ext.data.DataReader,{read:function(a){var b=a.responseXML;if(!b||!b.documentElement){b=a.responseText}return this.readRecords(b)},readRecords:function(f){var m=this.meta.format;if(typeof f==="string"||f.nodeType){f=m.read(f)}var p=f?f.layersContext:undefined;var a=[];if(p){var c=this.recordType,h=c.prototype.fields;var g,d,e,b,l,o,k,n;for(g=0,d=p.length;g<d;g++){l=p[g];o={};for(e=0,b=h.length;e<b;e++){k=h.items[e];n=l[k.mapping||k.name]||k.defaultValue;n=k.convert(n);o[k.name]=n}o.layer=m.getLayerFromContext(l);a.push(new this.recordType(o,o.layer.id))}}return{totalRecords:a.length,success:true,records:a}}});Ext.namespace("GeoExt.tree");GeoExt.tree.OverlayLayerContainer=Ext.extend(GeoExt.tree.LayerContainer,{constructor:function(a){a=Ext.applyIf(a||{},{text:"Overlays"});a.loader=Ext.applyIf(a.loader||{},{filter:function(b){var c=b.get("layer");return c.displayInLayerSwitcher===true&&c.isBaseLayer===false}});GeoExt.tree.OverlayLayerContainer.superclass.constructor.call(this,a)}});Ext.tree.TreePanel.nodeTypes.gx_overlaylayercontainer=GeoExt.tree.OverlayLayerContainer;Ext.namespace("GeoExt.data");GeoExt.data.WFSCapabilitiesReader=function(a,b){a=a||{};if(!a.format){a.format=new OpenLayers.Format.WFSCapabilities()}if(!(typeof b==="function")){b=GeoExt.data.LayerRecord.create(b||a.fields||[{name:"name",type:"string"},{name:"abstract",type:"string"}])}GeoExt.data.WFSCapabilitiesReader.superclass.constructor.call(this,a,b)};Ext.extend(GeoExt.data.WFSCapabilitiesReader,Ext.data.DataReader,{read:function(a){var b=a.responseXML;if(!b||!b.documentElement){b=a.responseText}return this.readRecords(b)},readRecords:function(f){if(typeof f==="string"||f.nodeType){f=this.meta.format.read(f)}var b=[],h,c,d,k,m;var a=f.featureTypeList.featureTypes;var g={url:f.capability.request.getfeature.href.post};for(var e=0,j=a.length;e<j;e++){h=a[e];if(h.name){d=h.name.split(":");if(d.length>1){m={featureType:d[1],featurePrefix:d[0]}}else{m={featureType:d[0],featurePrefix:null}}if(this.meta.protocolOptions){Ext.apply(m,this.meta.protocolOptions,g)}else{Ext.apply(m,{},g)}k={protocol:new OpenLayers.Protocol.WFS(m),strategies:[new OpenLayers.Strategy.Fixed()]};if(this.meta.layerOptions){Ext.apply(k,this.meta.layerOptions)}c=new OpenLayers.Layer.Vector(h.title||h.name,k);b.push(new this.recordType(Ext.apply(h,{layer:c}),c.id))}}return{totalRecords:b.length,success:true,records:b}}});Ext.namespace("GeoExt");GeoExt.Action=Ext.extend(Ext.Action,{control:null,map:null,uScope:null,uHandler:null,uToggleHandler:null,uCheckHandler:null,constructor:function(a){this.uScope=a.scope;this.uHandler=a.handler;this.uToggleHandler=a.toggleHandler;this.uCheckHandler=a.checkHandler;a.scope=this;a.handler=this.pHandler;a.toggleHandler=this.pToggleHandler;a.checkHandler=this.pCheckHandler;var b=this.control=a.control;delete a.control;if(b){if(a.map){a.map.addControl(b);delete a.map}if((a.pressed||a.checked)&&b.map){b.activate()}b.events.on({activate:this.onCtrlActivate,deactivate:this.onCtrlDeactivate,scope:this})}arguments.callee.superclass.constructor.call(this,a)},pHandler:function(a){var b=this.control;if(b&&b.type==OpenLayers.Control.TYPE_BUTTON){b.trigger()}if(this.uHandler){this.uHandler.apply(this.uScope,arguments)}},pToggleHandler:function(a,b){this.changeControlState(b);if(this.uToggleHandler){this.uToggleHandler.apply(this.uScope,arguments)}},pCheckHandler:function(a,b){this.changeControlState(b);if(this.uCheckHandler){this.uCheckHandler.apply(this.uScope,arguments)}},changeControlState:function(a){if(a){if(!this._activating){this._activating=true;this.control.activate();this._activating=false}}else{if(!this._deactivating){this._deactivating=true;this.control.deactivate();this._deactivating=false}}},onCtrlActivate:function(){var a=this.control;if(a.type==OpenLayers.Control.TYPE_BUTTON){this.enable()}else{this.safeCallEach("toggle",[true]);this.safeCallEach("setChecked",[true])}},onCtrlDeactivate:function(){var a=this.control;if(a.type==OpenLayers.Control.TYPE_BUTTON){this.disable()}else{this.safeCallEach("toggle",[false]);this.safeCallEach("setChecked",[false])}},safeCallEach:function(e,b){var d=this.items;for(var c=0,a=d.length;c<a;c++){if(d[c][e]){d[c][e].apply(d[c],b)}}}});Ext.namespace("GeoExt.form");GeoExt.form.toFilter=function(f,a){if(f instanceof Ext.form.FormPanel){f=f.getForm()}var e=[],b=f.getValues(false);for(var h in b){var d=h.split("__");var g=b[h],c;if(d.length>1&&(c=GeoExt.form.toFilter.FILTER_MAP[d[1]])!==undefined){h=d[0]}else{c=OpenLayers.Filter.Comparison.EQUAL_TO}e.push(new OpenLayers.Filter.Comparison({type:c,value:g,property:h}))}return new OpenLayers.Filter.Logical({type:a||OpenLayers.Filter.Logical.AND,filters:e})};GeoExt.form.toFilter.FILTER_MAP={eq:OpenLayers.Filter.Comparison.EQUAL_TO,ne:OpenLayers.Filter.Comparison.NOT_EQUAL_TO,lt:OpenLayers.Filter.Comparison.LESS_THAN,le:OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,gt:OpenLayers.Filter.Comparison.GREATER_THAN,ge:OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,like:OpenLayers.Filter.Comparison.LIKE};Ext.namespace("GeoExt.tree");GeoExt.tree.LayerNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{radio:null,constructor:function(a){GeoExt.tree.LayerNodeUI.superclass.constructor.apply(this,arguments)},render:function(d){var c=this.node.attributes;if(c.checked===undefined){c.checked=this.node.layer.getVisibility()}GeoExt.tree.LayerNodeUI.superclass.render.apply(this,arguments);var b=this.checkbox;if(c.radioGroup&&this.radio===null){this.radio=Ext.DomHelper.insertAfter(b,['<input type="radio" class="gx-tree-layer-radio" name="',c.radioGroup,'_radio"></input>'].join(""))}if(c.checkedGroup){var e=Ext.DomHelper.insertAfter(b,['<input type="radio" name="',c.checkedGroup,'_checkbox" class="',b.className,b.checked?'" checked="checked"':"",'"></input>'].join(""));e.defaultChecked=b.defaultChecked;Ext.get(b).remove();this.checkbox=e}this.enforceOneVisible()},onClick:function(a){if(a.getTarget(".gx-tree-layer-radio",1)){this.radio.defaultChecked=this.radio.checked;this.fireEvent("radiochange",this.node)}else{if(a.getTarget(".x-tree-node-cb",1)){this.onCheckChange()}else{GeoExt.tree.LayerNodeUI.superclass.onClick.apply(this,arguments)}}},toggleCheck:function(a){if(!this._visibilityChanging){this._visibilityChanging=true;a=(a===undefined?!this.isChecked():a)||(this.isChecked()&&!!this.node.attributes.checkedGroup);GeoExt.tree.LayerNodeUI.superclass.toggleCheck.call(this,a);this.enforceOneVisible();delete this._visibilityChanging}},enforceOneVisible:function(){var b=this.node.attributes;var f=b.checkedGroup;if(f){var d=this.node.layer;var a=this.node.getOwnerTree().getChecked();var c=0;Ext.each(a,function(i){var h=i.getUI();var g=i.layer;if(!i.hidden&&i.attributes.checkedGroup===f){c++;if(g!=d&&b.checked){h.checkbox.defaultChecked=false;h.checkbox.checked=false;g.setVisibility(false)}}});if(c===0&&b.checked==false){var e=this.node.getUI();e.checkbox.defaultChecked=true;e.checkbox.checked=true;d.setVisibility(true)}}},appendDDGhost:function(c){var b=this.elNode.cloneNode(true);var a=Ext.DomQuery.select("input[type='radio']",b);Ext.each(a,function(d){d.name=d.name+"_clone"});c.appendChild(b)},destroy:function(){delete this.radio;GeoExt.tree.LayerNodeUI.superclass.destroy.apply(this,arguments)}});GeoExt.tree.LayerNode=Ext.extend(Ext.tree.AsyncTreeNode,{layer:null,layerStore:null,constructor:function(a){a.leaf=a.leaf||!(a.children||a.loader);if(!a.iconCls&&!a.children){a.iconCls="gx-tree-layer-icon"}if(a.loader&&!(a.loader instanceof Ext.tree.TreeLoader)){a.loader=new GeoExt.tree.LayerParamLoader(a.loader)}this.defaultUI=this.defaultUI||GeoExt.tree.LayerNodeUI;this.addEvents("radiochange");Ext.apply(this,{layer:a.layer,layerStore:a.layerStore});if(a.text){this.fixedText=true}GeoExt.tree.LayerNode.superclass.constructor.apply(this,arguments)},render:function(a){var c=this.layer instanceof OpenLayers.Layer&&this.layer;if(!c){if(!this.layerStore||this.layerStore=="auto"){this.layerStore=GeoExt.MapPanel.guess().layers}var b=this.layerStore.findBy(function(e){return e.get("title")==this.layer},this);if(b!=-1){c=this.layerStore.getAt(b).get("layer")}}if(!this.rendered||!c){var d=this.getUI();if(c){this.layer=c;if(c.isBaseLayer){this.draggable=false;Ext.applyIf(this.attributes,{checkedGroup:"gx_baselayer"})}if(!this.text){this.text=c.name}d.show();this.addVisibilityEventHandlers()}else{d.hide()}if(this.layerStore instanceof GeoExt.data.LayerStore){this.addStoreEventHandlers(c)}}GeoExt.tree.LayerNode.superclass.render.apply(this,arguments)},addVisibilityEventHandlers:function(){this.layer.events.on({visibilitychanged:this.onLayerVisibilityChanged,scope:this});this.on({checkchange:this.onCheckChange,scope:this})},onLayerVisibilityChanged:function(){this.getUI().toggleCheck(this.layer.getVisibility())},onCheckChange:function(c,b){if(b!=this.layer.getVisibility()){var a=this.layer;if(b&&a.isBaseLayer&&a.map){a.map.setBaseLayer(a)}else{a.setVisibility(b)}}},addStoreEventHandlers:function(){this.layerStore.on({add:this.onStoreAdd,remove:this.onStoreRemove,update:this.onStoreUpdate,scope:this})},onStoreAdd:function(c,b,d){var a;for(var e=0;e<b.length;++e){a=b[e].get("layer");if(this.layer==a){this.getUI().show();break}else{if(this.layer==a.name){this.render();break}}}},onStoreRemove:function(b,a,c){if(this.layer==a.get("layer")){this.getUI().hide()}},onStoreUpdate:function(c,a,b){var d=a.get("layer");if(!this.fixedText&&(this.layer==d&&this.text!==d.name)){this.setText(d.name)}},destroy:function(){var b=this.layer;if(b instanceof OpenLayers.Layer){b.events.un({visibilitychanged:this.onLayerVisibilityChanged,scope:this})}delete this.layer;var a=this.layerStore;if(a){a.un("add",this.onStoreAdd,this);a.un("remove",this.onStoreRemove,this);a.un("update",this.onStoreUpdate,this)}delete this.layerStore;this.un("checkchange",this.onCheckChange,this);GeoExt.tree.LayerNode.superclass.destroy.apply(this,arguments)}});Ext.tree.TreePanel.nodeTypes.gx_layer=GeoExt.tree.LayerNode;Ext.namespace("GeoExt.tree");GeoExt.tree.LayerParamNode=Ext.extend(Ext.tree.TreeNode,{layer:null,param:null,item:null,delimiter:null,allItems:null,constructor:function(a){var b=a||{};b.iconCls=b.iconCls||"gx-tree-layerparam-icon";b.text=b.text||b.item;typeof b.layer=="string"?false:b.layer.getVisibility();this.param=b.param;this.item=b.item;this.delimiter=b.delimiter||",";GeoExt.tree.LayerParamNode.superclass.constructor.apply(this,arguments)},render:function(a){var d=this.attributes.layer;if(typeof d=="string"){var b=this.attributes.layerStore||GeoExt.MapPanel.guess().layers;var c=b.findBy(function(e){return e.get("title")==d});d=b.getAt(c).get("layer")}this.layer=d;this.allItems=this.getItems();this.attributes.checked=d.getVisibility();this.addVisibilityEventHandlers();GeoExt.tree.LayerParamNode.superclass.render.apply(this,arguments)},getItems:function(){var a=this.layer.params[this.param];return a instanceof Array?a:(a?a.split(this.delimiter):[])},createParams:function(a){var b={};b[this.param]=this.layer.params[this.param] instanceof Array?a:a.join(this.delimiter);return b},addVisibilityEventHandlers:function(){this.layer.events.on({visibilitychanged:this.onLayerVisibilityChanged,scope:this});this.on({checkchange:this.onCheckChange,scope:this})},onLayerVisibilityChanged:function(){if(this.getItems().length===0){this.layer.mergeNewParams(this.createParams(this.allItems))}var a=this.layer.getVisibility();if(a&&this.getItems().indexOf(this.item)!==-1){this.getUI().toggleCheck(true)}if(!a){this.layer.mergeNewParams(this.createParams([]));this.getUI().toggleCheck(false)}},onCheckChange:function(e,d){var c=this.layer;var b=[];var a=this.getItems();if(d===true&&c.getVisibility()===false&&a.length===this.allItems.length){a=[]}Ext.each(this.allItems,function(g){if((g!==this.item&&a.indexOf(g)!==-1)||(d===true&&g===this.item)){b.push(g)}},this);var f=(b.length>0);f&&c.mergeNewParams(this.createParams(b));if(f!==c.getVisibility()){c.setVisibility(f)}(!f)&&c.mergeNewParams(this.createParams([]))},destroy:function(){var a=this.layer;if(a instanceof OpenLayers.Layer){a.events.un({visibilitychanged:this.onLayerVisibilityChanged,scope:this})}delete this.layer;this.un("checkchange",this.onCheckChange,this);GeoExt.tree.LayerNode.superclass.destroy.apply(this,arguments)}});Ext.tree.TreePanel.nodeTypes.gx_layerparam=GeoExt.tree.LayerParamNode;Ext.namespace("GeoExt");GeoExt.LegendImage=Ext.extend(Ext.BoxComponent,{url:null,defaultImgSrc:null,imgCls:null,initComponent:function(){GeoExt.LegendImage.superclass.initComponent.call(this);if(this.defaultImgSrc===null){this.defaultImgSrc=Ext.BLANK_IMAGE_URL}this.autoEl={tag:"img","class":(this.imgCls?this.imgCls:""),src:this.defaultImgSrc}},updateLegend:function(a){this.url=a;var b=this.getEl();if(b){b.un("error",this.onImageLoadError,this);b.on("error",this.onImageLoadError,this,{single:true});b.dom.src=a}},onRender:function(b,a){GeoExt.LegendImage.superclass.onRender.call(this,b,a);if(this.url){this.updateLegend(this.url)}},onDestroy:function(){var a=this.getEl();if(a){a.un("error",this.onImageLoadError,this)}GeoExt.LegendImage.superclass.onDestroy.apply(this,arguments)},onImageLoadError:function(){this.getEl().dom.src=this.defaultImgSrc}});Ext.reg("gx_legendimage",GeoExt.LegendImage);Ext.namespace("GeoExt");GeoExt.LayerOpacitySlider=Ext.extend(Ext.Slider,{layer:null,complementaryLayer:null,delay:5,changeVisibilityDelay:5,aggressive:false,changeVisibility:false,value:null,constructor:function(a){if(a.layer){if(a.layer instanceof OpenLayers.Layer){this.layer=a.layer}else{if(a.layer instanceof GeoExt.data.LayerRecord){this.layer=a.layer.get("layer")}}if(a.complementaryLayer instanceof OpenLayers.Layer){this.complementaryLayer=a.complementaryLayer}else{if(a.complementaryLayer instanceof GeoExt.data.LayerRecord){this.complementaryLayer=a.complementaryLayer.get("layer")}}delete a.layer;delete a.complementaryLayer}GeoExt.LayerOpacitySlider.superclass.constructor.call(this,a)},initComponent:function(){if(this.layer&&this.layer.opacity!==null){this.value=parseInt(this.layer.opacity*(this.maxValue-this.minValue))}else{if(this.value==null){this.value=this.maxValue}}GeoExt.LayerOpacitySlider.superclass.initComponent.call(this);if(this.changeVisibility&&this.layer&&(this.layer.opacity==0||this.value==this.minValue)){this.layer.setVisibility(false)}if(this.complementaryLayer&&((this.layer&&this.layer.opacity==1)||(this.value==this.maxValue))){this.complementaryLayer.setVisibility(false)}if(this.aggressive===true){this.on("change",this.changeLayerOpacity,this,{buffer:this.delay})}else{this.on("changecomplete",this.changeLayerOpacity,this)}if(this.changeVisibility===true){this.on("change",this.changeLayerVisibility,this,{buffer:this.changeVisibilityDelay})}if(this.complementaryLayer){this.on("change",this.changeComplementaryLayerVisibility,this,{buffer:this.changeVisibilityDelay})}},changeLayerOpacity:function(a,b){if(this.layer){this.layer.setOpacity(b/100)}},changeLayerVisibility:function(b,c){var a=this.layer.getVisibility();if(c==this.minValue&&a===true){this.layer.setVisibility(false)}else{if(c>this.minValue&&a==false){this.layer.setVisibility(true)}}},changeComplementaryLayerVisibility:function(b,c){var a=this.complementaryLayer.getVisibility();if(c==this.maxValue&&a===true){this.complementaryLayer.setVisibility(false)}else{if(c<this.maxValue&&a==false){this.complementaryLayer.setVisibility(true)}}},addToMapPanel:function(a){this.on({render:function(){var b=this.getEl();b.setStyle({position:"absolute",zIndex:a.map.Z_INDEX_BASE.Control});b.on({mousedown:this.stopMouseEvents,click:this.stopMouseEvents})},scope:this})},removeFromMapPanel:function(a){var b=this.getEl();b.un({mousedown:this.stopMouseEvents,click:this.stopMouseEvents,scope:this})},stopMouseEvents:function(a){a.stopEvent()}});Ext.reg("gx_opacityslider",GeoExt.LayerOpacitySlider);Ext.namespace("GeoExt.data");GeoExt.data.AttributeReader=function(a,b){a=a||{};if(!a.format){a.format=new OpenLayers.Format.WFSDescribeFeatureType()}GeoExt.data.AttributeReader.superclass.constructor.call(this,a,b||a.fields)};Ext.extend(GeoExt.data.AttributeReader,Ext.data.DataReader,{read:function(a){var b=a.responseXML;if(!b||!b.documentElement){b=a.responseText}return this.readRecords(b)},readRecords:function(h){var e;if(h instanceof Array){e=h}else{e=this.meta.format.read(h).featureTypes[0].properties}var c=this.recordType;var m=c.prototype.fields;var f=m.length;var o,r,a,l,p,k,q,b=[];for(var g=0,n=e.length;g<n;++g){p=false;o=e[g];r={};for(var d=0;d<f;++d){a=m.items[d].name;q=o[a];if(this.meta.ignore&&this.meta.ignore[a]){k=this.meta.ignore[a];if(typeof k=="string"){p=(k===q)}else{if(k instanceof Array){p=(k.indexOf(q)>-1)}else{if(k instanceof RegExp){p=(k.test(q))}}}if(p){break}}r[a]=o[a]}if(!p){b[b.length]=new c(r)}}return{success:true,records:b,totalRecords:b.length}}});Ext.namespace("GeoExt");GeoExt.ZoomSliderTip=Ext.extend(GeoExt.SliderTip,{template:"<div>Zoom Level: {zoom}</div><div>Resolution: {resolution}</div><div>Scale: 1 : {scale}</div>",compiledTemplate:null,init:function(a){this.compiledTemplate=new Ext.Template(this.template);GeoExt.ZoomSliderTip.superclass.init.call(this,a)},getText:function(a){var b={zoom:a.getZoom(),resolution:a.getResolution(),scale:Math.round(a.getScale())};return this.compiledTemplate.apply(b)}});Ext.namespace("GeoExt.data");GeoExt.data.ScaleStore=Ext.extend(Ext.data.Store,{map:null,constructor:function(a){var b=(a.map instanceof GeoExt.MapPanel?a.map.map:a.map);delete a.map;a=Ext.applyIf(a,{reader:new Ext.data.JsonReader({},["level","resolution","scale"])});GeoExt.data.ScaleStore.superclass.constructor.call(this,a);if(b){this.bind(b)}},bind:function(b,a){this.map=(b instanceof GeoExt.MapPanel?b.map:b);this.map.events.register("changebaselayer",this,this.populateFromMap);if(this.map.baseLayer){this.populateFromMap()}else{this.map.events.register("addlayer",this,this.populateOnAdd)}},unbind:function(){if(this.map){this.map.events.unregister("addlayer",this,this.populateOnAdd);this.map.events.unregister("changebaselayer",this,this.populateFromMap);delete this.map}},populateOnAdd:function(a){if(a.layer.isBaseLayer){this.populateFromMap();this.map.events.unregister("addlayer",this,this.populateOnAdd)}},populateFromMap:function(){var c=[];var a=this.map.baseLayer.resolutions;var b=this.map.baseLayer.units;for(var e=a.length-1;e>=0;e--){var d=a[e];c.push({level:e,resolution:d,scale:OpenLayers.Util.getScaleFromResolution(d,b)})}this.loadData(c)}});Ext.namespace("GeoExt.data");GeoExt.data.FeatureStoreMixin={layer:null,reader:null,addFeatureFilter:null,addRecordFilter:null,constructor:function(b){b=b||{};b.reader=b.reader||new GeoExt.data.FeatureReader({},b.fields);var c=b.layer;delete b.layer;if(b.features){b.data=b.features}delete b.features;var a={initDir:b.initDir};delete b.initDir;arguments.callee.superclass.constructor.call(this,b);if(c){this.bind(c,a)}},bind:function(d,b){if(this.layer){return}this.layer=d;b=b||{};var f=b.initDir;if(b.initDir==undefined){f=GeoExt.data.FeatureStore.LAYER_TO_STORE|GeoExt.data.FeatureStore.STORE_TO_LAYER}var e=d.features.slice(0);if(f&GeoExt.data.FeatureStore.STORE_TO_LAYER){var a=this.getRange();for(var c=a.length-1;c>=0;c--){this.layer.addFeatures([a[c].get("feature")])}}if(f&GeoExt.data.FeatureStore.LAYER_TO_STORE){this.loadData(e,true)}d.events.on({featuresadded:this.onFeaturesAdded,featuresremoved:this.onFeaturesRemoved,featuremodified:this.onFeatureModified,scope:this});this.on({load:this.onLoad,clear:this.onClear,add:this.onAdd,remove:this.onRemove,update:this.onUpdate,scope:this})},unbind:function(){if(this.layer){this.layer.events.un({featuresadded:this.onFeaturesAdded,featuresremoved:this.onFeaturesRemoved,featuremodified:this.onFeatureModified,scope:this});this.un("load",this.onLoad,this);this.un("clear",this.onClear,this);this.un("add",this.onAdd,this);this.un("remove",this.onRemove,this);this.un("update",this.onUpdate,this);this.layer=null}},getRecordFromFeature:function(c){var a=null;if(c.state!==OpenLayers.State.INSERT){a=this.getById(c.id)}else{var b=this.findBy(function(d){return d.get("feature")===c});if(b>-1){a=this.getAt(b)}}return a},onFeaturesAdded:function(b){if(!this._adding){var f=b.features,e=f;if(typeof this.addFeatureFilter=="function"){e=[];var d,a,c;for(var d=0,a=f.length;d<a;d++){c=f[d];if(this.addFeatureFilter(c)!==false){e.push(c)}}}this._adding=true;this.loadData(e,true);delete this._adding}},onFeaturesRemoved:function(b){if(!this._removing){var e=b.features,d,a,c;for(c=e.length-1;c>=0;c--){d=e[c];a=this.getRecordFromFeature(d);if(a!==undefined){this._removing=true;this.remove(a);delete this._removing}}}},onFeatureModified:function(d){if(!this._updating){var g=d.feature;var c=this.getRecordFromFeature(g);if(c!==undefined){c.beginEdit();attributes=g.attributes;if(attributes){var b=this.recordType.prototype.fields;for(var f=0,a=b.length;f<a;f++){var h=b.items[f];var e=h.mapping||h.name;if(e in attributes){c.set(h.name,h.convert(attributes[e]))}}}c.set("state",g.state);c.set("fid",g.fid);c.data.feature=g;this._updating=true;c.endEdit();delete this._updating}}},addFeaturesToLayer:function(c){var d,a,e,b;if(typeof this.addRecordFilter=="function"){e=[];for(d=0,a=c.length;d<a;d++){b=c[d];if(this.addRecordFilter(b)!==false){e.push(b.get("feature"))}}}else{e=new Array((a=c.length));for(d=0;d<a;d++){e[d]=c[d].get("feature")}}if(e.length>0){this._adding=true;this.layer.addFeatures(e);delete this._adding}},onLoad:function(b,a,c){if(!c||c.add!==true){this._removing=true;this.layer.removeFeatures(this.layer.features);delete this._removing;this.addFeaturesToLayer(a)}},onClear:function(a){this._removing=true;this.layer.removeFeatures(this.layer.features);delete this._removing},onAdd:function(b,a,c){if(!this._adding){this.addFeaturesToLayer(a)}},onRemove:function(b,a,c){if(!this._removing){var d=a.get("feature");if(this.layer.getFeatureById(d.id)!=null){this._removing=true;this.layer.removeFeatures([a.get("feature")]);delete this._removing}}},onUpdate:function(e,b,d){if(!this._updating){var g=new GeoExt.data.FeatureRecord().fields;var f=b.get("feature");if(b.fields){var a=this.layer.events.triggerEvent("beforefeaturemodified",{feature:f});if(a!==false){var c=f.attributes;b.fields.each(function(i){var h=i.mapping||i.name;if(!g.containsKey(h)){c[h]=b.get(i.name)}});this._updating=true;this.layer.events.triggerEvent("featuremodified",{feature:f});delete this._updating;if(this.layer.getFeatureById(f.id)!=null){this.layer.drawFeature(f)}}}}}};GeoExt.data.FeatureStore=Ext.extend(Ext.data.Store,GeoExt.data.FeatureStoreMixin);GeoExt.data.FeatureStore.LAYER_TO_STORE=1;GeoExt.data.FeatureStore.STORE_TO_LAYER=2;Ext.namespace("GeoExt.data");GeoExt.data.WFSCapabilitiesStore=function(a){a=a||{};GeoExt.data.WFSCapabilitiesStore.superclass.constructor.call(this,Ext.apply(a,{proxy:a.proxy||(!a.data?new Ext.data.HttpProxy({url:a.url,disableCaching:false,method:"GET"}):undefined),reader:new GeoExt.data.WFSCapabilitiesReader(a,a.fields)}))};Ext.extend(GeoExt.data.WFSCapabilitiesStore,Ext.data.Store);Ext.namespace("GeoExt");GeoExt.MapPanel=Ext.extend(Ext.Panel,{map:null,layers:null,center:null,zoom:null,extent:null,initComponent:function(){if(!(this.map instanceof OpenLayers.Map)){this.map=new OpenLayers.Map(Ext.applyIf(this.map||{},{allOverlays:true}))}var a=this.layers;if(!a||a instanceof Array){this.layers=new GeoExt.data.LayerStore({layers:a,map:this.map})}if(typeof this.center=="string"){this.center=OpenLayers.LonLat.fromString(this.center)}else{if(this.center instanceof Array){this.center=new OpenLayers.LonLat(this.center[0],this.center[1])}}if(typeof this.extent=="string"){this.extent=OpenLayers.Bounds.fromString(this.extent)}else{if(this.extent instanceof Array){this.extent=OpenLayers.Bounds.fromArray(this.extent)}}GeoExt.MapPanel.superclass.initComponent.call(this)},updateMapSize:function(){if(this.map){this.map.updateSize()}},renderMap:function(){var a=this.map;a.render(this.body.dom);if(a.layers.length>0){if(this.center||this.zoom!=null){a.setCenter(this.center,this.zoom)}else{if(this.extent){a.zoomToExtent(this.extent)}else{a.zoomToMaxExtent()}}}},afterRender:function(){GeoExt.MapPanel.superclass.afterRender.apply(this,arguments);if(!this.ownerCt){this.renderMap()}else{this.ownerCt.on("move",this.updateMapSize,this);this.ownerCt.on({afterlayout:{fn:this.renderMap,scope:this,single:true}})}},onResize:function(){GeoExt.MapPanel.superclass.onResize.apply(this,arguments);this.updateMapSize()},onBeforeAdd:function(a){if(typeof a.addToMapPanel==="function"){a.addToMapPanel(this)}GeoExt.MapPanel.superclass.onBeforeAdd.apply(this,arguments)},remove:function(b,a){if(typeof b.removeFromMapPanel==="function"){b.removeFromMapPanel(this)}GeoExt.MapPanel.superclass.remove.apply(this,arguments)},beforeDestroy:function(){if(this.ownerCt){this.ownerCt.un("move",this.updateMapSize,this)}if(!this.initialConfig.map||!(this.initialConfig.map instanceof OpenLayers.Map)){if(this.map&&this.map.destroy){this.map.destroy()}}delete this.map;GeoExt.MapPanel.superclass.beforeDestroy.apply(this,arguments)}});GeoExt.MapPanel.guess=function(){return Ext.ComponentMgr.all.find(function(a){return a instanceof GeoExt.MapPanel})};Ext.reg("gx_mappanel",GeoExt.MapPanel);Ext.namespace("GeoExt","GeoExt.data");GeoExt.data.ProtocolProxy=function(a){Ext.apply(this,a);GeoExt.data.ProtocolProxy.superclass.constructor.apply(this,arguments)};Ext.extend(GeoExt.data.ProtocolProxy,Ext.data.DataProxy,{protocol:null,abortPrevious:true,response:null,load:function(g,c,h,e,b){if(this.fireEvent("beforeload",this,g)!==false){var f={params:g||{},request:{callback:h,scope:e,arg:b},reader:c};var a=OpenLayers.Function.bind(this.loadResponse,this,f);if(this.abortPrevious){this.abortRequest()}var d={params:g,callback:a,scope:this};Ext.applyIf(d,b);this.response=this.protocol.read(d)}else{h.call(e||this,null,b,false)}},abortRequest:function(){if(this.response){this.protocol.abort(this.response);this.response=null}},loadResponse:function(c,b){if(b.success()){var a=c.reader.read(b);this.fireEvent("load",this,c,c.request.arg);c.request.callback.call(c.request.scope,a,c.request.arg,true)}else{this.fireEvent("loadexception",this,c,b);c.request.callback.call(c.request.scope,null,c.request.arg,false)}}});(function(){var a=function(c,b){return function(d){if(b&&b[c]){b[c].call(b.scope||window,{responseText:d.responseText,responseXML:d.responseXML,argument:b.argument})}}};Ext.apply(Ext.lib.Ajax,{request:function(g,e,b,f,c){c=c||{};var d=c.headers;if(c.xmlData){if(!d||!d["Content-Type"]){d=d||{};d["Content-Type"]="text/xml"}g=(g?g:(c.method?c.method:"POST"));f=c.xmlData}else{if(c.jsonData){if(!d||!d["Content-Type"]){d=d||{};d["Content-Type"]="application/json"}g=(g?g:(c.method?c.method:"POST"));f=typeof c.jsonData=="object"?Ext.encode(c.jsonData):c.jsonData}}return OpenLayers.Request.issue({success:a("success",b),failure:a("failure",b),headers:c.headers,method:g,headers:d,data:f,url:e})},isCallInProgress:function(b){return true},abort:function(b){b.abort()}})})();Ext.namespace("GeoExt");GeoExt.LegendPanel=Ext.extend(Ext.Panel,{dynamic:true,showTitle:true,labelCls:null,bodyStyle:"",layerStore:null,filter:function(a){return true},initComponent:function(){GeoExt.LegendPanel.superclass.initComponent.call(this)},onRender:function(){GeoExt.LegendPanel.superclass.onRender.apply(this,arguments);if(!this.layerStore){this.layerStore=GeoExt.MapPanel.guess().layers}this.layerStore.each(function(a){this.addLegend(a)},this);if(this.dynamic){this.layerStore.on({add:this.onStoreAdd,remove:this.onStoreRemove,update:this.onStoreUpdate,scope:this})}this.doLayout()},recordIndexToPanelIndex:function(b){var a=this.layerStore;var f=a.getCount();var g=-1;var h=this.items?this.items.length:0;for(var d=f-1;d>=0;--d){var c=a.getAt(d).get("layer");var e=GeoExt["Legend"+c.CLASS_NAME.split(".").pop()];if(c.displayInLayerSwitcher&&e&&(a.getAt(d).get("hideInLegend")!==true)){++g;if(b===d||g>h-1){break}}}return g},onStoreUpdate:function(c,a,b){var e=a.get("layer");var f=this.items?this.getComponent(e.id):null;if((this.showTitle&&!a.get("hideTitle"))&&(f&&f.items.get(0).text!==a.get("title"))){f.items.get(0).setText(a.get("title"))}if(f){f.setVisible(e.getVisibility()&&e.displayInLayerSwitcher&&!a.get("hideInLegend"));var d=a.get("legendURL")!=null?a.get("legendURL"):undefined;f.items.get(1).updateLegend(d)}},onStoreAdd:function(c,b,d){var f=this.recordIndexToPanelIndex(d+b.length-1);for(var e=0,a=b.length;e<a;e++){this.addLegend(b[e],f)}this.doLayout()},onStoreRemove:function(b,a,c){this.removeLegend(a)},removeLegend:function(a){var b=this.getComponent(a.get("layer").id);if(b){this.remove(b,true);this.doLayout()}},createLegendSubpanel:function(a){var b=a.get("layer");var e=this.createMainPanel(a);if(e!==null){var d;if(a.get("legendURL")){d=new GeoExt.LegendImage({url:a.get("legendURL")});e.add(d)}else{var c=GeoExt["Legend"+b.CLASS_NAME.split(".").pop()];if(c){d=new c(Ext.applyIf({layer:b,record:a},this.legendOptions));e.add(d)}}}return e},addLegend:function(a,b){if(this.filter(a)===true){b=b||0;var c=a.get("layer");var d=this.createLegendSubpanel(a);if(d!==null){d.setVisible(c.getVisibility());this.insert(b,d)}}},createMainPanel:function(b){var c=b.get("layer");var a=null;var d=GeoExt["Legend"+c.CLASS_NAME.split(".").pop()];if(c.displayInLayerSwitcher&&!b.get("hideInLegend")&&d){var e={id:c.id,border:false,bodyBorder:false,bodyStyle:this.bodyStyle,items:[new Ext.form.Label({text:(this.showTitle&&!b.get("hideTitle"))?c.name:"",cls:"x-form-item x-form-item-label"+(this.labelCls?" "+this.labelCls:"")})]};a=new Ext.Panel(e)}return a},onDestroy:function(){if(this.layerStore){this.layerStore.un("add",this.onStoreAdd,this);this.layerStore.un("remove",this.onStoreRemove,this);this.layerStore.un("update",this.onStoreUpdate,this)}GeoExt.LegendPanel.superclass.onDestroy.apply(this,arguments)}});Ext.reg("gx_legendpanel",GeoExt.LegendPanel);Ext.namespace("GeoExt.data");GeoExt.data.WMSCapabilitiesStore=function(a){a=a||{};GeoExt.data.WMSCapabilitiesStore.superclass.constructor.call(this,Ext.apply(a,{proxy:a.proxy||(!a.data?new Ext.data.HttpProxy({url:a.url,disableCaching:false,method:"GET"}):undefined),reader:new GeoExt.data.WMSCapabilitiesReader(a,a.fields)}))};Ext.extend(GeoExt.data.WMSCapabilitiesStore,Ext.data.Store);Ext.namespace("GeoExt");GeoExt.LayerOpacitySliderTip=Ext.extend(GeoExt.SliderTip,{template:"<div>{opacity}%</div>",compiledTemplate:null,init:function(a){this.compiledTemplate=new Ext.Template(this.template);GeoExt.LayerOpacitySliderTip.superclass.init.call(this,a)},getText:function(a){var b={opacity:a.getValue()};return this.compiledTemplate.apply(b)}});GeoExt.VERSION_NUMBER="release-0.6";