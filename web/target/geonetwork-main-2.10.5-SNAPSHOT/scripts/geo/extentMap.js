var extentMap={map:null,maps:new Array(),vectorLayer:null,vectorLayerStyle:OpenLayers.Feature.Vector.style["default"],targetPolygon:null,watchedBbox:null,mode:null,edit:null,eltRef:null,digits:5,MultiPolygonReference:OpenLayers.Class(OpenLayers.Geometry,{id:null,initialize:function(a){this.id=a},CLASS_NAME:"extentMap.MultiPolygonReference"}),mainProjCode:"EPSG:4326",wgsProj:new OpenLayers.Projection("EPSG:4326"),mainProj:null,units:"m",alternateProj:null,initMapDiv:function(){var l,c;extentMap.mainProj=new OpenLayers.Projection(extentMap.mainProjCode);extentMap.alternateProj=extentMap.mainProj;if(Ext){l=Ext.DomQuery.select(".extentViewer");c=Ext.id}else{l=$$(".extentViewer");c=identify()}for(var m=0;m<l.length;++m){var j=l[m];extentMap.targetPolygon=j.getAttribute("target_polygon");extentMap.watchedBbox=j.getAttribute("watched_bbox");extentMap.edit=j.getAttribute("edit")=="true";extentMap.eltRef=j.getAttribute("elt_ref");extentMap.mode=j.getAttribute("mode");var d=j.childNodes;var g=[];for(var h=0;h<d.length;h++){if(d[h].nodeType==1){g.push(d[h])}}d=g;if(d.length>1){continue}var b;if(Ext){b=Ext.id(j)}else{b=j.identify()}var a=extentMap.createMap();extentMap.maps[extentMap.eltRef]=a;if(extentMap.edit){var k=[],f;if(extentMap.mode=="bbox"){f=new OpenLayers.Control.DrawFeature(extentMap.vectorLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{irregular:true,sides:4},featureAdded:function(o){var q=o.geometry.getBounds();var p=q.clone().transform(extentMap.mainProj,extentMap.wgsProj);var n=this.watchedBbox.split(",");Ext.get("_"+n[0]).dom.value=p.left;Ext.get("_"+n[1]).dom.value=p.bottom;Ext.get("_"+n[2]).dom.value=p.right;Ext.get("_"+n[3]).dom.value=p.top;extentMap.watchRadios(this.watchedBbox,this.eltRef)}.bind({watchedBbox:extentMap.watchedBbox,eltRef:extentMap.eltRef})});k.push(new GeoExt.Action({map:a,control:f,text:translate("drawRectangle"),pressed:false,allowDepress:true,toggleGroup:"tool",iconCls:"drawRectangle"}))}if(extentMap.mode=="polygon"){f=new OpenLayers.Control.DrawFeature(extentMap.vectorLayer,OpenLayers.Handler.Polygon,{featureAdded:function(n){document.getElementById("_X"+this).value=extentMap.convertToGml(n,extentMap.mainProjCode)}.bind(extentMap.targetPolygon)});k.push(new GeoExt.Action({map:a,control:f,text:translate("drawPolygon"),pressed:false,allowDepress:true,toggleGroup:"tool",iconCls:"drawPolygon"}));f=new OpenLayers.Control.DrawFeature(extentMap.vectorLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{irregular:true,sides:60},featureAdded:function(n){document.getElementById("_X"+this).value=extentMap.convertToGml(n,extentMap.mainProjCode)}.bind(extentMap.targetPolygon)});k.push(new GeoExt.Action({map:a,control:f,text:translate("drawCircle"),pressed:false,allowDepress:true,toggleGroup:"tool",iconCls:"drawCircle"}))}k.push({text:translate("clear"),iconCls:"clearPolygon",handler:function(){this.vectorLayer.destroyFeatures();var o=document.getElementById("_X"+this.targetPolygon);if(o!=null){o.value=""}if(this.targetBbox!=""){var n=this.targetBbox.split(",");Ext.get(n[0]).dom.value="";Ext.get(n[1]).dom.value="";Ext.get(n[2]).dom.value="";Ext.get(n[3]).dom.value="";Ext.get("_"+n[0]).dom.value="";Ext.get("_"+n[1]).dom.value="";Ext.get("_"+n[2]).dom.value="";Ext.get("_"+n[3]).dom.value="";$(n[0]).onkeyup();$(n[1]).onkeyup();$(n[2]).onkeyup();$(n[3]).onkeyup()}},scope:{vectorLayer:extentMap.vectorLayer,targetPolygon:extentMap.targetPolygon,targetBbox:extentMap.watchedBbox,eltRef:extentMap.eltRef}})}var e=new GeoExt.MapPanel({renderTo:b,height:300,width:600,map:a,tbar:(extentMap.edit?k:null)});if(d.length>0){extentMap.readFeature(d[0].innerHTML,{format:"WKT",zoomToFeatures:true,from:extentMap.wgsProj,to:extentMap.mainProj})}if(extentMap.watchedBbox!=""){extentMap.watchRadios(extentMap.watchedBbox,extentMap.eltRef);extentMap.watchBbox(extentMap.vectorLayer,extentMap.watchedBbox,extentMap.eltRef,extentMap.map)}}},convertToGml:function(a,b){var e=new OpenLayers.Projection(b);var c=(e==extentMap.wgsProj?new OpenLayers.Format.GML.v3():new OpenLayers.Format.GML.v3({externalProjection:e,internalProjection:extentMap.wgsProj}));var d=c.writeNode("feature:_geometry",a.geometry);return OpenLayers.Format.XML.prototype.write.call(c,d.firstChild)},createMap:function(){OpenLayers.ImgPath="../../scripts/openlayers/img/";extentMap.mainProj=new OpenLayers.Projection(mapOptions.projection);var a=mapOptions;a.theme=null;var e=extentMap.map=new OpenLayers.Map(a);if(!extentMap.edit){var d=e.getControlsByClass("OpenLayers.Control.Navigation")[0];d.disableZoomWheel();e.removeControl(e.getControlsByClass("OpenLayers.Control.PanZoom")[0])}e.addControl(new OpenLayers.Control.MousePosition());for(var c=0;c<backgroundLayers.length;c++){var b=new OpenLayers.Layer.WMS(backgroundLayers[c][0],backgroundLayers[c][1],backgroundLayers[c][2],backgroundLayers[c][3]);e.addLayer(b)}extentMap.vectorLayer=new OpenLayers.Layer.Vector("VectorLayer",{});e.addLayer(extentMap.vectorLayer);extentMap.vectorLayer.events.on({sketchstarted:function(){this.destroyFeatures()},scope:extentMap.vectorLayer});e.zoomToMaxExtent();return e},watchBbox:function(d,c,e,f){var a=c.split(",");for(var b=0;b<a.length;++b){Ext.get(a[b]).on("change",function(){extentMap.updateBbox(f,c,e,false)});Ext.get("_"+a[b]).on("change",function(){extentMap.updateBbox(f,c,e,true)})}},updateBbox:function(c,g,l,f){var e=c.getLayersByName("VectorLayer")[0];var a;var h;var b=g.split(",");if(f){var m=new Array(b.length);m[0]=Ext.get("_"+b[0]).getValue();m[1]=Ext.get("_"+b[1]).getValue();m[2]=Ext.get("_"+b[2]).getValue();m[3]=Ext.get("_"+b[3]).getValue();a=OpenLayers.Bounds.fromArray(m);h=a.clone();h=a.clone();if(extentMap.mainProj!=extentMap.wgsProj){h.transform(extentMap.mainProj,wgsProj)}}else{var m=new Array(b.length);m[0]=Ext.get(b[0]).getValue();m[1]=Ext.get(b[1]).getValue();m[2]=Ext.get(b[2]).getValue();m[3]=Ext.get(b[3]).getValue();a=OpenLayers.Bounds.fromArray(m);var k=null;var d=document.getElementsByName("proj_"+l);for(i=0;i<d.length;i++){if(d[i].checked==true){k=d[i].value}}var j=new OpenLayers.Projection(k);h=a.clone();if(j!=extentMap.wgsProj){h.transform(j,extentMap.wgsProj)}a.transform(j,extentMap.mainProj)}Ext.get("_"+b[0]).dom.value=h.left;Ext.get("_"+b[1]).dom.value=h.bottom;Ext.get("_"+b[2]).dom.value=h.right;Ext.get("_"+b[3]).dom.value=h.top;Ext.get(b[0]).dom.onkeyup();Ext.get(b[1]).dom.onkeyup();Ext.get(b[2]).dom.onkeyup();Ext.get(b[3]).dom.onkeyup();var n=new OpenLayers.Feature.Vector(a.toGeometry());e.destroyFeatures();e.addFeatures(n);extentMap.zoomToFeatures(c,e);extentMap.watchRadios(g,l)},updateBboxForRegion:function(h,b,f){var e=h.getLayersByName("VectorLayer")[0];var g;var a=b.split(",");var c=new Array(a.length);c[0]=Ext.get("_"+a[0]).getValue();c[1]=Ext.get("_"+a[1]).getValue();c[2]=Ext.get("_"+a[2]).getValue();c[3]=Ext.get("_"+a[3]).getValue();g=OpenLayers.Bounds.fromArray(c);g.transform(extentMap.wgsProj,extentMap.mainProj);Ext.get(a[0]).dom.onkeyup();Ext.get(a[1]).dom.onkeyup();Ext.get(a[2]).dom.onkeyup();Ext.get(a[3]).dom.onkeyup();var d=new OpenLayers.Feature.Vector(g.toGeometry());e.destroyFeatures();e.addFeatures(d);extentMap.zoomToFeatures(h,e);extentMap.watchRadios(b,f)},watchRadios:function(a,b){function c(g,p,j){var h=g.split(",");var v=Ext.get("_"+h[0]).getValue();var y=Ext.get("_"+h[1]).getValue();var o=Ext.get("_"+h[2]).getValue();var k=Ext.get("_"+h[3]).getValue();var m=v!=""?v:"0";var q=y!=""?y:"0";var f=o!=""?o:"0";var x=k!=""?k:"0";var d=OpenLayers.Bounds.fromString(m+","+q+","+f+","+x);var u=new OpenLayers.Projection("EPSG:4326");d.transform(u,p);if(v!=""){v=d.left.toFixed(j)+""}Ext.get(h[0]).dom.value=v;if(y!=""){y=d.bottom.toFixed(j)+""}Ext.get(h[1]).dom.value=y;if(o!=""){o=d.right.toFixed(j)+""}Ext.get(h[2]).dom.value=o;if(k!=""){k=d.top.toFixed(j)+""}Ext.get(h[3]).dom.value=k}$$("input.proj").each(function(d){if(d.id.indexOf(b)!=-1){if(d.checked){c(a,new OpenLayers.Projection(d.value),extentMap.digits)}Ext.get(d.id).on("click",function(){c(a,new OpenLayers.Projection(d.value),extentMap.digits)})}})},writeFeature:function(a){var d="WKT";var f,e;if(a!=null){d=a.format||"WKT";f=a.from;e=a.to}var c=new OpenLayers.Format[d]();if(f!=null&&e!=null){c.internalProjection=f;c.externalProjection=e}if(!this.vectorLayer.features.length){return null}var b=this.vectorLayer.features[this.vectorLayer.features.length-1];return c.write(b)},readFeature:function(c,b){if(c==""){return false}var e="WKT";var g,f;if(b!=null){e=b.format||"WKT";g=b.from;f=b.to}var a=new OpenLayers.Format[e]();if(g!=null&&f!=null){a.externalProjection=g;a.internalProjection=f}c=c.replace(/\n/g,"");var d=a.read(c);if(!d){return false}if(d.length){d=d[0]}this.vectorLayer.addFeatures(d);if(b.zoomToFeatures){this.zoomToFeatures(this.map,this.vectorLayer)}return true},zoomToFeatures:function(e,b){var d=b.getDataExtent();if(d&&!isNaN(d.left)){var c=d.getWidth()/2;var a=d.getHeight()/2;d.left-=c;d.right+=c;d.bottom-=a;d.top+=a;e.zoomToExtent(d)}else{e.zoomToMaxExtent()}}};extentMap.prev_geometry=OpenLayers.Format.GML.Base.prototype.writers.feature._geometry;OpenLayers.Format.GML.Base.prototype.writers.feature._geometry=function(c){if(c.CLASS_NAME=="extentMap.MultiPolygonReference"){var b=this.createElementNS(this.namespaces.gml,"gml:MultiPolygon");var a=this.createElementNS(this.namespaces.gml,"gml:MultiPolygon");a.setAttribute("gml:id",c.id);b.appendChild(a);return b}else{return extentMap.prev_geometry.apply(this,arguments)}};